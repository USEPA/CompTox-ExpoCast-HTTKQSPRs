---
title: "TKQSPRs-8-FinalFigure"
author: "Gilberto Padilla Mercado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages}
library(httk)
library(ggplot2)
library(magrittr)
library(scales)
library(knitr)
library(viridis)
library(cowplot)
```
Load custom code 
```{r load_code, eval = TRUE}
source("tkstats.R")
reset_httk()
```
```{r sanity_test}
humres <- calc_tkstats(dtxsid="DTXSID8023719",species="human",
                       parameterize.args.list = list(restrictive.clearance=TRUE))
humnonres <- calc_tkstats(dtxsid="DTXSID8023719",species="human",
                          parameterize.args.list = list(restrictive.clearance=FALSE))
ratres <- calc_tkstats(dtxsid="DTXSID8023719",species="rat",
                       parameterize.args.list = list(restrictive.clearance=TRUE))
ratnonres <- calc_tkstats(dtxsid="DTXSID8023719",species="rat",
                          parameterize.args.list = list(restrictive.clearance=FALSE))
humres$AUC/ratres$AUC
humnonres$AUC/ratnonres$AUC
humres$AUC/humnonres$AUC
ratres$AUC/ratnonres$AUC
```

## Purpose

The goal of this final panel is to visualize and explore the concordance of 
rat and human TK parameters. In panel A I will look at fraction unbound in plasma,
panel B will explore intrinsic clearance. Because some of these chemicals have
multiple values associated with fraction unbound or intrinsic clearance, I
take the median values in those cases. I use median values instead of average
because it represents a real measured value and a central tendency statistic.

```{r Fup_analysis, eval=TRUE}
common_chems <- intersect(
  get_cheminfo(model = "pbtk", species = "human", info = "DTXSID"),
  get_cheminfo(model = "pbtk", species = "rat", info = "DTXSID")
  )

cat(paste(length(common_chems),"chemicals with complete in vitro rat and human HTTK data\n"))

chem_properties <- merge(
      subset(get_cheminfo(model="pbtk",species="human",info="all",median.only = TRUE),
             DTXSID %in% common_chems),
      subset(get_cheminfo(model="pbtk",species="rat",info="all",median.only=TRUE),
             DTXSID %in% common_chems))

# Identify discordant Clints
chem_properties_clintnonzero <- subset(chem_properties, 
                                    (Human.Clint != 0 & Rat.Clint != 0))
chem_properties_clintprob <- subset(chem_properties, 
                                    (Human.Clint == 0 & Rat.Clint != 0) |
                                    (Human.Clint != 0 & Rat.Clint == 0))
#Save all common chems:
common_chems_all <- common_chems

cat(paste(dim(chem_properties_clintprob)[1], 
          "(",
          signif(dim(chem_properties_clintprob)[1]/dim(chem_properties)[1]*100,1),
          "percent) chemicals have discordant Clint assays\n"))

chem_properties %>%
  dplyr::group_by(DTXSID) %>%
  dplyr::summarize(hfup = median(Human.Funbound.plasma),
                   rfup = median(Rat.Funbound.plasma)) -> tidy_summary

tidy_summary %>%
  dplyr::mutate(SE = (hfup - rfup)^2) %>% 
  dplyr::ungroup() %>% dplyr::pull(SE) %>%
  {sqrt(sum(.)/length(.))} -> fup_rmse
```

```{r make_fupplot}
plotA <- ggplot(tidy_summary,
                aes(x = hfup, y = rfup)) +
  geom_point() +
  geom_abline() +
  annotate(label = paste0("RMSE\n = ", signif(fup_rmse, 2)),
           geom = "text",
           x = 5*10^-3/3, y = 0.85/5,
    size = 6
  ) +
  ylab(expression(paste("Rat ",
                        f[up]))) +
  xlab(expression(paste("Human ",
                        f[up]))) +
  scale_x_log10(label=scientific_10,limits=c(5*10^-4,1)) +
  scale_y_log10(label=scientific_10,limits=c(5*10^-4,1)) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))

plotA
```

```{r clint_analysis}

# Do the same thing with Clint
chem_properties_clintnonzero  %>%
  dplyr::group_by(DTXSID) %>%
  dplyr::summarize(hclint = median(Human.Clint),
                   rclint = median(Rat.Clint)) -> tidy_summary

tidy_summary %>%
  dplyr::mutate(SLE = (log10(hclint) - log10(rclint))^2) %>% 
  dplyr::ungroup() %>% dplyr::pull(SLE) %>%
  {sqrt(sum(.)/length(.))} -> clint_rmsle
```

```{r make_clint_plot}
plotB <- ggplot(tidy_summary, 
                aes(x = 10^-3 + hclint, y = 10^-3 + rclint)) +
  geom_point() +
  geom_abline() +
  annotate(label = paste0("RMSLE\n = ", signif(clint_rmsle, 2)),
           geom = "text",
           x = 50*1e-2, y = 1000/5,
    size = 6
  ) +
  ylab(expression(paste("Rat ",
                        Cl[int],
                        " (",
                        mu,
                        "L/min/10"^6,
                        " hep.)"))) +
  xlab(expression(paste("Human ",
                        Cl[int],
                        " (",
                        mu,
                        "L/min/10"^6,
                        " hep.)"))) +
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))

plotB
```
```{r make_twopanelplot}
# This is the combined plot for the top panels
# Note that this requires the package cowplot
# require(cowplot)
cowplot::plot_grid(plotlist = list(plotA, plotB), labels = c("A", "B"))
ggsave(filename = "figs/SupFig-human_rat_httk_params.png",
       height = 5,
       width = 7)
```

Next we want to test the differences in Css and Cmax when we substitute human
in vitro values for Clint and Fup.

```{r rat_measurements_restrictive, eval=TRUE}
# Eliminate discordant chemicals:
common_chems <- common_chems[!(common_chems %in% chem_properties_clintprob$DTXSID)]

rat_df <- data.frame(DTXSID = common_chems) 
rat_df <- subset(rat_df, DTXSID %in% get_cheminfo(info="dtxsid", model="pbtk"))

rat.stats <- sapply(rat_df$DTXSID, 
                    function(x) suppressWarnings(calc_tkstats(
                      dtxsid = x, 
                      model = "pbtk", 
                      suppress.messages = TRUE,
                      species = "rat")))
rat_df <- rat_df %>%
  dplyr::rowwise() %>%
  dplyr::mutate(Rat_Css = suppressWarnings(
    calc_analytic_css(dtxsid = DTXSID,
                      model = "pbtk", suppress.messages = TRUE,
                      species = "rat")),
    Rat_AUC = unlist(rat.stats["AUC", DTXSID]),
    Rat_Cmax = unlist(rat.stats["peak", DTXSID]))
```

```{r human_measurements_restrictive, eval=TRUE}
chem.physical_and_invitro.data <- chem.physical_and_invitro.data %>%
  dplyr::mutate(Rat.Clint = NA, Rat.Funbound.plasma = NA)
# Run reset_httk() if I've run this and I need to go back to the original data

hum.stats <- sapply(rat_df$DTXSID, 
                    function(x) suppressWarnings(calc_tkstats(
                      dtxsid = x, 
                      model = "pbtk", 
                      suppress.messages = TRUE,
                      species = "rat",
                      parameterize.args.list = list(default.to.human = TRUE))))
rat_df <- subset(rat_df, DTXSID %in% get_cheminfo(info="dtxsid", model="pbtk"))
rat_df <- rat_df %>%
  dplyr::rowwise() %>%
  dplyr::mutate(RatHum_Css = try(suppressWarnings(
    calc_analytic_css(dtxsid = DTXSID,
                      model = "pbtk", 
                      suppress.messages = TRUE,
                      species = "rat",
                      default.to.human = TRUE))),
    RatHum_AUC = unlist(hum.stats["AUC", DTXSID]),
    RatHum_Cmax = unlist(hum.stats["peak", DTXSID]))
```

# Repeat for non-restrictive:
```{r rat_measurements_nonrestrictive, eval=TRUE}
reset_httk()
rat.stats.nr <- sapply(rat_df$DTXSID, 
                    function(x) suppressWarnings(calc_tkstats(
                      dtxsid = x, 
                      model = "pbtk", 
                      suppress.messages = TRUE,
                      parameterize.args.list = list(restrictive.clearance=FALSE),
                      species = "rat")))
rat_df <- rat_df %>%
  dplyr::rowwise() %>%
  dplyr::mutate(Rat_Css_NR = suppressWarnings(
    calc_analytic_css(dtxsid = DTXSID,
                      model = "pbtk", 
                      suppress.messages = TRUE,
                      parameterize.args.list = list(restrictive.clearance=FALSE),
                      species = "rat")),
    Rat_AUC_NR = unlist(rat.stats.nr["AUC", DTXSID]),
    Rat_Cmax_NR = unlist(rat.stats.nr["peak", DTXSID]))
```

```{r human_measurements_nonrestrictive, eval=TRUE}
chem.physical_and_invitro.data <- chem.physical_and_invitro.data %>%
  dplyr::mutate(Rat.Clint = NA, Rat.Funbound.plasma = NA)
# Run reset_httk() if I've run this and I need to go back to the original data

hum.stats.nr <- sapply(rat_df$DTXSID, 
                    function(x) suppressWarnings(calc_tkstats(
                      dtxsid = x, 
                      model = "pbtk", 
                      suppress.messages = TRUE,
                      species = "rat",
                      parameterize.args.list = list(restrictive.clearance=FALSE,
                        default.to.human = TRUE))))
rat_df <- subset(rat_df, DTXSID %in% get_cheminfo(info="dtxsid", model="pbtk"))
rat_df <- rat_df %>%
  dplyr::rowwise() %>%
  dplyr::mutate(RatHum_Css_NR = try(suppressWarnings(
    calc_analytic_css(dtxsid = DTXSID,
                      model = "pbtk", suppress.messages = TRUE,
                      species = "rat",
                      parameterize.args.list = list(restrictive.clearance=FALSE,
                                               default.to.human = TRUE)))),
    RatHum_AUC_NR = unlist(hum.stats.nr["AUC", DTXSID]),
    RatHum_Cmax_NR = unlist(hum.stats.nr["peak", DTXSID]))
```

# Calculate stats for rat vs. human
```{r calc_rat_human_stats, eval=TRUE}
test.chems.dashboard <- read.csv("CvTdb/TestChemsDashboardInfo.csv")
rat_df$CvT <- "No"
rat_df[rat_df$DTXSID %in% test.chems.dashboard$DTXSID, "CvT"] <- "Yes"
rathum.table <- data.frame()
rathum.table["Restrictive","Css"] <- calc_RMSLE(
  rat_df,
  pred.col = "RatHum_Css",
  obs.col="Rat_Css")
rathum.table["Restrictive","Cmax"] <- calc_RMSLE(rat_df,
                               pred.col = "RatHum_Cmax",
                               obs.col="Rat_Cmax")
rathum.table["Restrictive","AUC"] <- calc_RMSLE(rat_df,
                               pred.col = "RatHum_AUC",
                               obs.col="Rat_AUC")
rathum.table["Non-Restrictive","Css"] <- calc_RMSLE(rat_df,
                               pred.col = "RatHum_Css_NR",
                               obs.col="Rat_Css_NR")
rathum.table["Non-Restrictive","Cmax"] <- calc_RMSLE(rat_df,
                               pred.col = "RatHum_Cmax_NR",
                               obs.col="Rat_Cmax_NR")
rathum.table["Non-Restrictive","AUC"] <- calc_RMSLE(rat_df,
                               pred.col = "RatHum_AUC_NR",
                               obs.col="Rat_AUC_NR")
#rathum.table["RPow10",] <- signif(10^rathum.table["Restrictive",],3)
#rathum.table["NRPow10",] <- signif(10^rathum.table["Non-Restrictive",],3)
rathum.table["Restrictive CvT","Css"] <- calc_RMSLE(
  subset(rat_df, DTXSID %in% test.chems.dashboard$DTXSID),
  pred.col = "RatHum_Css",
  obs.col="Rat_Css")
rathum.table["Restrictive CvT","Cmax"] <- calc_RMSLE(
  subset(rat_df, DTXSID %in% test.chems.dashboard$DTXSID),
                               pred.col = "RatHum_Cmax",
                               obs.col="Rat_Cmax")
rathum.table["Restrictive CvT","AUC"] <- calc_RMSLE(
  subset(rat_df, DTXSID %in% test.chems.dashboard$DTXSID),
                               pred.col = "RatHum_AUC",
                               obs.col="Rat_AUC")
rathum.table["Non-Restrictive CvT","Css"] <- calc_RMSLE(
  subset(rat_df, DTXSID %in% test.chems.dashboard$DTXSID),
  pred.col = "RatHum_Css_NR",
  obs.col="Rat_Css_NR")
rathum.table["Non-Restrictive CvT","Cmax"] <- calc_RMSLE(
  subset(rat_df, DTXSID %in% test.chems.dashboard$DTXSID),
                               pred.col = "RatHum_Cmax_NR",
                               obs.col="Rat_Cmax_NR")
rathum.table["Non-Restrictive CvT","AUC"] <- calc_RMSLE(
  subset(rat_df, DTXSID %in% test.chems.dashboard$DTXSID),
                               pred.col = "RatHum_AUC_NR",
                               obs.col="Rat_AUC_NR")
rathum.table <- signif(rathum.table,2)
write.csv(rathum.table, file="tables/SupTable-RatHumanError.txt")
kable(rathum.table)
```


```{r make_css_plot}
plotCss <- ggplot(rat_df, aes(y = 10^-3 + Rat_Css, 
                              x = 10^-3 + RatHum_Css)) +
  geom_point(aes(shape=CvT,color=CvT),size=2) +
  geom_abline() +
  annotate(
    label = paste0("RMSLE\n = ", 
                   signif(rathum.table["Restrictive","Css"], 2)),
    geom = "text",
    x = 50*1e-3/3,
    y = 100/7,
    size = 6
  ) +
  ylab(expression(paste("Rat ",C[ss]," (mg/L)"))) +
  xlab(expression(paste("Rat ",
                        C[ss],
                        " (mg/L) from Human "))) +
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10) +
  scale_color_viridis(discrete = TRUE) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))

plotCss
```

```{r make_cmax_plot}
plotCmax <- ggplot(rat_df, aes(y = 10^-3 + Rat_Cmax, 
                               x = 10^-3 + RatHum_Cmax)) +
  geom_point(aes(shape=CvT,color=CvT),size=2) +
  geom_abline() +
  annotate(
    label = paste0("RMSLE\n = ", 
                   signif(rathum.table["Restrictive","Cmax"], 2)),
    geom = "text",
    x = 50*1e-3/1,
    y = 10/2,
    size = 6
  ) +
  ylab(expression(paste("Rat ",C[max]," (mg/L)"))) +
  xlab(expression(paste("Rat ",
                        C[max],
                        " (mg/L) from Human "))) +
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10) +
  scale_color_viridis(discrete = TRUE) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))


plotCmax
```

```{r make_auc_plot}
plotAUC <- ggplot(rat_df, aes(y = 10^-3 + Rat_AUC, 
                              x = 10^-3 + RatHum_AUC)) +
  geom_point(aes(shape=CvT,color=CvT),size=2) +
  geom_abline() +
  annotate(
    label = paste0("RMSLE\n = ", 
                   signif(rathum.table["Restrictive","AUC"], 2)),
    geom = "text",
    x = 10*1e-1/3,
    y = 100,
    size = 6
  ) +
  ylab(expression(paste("Rat AUC (mg/L*Day)"))) +
  xlab(expression(paste("Rat AUC (mg/L*Day) from Human "))) +
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10) +
  scale_color_viridis(discrete = TRUE) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))

plotAUC
```

```{r make_multipanelplot}
pcol <- cowplot::plot_grid(
  plotlist = list(plotCss  + theme(legend.position="none"), 
                  plotCmax + theme(legend.position="none"), 
                  plotAUC + theme(legend.position="none")),
  labels = c("A", "B", "C"),
  ncol=1
)

legend <- get_legend(
  # create some space to the left of the legend
  plotCss + theme(legend.box.margin = margin(0, 0, 0, 12))
)

plot_grid(pcol, legend, rel_widths = c(3, .8))

ggsave(filename = "figs/Fig2-human_rat_eval.png",
       height = 12,
       width = 5)

```
```{r save_interspecies}
save(common_chems,
     common_chems_all,
     rathum.table,
     file="data/interspecies.RData")
write.csv(rathum.table,
          file="tables/SupTable-Interspecies.txt")
```
```{r textforpaper}
paste("There were",
      length(unique(rat_df$DTXSID)),
      "chemicals with in vitro measured fup and Clint for both human and rat. ")
paste("Based upon a separate analysis of",
      length(unique(rat_df$DTXSID)),
      "chemicals with in vitro measured fup and Clint for both human and rat,",
      "we estimate that interspecies differences inflate the RMSLE for Cmax by",
      signif(rathum.table["Non-Restrictive","Cmax"], 2),
      ", for Css by",
      signif(rathum.table["Non-Restrictive","Css"], 2),
      ", and AUC by",
      signif(rathum.table["Non-Restrictive","AUC"], 2)
      )
```