---
title: "HTTK QSPRs: Loading Data Files"
author: "John Wambaugh and Nisha Sipes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QSPR Bakeoff}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir= "C:/Users/jwambaug/git/CompTox-ExpoCast-HTTKQSPRs/")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

First we clear the memory to make sure there are no holdovers from previous R runs
```{r clear_mermor, eval=TRUE}
rm(list=ls()) 
```

To use the code in this vignette, you'll first need to load a few packages (if you haven't already).
```{r load_packages, eval = TRUE}
library(readxl)
library(ggplot2)
library(httk)
library(scales)
library(gplots)
library(RColorBrewer)
library(DescTools)
library(gridExtra)
library(reshape2)
```

```{r httk_version}
cat(paste("Using httk v",
          packageVersion("httk"),
          "\n"))
pkasource <- sort(unique(c(
  chem.physical_and_invitro.data$pKa_Accept.Reference,
  chem.physical_and_invitro.data$pKa_Donor.Reference)))
pkasource <- pkasource[!is.na(pkasource)]
cat(paste("pkA's taken from:",
          paste(pkasource, collapse=", "),
          "\n"))
```

# Load custom code 
```{r load_code, eval = TRUE}
source("clear_httk.R")
source("tkstats.R")
```

# Keep table numbering straight:
```{r load_code, eval = TRUE}
PREV.TABLES <- 0
PREV.SUP.TABLES <- 0
```

# Set the time stamp:
```{r time_stamp, eval = TRUE}
# Time_Days stamp:
output.prefix <- "May2025"
```

Set restrictive vs. non-restrictive metabolic clearance:
```{r time_stamp, eval = TRUE}
RESTRICTIVE.CLEARANCE <- FALSE
```

# Load in vivo concentration vs. time data
```{r load_cvt_data, eval = TRUE}
test.chems.dashboard <- read.csv("CvTdb/TestChemsDashboardInfo.csv")
DASHBOARDCAS.COL <- "CASRN"
test.chems.dashboard[,"CAS"] <- test.chems.dashboard[, DASHBOARDCAS.COL]

CVTSPECIES.COL <- "species"
CVTMEDIA.COL <- "conc_medium_normalized"
CVTTIME.COL <- "time_hr"
CVTCONC.COL <- "invivPK_conc"
CVTDOSE.COL <- "invivPK_dose_level"
CVTROUTE.COL <- "administration_route_normalized"
CVTLOQ.COL <- "invivPK_loq"
CVTDTXSID.COL <- "analyzed_chem_dtxsid"
CVTCAS.COL <- "analyzed_chem_casrn"
CVTREFERENCE.COL <- "pmid"
CVTCOMPOUNDNAME.COL <- "PREFERRED_NAME"

series_res_set <- read.csv("CvTdb/CvTdb_selectData_2025May.csv")
series_res_set$Species <- series_res_set[,CVTSPECIES.COL]
series_res_set$Media <- series_res_set[,CVTMEDIA.COL]
series_res_set$Time_Days <- series_res_set[,CVTTIME.COL] / 24 # hours -> days
series_res_set$Conc_mgpL <- series_res_set[,CVTCONC.COL] # mg/L
series_res_set$Dose <- series_res_set[,CVTDOSE.COL] # mg/kg
series_res_set$Route <- series_res_set[,CVTROUTE.COL]
series_res_set$calc_loq <- series_res_set[,CVTLOQ.COL] # mg/L
series_res_set$DTXSID <- series_res_set[,CVTDTXSID.COL]

# selectData is already filtered, number of chemicals shouldn't change
series_res_set <- merge(
  series_res_set, test.chems.dashboard[c("DTXSID", "PREFERRED_NAME")],
  all.x = TRUE,
  by = "DTXSID"
  )

series_res_set$CAS <- series_res_set[,CVTCAS.COL]
series_res_set$Reference <- series_res_set[,CVTREFERENCE.COL]
series_res_set[is.na(series_res_set$Reference), "Reference"] <- "NTP"
series_res_set$Source <- series_res_set$Reference
cat("Number of rows of CvT data for DTXSID3032179:")
dim(subset(series_res_set, DTXSID == "DTXSID3032179"))

# Only want human and rat:
series_res_set <- subset(series_res_set,
                         tolower(series_res_set[,CVTSPECIES.COL]) %in% 
                           c("human","rat"))

# Other code looks for a column named "Compound":
series_res_set[,"Compound"] <- series_res_set[,CVTCOMPOUNDNAME.COL]
```
```{r add_missing_CAS, eval=TRUE}
subset(series_res_set,is.na(CAS))
# Needs its CAS:
series_res_set[series_res_set$DTXSID == "DTXSID6021117", "CAS"] <- "60-80-0"
# Sodium valproate is valproic acid:
series_res_set[series_res_set$DTXSID == "DTXSID5037072", "DTXSID"] <- "DTXSID6023733"
# Needs its CAS:
series_res_set[series_res_set$DTXSID == "DTXSID6023733", "CAS"] <- "99-66-1"
length(unique(series_res_set$DTXSID))==length(unique(series_res_set$CAS))
```

```{r baddose, eval=FALSE}
# Please double check!
# Looks like a problem with the extraction here:
# series_res_set <- subset(series_res_set, !(DTXSID %in% c("DTXSID3032179")))
```

```{r organize_eval_chems, eval = TRUE}
# A list of the chemicals in the evaluation:
# There are 101 chemicals with CvT data for which the collaborators have been asked
# to make predictions, only 81 have enough data
eval.cas <- unique(series_res_set$CAS)

message(
  sprintf("Number of unique CAS with CvT data: %d",
          length(eval.cas))
)

# We have both human and rat:
series_res_set$Species <- tolower(series_res_set$Species)
message(
  sprintf("Unique species: %s",
          paste(unique(series_res_set$Species), collapse = ", "))
)

# Although CvTdb has expanded, keep focus on human and rat:
series_res_set <- subset(series_res_set, tolower(Species) %in%
                           c("rat", "human"))
message(
  sprintf("Unique species (updated): %s",
          paste(unique(series_res_set$Species), collapse = ", "))
)

# We have both blood and plasma:
series_res_set$Media <- tolower(series_res_set$Media)

message(
  sprintf("Unique Media collected: %s",
          paste(unique(series_res_set$Media), collapse = ", "))
)


# Significant figures:
series_res_set$Time_Days <- suppressWarnings(signif(
  as.numeric(series_res_set$Time_Days),2))
series_res_set$Conc_mgpL <- suppressWarnings(signif(
  as.numeric(series_res_set$Conc_mgpL),4))

CvT.data <- series_res_set
CvT.chems <- unique(CvT.data$DTXSID)

message(
  sprintf("Number of unique DTXSIDs with CvT data: %d",
          length(CvT.chems))
)

CvT.data[,"Dose"] <- signif(as.numeric(CvT.data[,"Dose"]), 3)
CvT.data[,"Time_Days"] <- signif(as.numeric(CvT.data[,"Time_Days"]), 3)
CvT.data <- subset(CvT.data,Time_Days>0)
```

# Calculate a limit of quantification (90% of lowest observation)
```{r calc_loq, eval = TRUE}
cat("Number of rows of CvT data without a calculated LOQ:")
dim(subset(CvT.data,is.na(calc_loq)))[1]
no.loqs <- is.na(CvT.data$calc_loq)

cat("Assigning LOQs to each row...")
for (this.study in unique(CvT.data[no.loqs,"Source"]))
{
  this.subset1 <- subset(CvT.data,
                           no.loqs &
                           Source==this.study)
  for (this.chem in unique(this.subset1$DTXSID))
  {
    this.subset2 <- subset(this.subset1,
                           DTXSID==this.chem)
    for (this.media in unique(this.subset2$Media))
    {
      this.subset3 <- subset(this.subset2,Media==this.media & !is.na(Conc_mgpL))
      this.subset3 <- subset(this.subset3,Conc_mgpL>0)
      if (any(!is.na(this.subset3$calc_loq)))
      {
        this.loq <- min(this.subset3$calc_loq,na.rm=TRUE)
      } else {
        this.loq <- suppressWarnings(min(this.subset3$Conc_mgpL,na.rm=TRUE))
        this.loq <- this.loq*0.9
      }
      CvT.data[
        no.loqs &
        CvT.data$Source %in% this.study & 
        CvT.data$DTXSID %in% this.chem & 
        CvT.data$Media %in% this.media,
        "calc_loq"] <- this.loq
    }
  }
}

cat("Number of rows with no LOQ:")
dim(subset(CvT.data,is.na(calc_loq)))[1]
CvT.data <- subset(CvT.data,!is.infinite(calc_loq))
cat("Number of unique DTXSID's with CvT data:")
length(unique(CvT.data$DTXSID))

message(
  sprintf("Number of unique DTXSIDs in the test set with CvT data: %d",
          length(unique(
            intersect(test.chems.dashboard$DTXSID, CvT.data$DTXSID)
          ))
  )
)
```

# Write the CvT data:

```{r write_cvt_data, eval=TRUE}
CvT.data.all <- CvT.data
write.csv(CvT.data,
          row.names=FALSE,
          file=paste("tables/SupTable",
          PREV.SUP.TABLES+2,
          "-CvTData.txt", 
          sep=""))
```

# Load empirical fits to Cvt data:
```{r load_empirical_fits, eval = TRUE}
fittable <- as.data.frame(read_excel(
  "CvTdb/evalTKstats_bakeoff_2025May.xlsx",
  sheet=1))

KELIM.COL <- "kelim"
HALFLIFE.COL <- "halflife.tkstats"
MODEL.COL <- "model"
VDIST.COL <- "Vss.tkstats"
V1.COL <- "V1"  
K12.COL <- "k12"
K21.COL <- "k21"
KGUTABS.COL <- "kgutabs"
FGUTABS.COL <- "Fgutabs"
TIMEUNITS.COL <- "Time.Units"
DTXSID.COL <- "Chemical"
SIGFIGS <- 4

fittable[,"DTXSID"] <- fittable[,DTXSID.COL]
fittable[,"Model"] <- fittable[,MODEL.COL]
fittable[fittable$Model=="model_1comp","Model"] <- "1Comp"
fittable[fittable$Model=="model_2comp","Model"] <- "2Comp"
cat("Number of chemicals with fits:")
length(unique(fittable$DTXSID))

# Calculate halflife for one compartment:
#fittable[is.na(fittable$V1),"halflife"] <- signif(log(2)/
#  fittable[is.na(fittable$V1),"kelim"],3)

# Calculate halflife for two compartment:
#fittable[!is.na(fittable$V1),"alphaplusbeta"] <- 
#  fittable[!is.na(fittable$V1),"kelim"] +
#  fittable[!is.na(fittable$V1),"k12"] + 
#  fittable[!is.na(fittable$V1),"k21"]
#fittable[!is.na(fittable$V1),"alphatimesbeta"] <- 
#  fittable[!is.na(fittable$V1),"kelim"] * 
#  fittable[!is.na(fittable$V1),"k21"]
#fittable$beta <- 
#  (fittable$alphaplusbeta - sqrt(fittable$alphaplusbeta^2 -
#                                   4*fittable$alphatimesbeta)) / 2 
#fittable[!is.na(fittable$V1),"halflife"] <- signif(log(2)/
#  fittable[!is.na(fittable$V1),"beta"],3)

# Calculate Vdist for two-compartment model:
#fittable[!is.na(fittable$V1),"Vdist"] <-
#  fittable[!is.na(fittable$V1),"Vdist"] * (1 + 
#  fittable[!is.na(fittable$V1),"k12"] /
#  fittable[!is.na(fittable$V1),"k21"])

fittable[,"Vdist"] <- signif(as.numeric(fittable[,VDIST.COL]), SIGFIGS)  

# Although CvTdb has expanded, keep focus on human and rat:
cat("Limit fits to just rat and human...\n")
fittable <- subset(fittable, tolower(Species) %in%
                           c("rat", "human"))
cat("Unique species with good fits:")
unique(fittable$Species)

for (this.chem in unique(fittable$DTXSID))
  for (this.species in unique(fittable$Species))
  {
    this.subset <- subset(CvT.data, 
                          DTXSID %in% this.chem &
                          Species %in% this.species)
    these.refs <- paste(unique(sort(this.subset$Reference)),
                        collapse=", ")
    fittable[fittable$DTXSID %in% this.chem &
                     fittable$Species %in% this.species,
                   "Reference"] <- these.refs
  }

for (this.col in c(K12.COL, K21.COL, KELIM.COL, KGUTABS.COL))
{
  fittable[,this.col] <- signif(as.numeric(fittable[,this.col])*24, SIGFIGS) # 1/day
}
fittable[,HALFLIFE.COL] <- signif(as.numeric(fittable[,HALFLIFE.COL])/24, SIGFIGS) # day
fittable[,TIMEUNITS.COL] <- "days"
fittable[,"halflife"] <- fittable[,HALFLIFE.COL]
fittable[,"kelim"] <- fittable[,KELIM.COL]
fittable[,"V1"] <- fittable[,V1.COL]
fittable[,"k12"] <- fittable[,K12.COL]
fittable[,"k21"] <- fittable[,K21.COL]
fittable[,"Fgutabs"] <- fittable[,FGUTABS.COL]
fittable[,"kgutabs"] <- fittable[,KGUTABS.COL]

cat("Number of chemicals with rat or human fits:")
length(unique(fittable$DTXSID))
```
#How many chemicals have 1 or 2 compartment fits:
```{r count_empirical, eval = TRUE}
cat(paste(length(unique(fittable$DTXSID)),
                 "chemicals with empirical Cvt fits.\n"))

cat(paste(length((unique(CvT.data$DTXSID))),
          "chemicals with Cvt data.\n"))
nofit.table <- subset(CvT.data, !(DTXSID %in% fittable$DTXSID))[,c(
  CVTCOMPOUNDNAME.COL,
  CVTCAS.COL,                               
  CVTDTXSID.COL)]
nofit.table <- subset(nofit.table, !duplicated(nofit.table))
write.csv(nofit.table, 
          row.names=FALSE,
          file="tables/SupTable-CvTDatabutNoEmpiricalFitChems.txt")
```


# Set the signfifant digits to something reasonable:
```{r subset_cvt_data, eval = TRUE}
CvT.data$Conc_mgpL <- signif(CvT.data$Conc_mgpL,3)
CvT.data$Time_Days <- signif(CvT.data$Time_Days,3)
CvT.data$calc_loq <- signif(CvT.data$calc_loq,3)

#for (this.col in colnames(fittable)[c(6:15,18,20)])
#  fittable[,this.col] <- signif(fittable[,this.col], 3)
```

# Write out TK parameter estimates:
```{r load_physchem, eval = TRUE}
cat("Number of rows in fittable...")
dim(fittable)[1]
cat("Number of unique chemicals in fittable...")
length(unique(fittable$DTXSID))

cat("Merging fittable with chemical information from CCD...")
fittable <- merge(fittable,
                  test.chems.dashboard[,c("DTXSID","PREFERRED_NAME","CAS"
                                          )],
                  by="DTXSID",
                  all.x=TRUE)
cat("Number of rows in fittable...")
dim(fittable)[1]
fittable.all <- fittable
write.csv(fittable.all,
          file=paste("tables/SupTable",
          PREV.SUP.TABLES + 3,
          "-TKFits.txt",
          sep=""),
          row.names=FALSE)

fittable <- fittable[, c("DTXSID",
                         "PREFERRED_NAME",
                         "CAS",
                         "Model",
                         "Species",
                         "Reference",
                         "Vdist",
                         "halflife",
                         "kelim",
                         "V1",
                         "k12",
                         "k21",
                         "kgutabs",
                         "Fgutabs",
                          TIMEUNITS.COL
                          )]

cat("Removing duplicated rows from fittable...")
fittable <- subset(fittable, !duplicated(fittable))
              
cat("Number of rows in fittable:")
dim(fittable)[1]
cat("Number of unique chemicals in fittable:")
length(unique(fittable$DTXSID))
```
# Load phys-chem information:
```{r load_physchem, eval = TRUE}
CvT.chems <-read_excel("CvTdb/eval-chems3.xls")
for (this.col in 6:18) CvT.chems[,this.col] <- suppressWarnings(signif(
  as.numeric(unlist(CvT.chems[,this.col])),3))
CvT.chems <- CvT.chems[,c(
  "DTXSID",
  "PREFERRED_NAME",
  "CASRN",
  "AVERAGE_MASS",                                                    
  "BOILING_POINT_DEGC_OPERA_PRED",                                   
  "HENRYS_LAW_ATM-M3/MOLE_OPERA_PRED",
  "OCTANOL_AIR_PARTITION_COEFF_LOGKOA_OPERA_PRED",
  "OCTANOL_WATER_PARTITION_LOGP_OPERA_PRED",
  "MELTING_POINT_DEGC_OPERA_PRED",                                   
  "VAPOR_PRESSURE_MMHG_OPERA_PRED",
  "WATER_SOLUBILITY_MOL/L_OPERA_PRED"
  )]

```


# Throw out the CvT data for chemicals that could not be described by empirical PK models
```{r subset_cvt_data, eval = TRUE}
cat("Introduction\n")
cat(paste("In vivo plasma and blood concentration vs. time data for rat and human for",
  length(unique(CvT.data.all$DTXSID)),
  "chemicals from the CvTdb {Sayre, 2020} formed the basis of the dataset used\n"))
cat("\n")
cat("Methods: Initial Chemical List\n")
cat(paste("At the start of this project TK data were available for",
  length(unique(CvT.data.all$DTXSID)),
  "chemicals from EPA’s CvT database\n"))
cat("\n")
cat("Results: Evaluation Chemicals and Predictions\n")
cat(paste("There are",
  length(unique(CvT.data.all$DTXSID)),
  "chemicals present in the public release of CvTdb {Sayre, 2020} that had time course plasma concentration data following either oral or intravenous doses given to rats or humans.\n"))
cat("\n")
length(unique(fittable.all$DTXSID))
cat("Results: Evaluation Chemicals and Predictions\n")
cat(paste(
  length(unique(CvT.data.all$DTXSID)) - length(unique(fittable.all$DTXSID)),
  "chemical data sets were eliminated in pre-processing before fitting\n"))
cat("\n")
cat(paste("The eliminated chemicals were:",
          paste(unique(subset(CvT.data.all, !(DTXSID %in% fittable.all$DTXSID))$Compound),
                collapse=", "),
          "\n"))
cat("\n")

# Don't want data where the flat model wins:
fittable.noflat <- subset(fittable.all, !(Model%in% c("model_flat")))
cat(paste("There were",
            length(unique(fittable.all$DTXSID)) -
                     length(unique(fittable.noflat$DTXSID)),
            "chemicals with suitable data for modeling where we did not get an empirical fit (flat model selected).\n"))
cat("\n")
cat("Results: Evaluation chemicals and predictions\n")
cat(paste("Of the",
  length(unique(fittable$DTXSID)),
  "chemicals where empirical TK model parameters were estimated,",
  length(unique(fittable$DTXSID)) -
    length(unique(fittable.noflat$DTXSID)),
  "were best described by the “flat” model indicating that the data sets were too noisy to estimate empirical TK parameters:",
  paste(subset(fittable,!(DTXSID %in% fittable.noflat$DTXSID))$PREFERRED_NAME,collapse=", "),
  "\n"
  ))
cat("\n")

write.csv(subset(fittable, !(DTXSID%in%fittable.noflat$DTXSID))[,
          c("DTXSID","CAS","Model",
            #"AIC",
            "Species"#,
            #"method"
            )],
          row.names=FALSE,
          file="tables/SupTable-NoEmpiricalFitChems.txt")
fittable <- fittable.noflat

cat("Unique chemicals in fittable:")
length(unique(fittable$DTXSID))

# Count chemicals where we don't have a usable empirical fit (No Vdist or V1):
# essentially we only had oral data,
fittable.usable <- subset(fittable, 
                                 !is.na(Vdist) | !is.na(V1))

cat("Results: Evaluation Chemicals and Predictions\n")
cat(paste("There were",
            length(unique(fittable$DTXSID)) -
                     length(unique(fittable.usable$DTXSID)),
            "chemicals where we only had oral data (no empirical fit suitable for prediction).\n"))
cat("\n")
cat("Unique chemicals in fittable:")
length(unique(fittable$DTXSID))
cat("Unique chemicals in CvT.data.all:")
print(length(unique(CvT.data.all$DTXSID)))
cat("Subsetting CvT.data to only those chemicals with fits leaves:")
CvT.data <- subset(CvT.data.all, DTXSID %in% fittable$DTXSID)
print(length(unique(CvT.data$DTXSID)))

cat("Unique chemicals in CvT.chems object:")
print(length(unique(CvT.chems$DTXSID)))
cat("Subsetting CvT.chems to only those chemicals with fits leaves:")
CvT.chems<- subset(CvT.chems,DTXSID %in% fittable$DTXSID)
print(length(unique(CvT.chems$DTXSID)))
```



Create a default table of in vitro measured values:
```{r default_table, eval = TRUE}
reset_httk()
httk.data <- subset(chem.physical_and_invitro.data,DTXSID%in%CvT.chems$DTXSID)
httk.data <- httk.data[,c(
  "Compound",
  "DTXSID",
  "CAS",
  "Human.Clint",
  "Human.Clint.pValue",
  "Human.Funbound.plasma",
  "Rat.Clint",
  "Rat.Clint.pValue",
  "Rat.Funbound.plasma")]


# Set insignificant trends to zero:
httk.data[httk.data$Human.Clint.pvalue < 0.05,"Human.Clint"] <- 0
colnames(httk.data)  

# Use medians from distributions:
httk.data$Human.Clint <- unlist(lapply(strsplit(httk.data$Human.Clint,","),function(x) as.numeric(x[1])))

# Make sure everything is numeric:
httk.data$Human.Funbound.plasma <- 
  unlist(lapply(strsplit(httk.data$Human.Funbound.plasma,","),
  function(x) as.numeric(x[1])))

# Treat fup = 0 as non-measurement:
httk.data$Human.Funbound.plasma[httk.data$Human.Funbound.plasma == 0] <- NA
#httk.data$Human.Funbound.plasma[httk.data$Human.Funbound.plasma==0.005] <- NA

# Which chemicals would we normally use with HTTK PBTK:
httk.both <- httk.data[,"CAS"][(apply(httk.data,1,function(x) 
  !is.na(x["Human.Clint"]) & !is.na(x["Human.Funbound.plasma"])))]
```

Add HTTK measured data to CvT.chems table:
```{r default_table, eval = TRUE}
CvT.chems <- merge(CvT.chems,
  httk.data[,c("DTXSID","Human.Clint","Human.Funbound.plasma","Rat.Clint","Rat.Funbound.plasma")],
  all.x=TRUE,
  by="DTXSID")
colnames(CvT.chems)[colnames(CvT.chems)=="Human.Clint"] <- "Human.Clint.httk"
colnames(CvT.chems)[colnames(CvT.chems)=="Human.Funbound.plasma"] <- "Human.Fup.httk"
colnames(CvT.chems)[colnames(CvT.chems)=="Rat.Clint"] <- "Rat.Clint.httk"
colnames(CvT.chems)[colnames(CvT.chems)=="Rat.Funbound.plasma"] <- "Rat.Fup.httk"
```

Generate results for text:
```{r default_table, eval = TRUE}
median.clint <- median(CvT.chems$Human.Clint.httk,na.rm=TRUE)
twofold.clint <- CvT.chems$Human.Clint.httk[!is.na(CvT.chems$Human.Clint.httk)]
twofold.clint <- twofold.clint < 2*twofold.clint &
                 twofold.clint > 0.5*twofold.clint

cat("Discussion\n")
cat(paste("Among the evaluation chemicals only",
          sum(CvT.chems$Human.Clint.httk>100,na.rm=TRUE),
          "had metabolic clearance (Clint) above 103 µL/min/106 hepatocytes and",
          signif(sum(twofold.clint)/length(twofold.clint)*100,2),
          "percent were within two-fold of the median."))
cat("\n")
```
```{r slowfast_chems_test}
for (this.chem in CvT.chems$DTXSID)
  if (this.chem %in% get_cheminfo(info="dtxsid",
                                  species="rat",
                                  default.to.human=TRUE,
                                  model="3compartment",
                                  class.exclude = FALSE,
                                  suppress.messages=TRUE) &
      this.chem %in% subset(fittable, Species=="rat")$DTXSID)
  {
    this.index <- which(CvT.chems$DTXSID==this.chem)
    CvT.chems[this.index,"Thalf.httk"] <- calc_half_life(dtxsid=this.chem,
                                                    species="rat",
                                                    default.to.human = TRUE,
                                                    class.exclude = FALSE,
                                                    suppress.messages=TRUE,
                              restrictive.clearance=RESTRICTIVE.CLEARANCE)
    CvT.chems[this.index,"Thalf.fit"] <- fittable[fittable$DTXSID==this.chem,
                                                  "halflife.tkstats"][1]
  }

paste("The three chemicals with the shortest half-lives in rat were",
      paste(CvT.chems[order(CvT.chems$Thalf.fit)[1:3],]$PREFERRED_NAME,collapse=", "),
      "-- mean of",
      signif(mean(CvT.chems[order(CvT.chems$Thalf.fit)[1:3],"Thalf.fit"]),1),
      "hours.")
paste("The three chemicals with longest half-lives in rat were",
      paste(CvT.chems[order(CvT.chems$Thalf.fit,decreasing=TRUE)[1:3],]$PREFERRED_NAME,collapse=", "),
      "-- mean of",
      signif(mean(CvT.chems[order(CvT.chems$Thalf.fit,decreasing=TRUE)[1:3],"Thalf.fit"]),1),
      "hours.")

pharma <- read.csv("ccd_data/Chemical List ZINC15PHARMA-2024-09-09.csv")
paste(sum(CvT.chems$CASRN%in%pharma$CASRN),
      "of the chemicals with in vitro HTTK data and in vivo concentration vs. time data were pharmaceuticals.")


```

```{r describe_chemicals, eval=TRUE}
pharma <- read.csv("ccd_data/Chemical List ZINC15PHARMA-2024-09-09.csv")
pest.active<- read.csv("ccd_data/Chemical List EPAPCS-2024-12-09.csv")
PFAS <- read.csv("ccd_data/Chemical List PFAS8a7v3-2024-12-09.csv")
ToxCast <- read.csv("ccd_data/Chemical List ToxCast_invitroDB_v4_1-2024-12-09.csv")
TSCA <- read.csv("ccd_data/Chemical List TSCA_ACTIVE_NCTI_0224-2024-12-09.csv")
consumer <- read.csv("ccd_data/Chemical List EPACONS-2024-12-09.csv")

cat(paste("Among the",
          dim(CvT.chems)[1],
          "evaluation chemicals,",
          length(unique(subset(CvT.data, CAS %in% CvT.chems$CASRN & Species=="rat")$DTXSID)),
          "had data in rat and",
          length(unique(subset(CvT.data, CAS %in% CvT.chems$CASRN & Species=="human")$DTXSID)),
          "in human.\n"))

cat(paste("The",
          length(unique(CvT.chems$CASRN)),
          "chemicals included (according to lists accessed 12/9/24)",
          length(unique(subset(CvT.chems, CASRN %in% pharma$CASRN)$CASRN)),
          "pharmaceuticals.\n"))

cat(paste("Additionally, the evaluation chemicals included:",
            dim(subset(CvT.chems, CASRN %in% TSCA$CASRN))[1],
          "from the non-confidential Toxic Substances Control Act (TSCA) active inventory (https://comptox.epa.gov/dashboard/chemical-lists/TSCA_ACTIVE_NCTI_0224),",
            dim(subset(CvT.chems, CASRN %in% pest.active$CASRN))[1],
          "pesticide active ingredients (https://comptox.epa.gov/dashboard/chemical-lists/EPAPCS),",
          dim(subset(CvT.chems, CASRN %in% consumer$CASRN))[1],
          "that are found in consumer products (https://comptox.epa.gov/dashboard/chemical-lists/EPACONS),",
          dim(subset(CvT.chems, CASRN %in% PFAS$CASRN))[1],
          "per- and poly-fluoroalkyl substances (PFAS) (https://comptox.epa.gov/dashboard/chemical-lists/PFAS8a7v3), and",
          dim(subset(CvT.chems, CASRN %in% ToxCast$CASRN))[1],
          "that are part of the ToxCast screening program (https://comptox.epa.gov/dashboard/chemical-lists/ToxCast_invitroDB_v4_1).\n"))
      
load("data/interspecies.RData")
cat(paste(dim(subset(CvT.chems,DTXSID%in%common_chems_all))[1],
          "evaluation chemicals had both human and rat in vitro HTTK data\n"))
```
Add HTTK data measured in rat to CvT.chems table:
```{r rat_table, eval = TRUE}
CvT.chems <- merge(CvT.chems,
  httk.data[,c("DTXSID","Rat.Clint","Rat.Funbound.plasma")],
  all.x=TRUE,
  by="DTXSID")
```

```{r write_out_data, eval= TRUE}
cat(paste0("There are ",
           length(unique(CvT.chems$DTXSID)),
           " CvT evaluation chemicals.\n"))
cat(paste0("There are ",
           length(unique(fittable$DTXSID)),
           " chemicals with suitable evaluation data.\n"))
cat(paste0("There are ",
           length(unique(CvT.data$DTXSID)),
           " chemicals with CvT data.\n"))
cat(paste0("There are ",
           length(unique(subset(CvT.data,Species=="human")$DTXSID)),
           " chemicals with human CvT data.\n"))
cat(paste0("There are ",
           length(unique(subset(CvT.data,Species=="rat")$DTXSID)),
           " chemicals with rat CvT data.\n"))
invitro <- httk.data
save(invitro,file="data/httkinvitro.RData")
save(CvT.chems,file="data/Cvt-chems.RData")
save(CvT.data,file="data/Cvt-data.RData")
save(fittable,fittable.all,file="data/fittable.RData")
save(httk.both ,file="data/httk-goodchems.RData")
```
