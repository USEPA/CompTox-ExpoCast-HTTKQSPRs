---
title: "TK QSPRs: Level 1 Analysis"
author: "John Wambaugh and Nisha Sipes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QSPR Bakeoff}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir= "C:/Users/jwambaug/git/CompTox-ExpoCast-HTTKQSPRs/")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

First we clear the memory to make sure there are no holdovers from previous R runs
```{r clear_mermor, eval=TRUE}
rm(list=ls()) 
```

To use the code in this vignette, you'll first need to load a few packages (if you haven't already).
```{r load_packages, eval = TRUE}
library(readxl)
library(ggplot2)
library(httk)
library(scales)
library(gplots)
library(RColorBrewer)
library(DescTools)
library(gridExtra)
library(reshape2)
library(knitr)
```

Load custom code 
```{r load_code, eval = TRUE}
source("clear_httk.R")
source("tkstats.R")
```


Set the time stamp:
```{r time_stamp, eval = TRUE}
# Time stamp:
output.prefix <- "July2024"
```

```{r load_data, eval= TRUE}
load(file="data/httkinvitro.RData")
load(file="data/Cvt-chems.RData")
load(file="data/Cvt-data.RData")
```


#Level I Predictions -- in vitro TK parameters:

At level I we are comparing QSPR's with the in vitro measured values.
We don't have those values for all the chemicals, so we only are comparing on
a subset.

ADMET (Sipes et al., 2017)
Pradeep et al. (2020)
Dawson et al. (2021)
OPERA (in prep.)
IVBP (Chirico et al., 2021)

Get the in vitro measured values:
In Vitro Measured:
```{r text_for_manuscript, eval = TRUE}
cat(paste("Evaluation data for Clint for",
      sum(sapply(invitro$Human.Clint,function(x) !is.na(x))),
      "chemicals and fup for",
      sum(sapply(invitro$Human.Funbound.plasma,function(x) !is.na(x))),
      ".\n"
      ))
cat("\n")
reset_httk()
tot.zero <- sum(sapply(get_cheminfo(info="Clint",
                                    median.only = TRUE,
                                    suppress.messages = TRUE),
                       function(x) 0%in%x))
tot.clint <- sum(sapply(get_cheminfo(info="Clint",
                                     median.only = TRUE,
                                     suppress.messages=TRUE),
                        function(x) !is.na(x)))
cat("\n")
cat("Discussion\n")
cat(paste(sum(invitro$Human.Clint%in% 0),
          "out of",
          sum(!is.na(invitro$Human.Clint)),
          "chemicals with in vitro HTTK Clint measured data have no observed clearance (that is, they are metabolically stable) compared with",
          tot.zero,
          "out of",
          tot.clint,
          "measured Clint values (",
          signif(tot.zero/tot.clint*100,2),
          "percent) in the httk data set as whole.\n"
          ))
cat("\n")
```

ADMET Predictor:
```{r add_admet, eval = TRUE}
# Simulations Plus (Sipes 2017):
clear_httk()
suppressWarnings(load_sipes2017(overwrite=TRUE))
admet <- subset(get_cheminfo(info="all"),DTXSID %in% CvT.chems$DTXSID)
CvT.chems <- merge(CvT.chems,
  admet[,c("DTXSID","Human.Clint","Human.Funbound.plasma")],
  all.x=TRUE,
  by="DTXSID")
colnames(CvT.chems)[colnames(CvT.chems)=="Human.Clint"] <- "Human.Clint.ADMET"
colnames(CvT.chems)[colnames(CvT.chems)=="Human.Funbound.plasma"] <- "Human.Fup.ADMET"
```

Dawson 2021:
```{r add_dawson, eval = TRUE}
clear_httk()
load_dawson2021(overwrite=TRUE)
dawson <- subset(get_cheminfo(info="all"),DTXSID %in% CvT.chems$DTXSID)
CvT.chems <- merge(CvT.chems,
  dawson[,c("DTXSID","Human.Clint","Human.Funbound.plasma")],
  all.x=TRUE,
  by="DTXSID")
colnames(CvT.chems)[colnames(CvT.chems)=="Human.Clint"] <- "Human.Clint.Dawson"
colnames(CvT.chems)[colnames(CvT.chems)=="Human.Funbound.plasma"] <- 
  "Human.Fup.Dawson"
```

Pradeep 2020:
```{r add_pradeep, eval = TRUE}
clear_httk()
load_pradeep2020(overwrite=TRUE)
pradeep <- subset(get_cheminfo(info="all"),DTXSID %in% CvT.chems$DTXSID)
CvT.chems <- merge(CvT.chems,
  pradeep[,c("DTXSID","Human.Clint","Human.Funbound.plasma")],
  all.x=TRUE,
  by="DTXSID")
colnames(CvT.chems)[colnames(CvT.chems)=="Human.Clint"] <- "Human.Clint.Pradeep"
colnames(CvT.chems)[colnames(CvT.chems)=="Human.Funbound.plasma"] <- 
  "Human.Fup.Pradeep"
```

OPERA Predictor:
```{r add_opera, eval = TRUE}
opera <- read.csv("CvTdb/testchems-smi_OPERA2.7Pred.csv",stringsAsFactors=F)
colnames(opera)[colnames(opera)=="MoleculeID"] <- "DTXSID"
opera <- subset(opera,DTXSID%in%CvT.chems$DTXSID)
# Domain of applicability:
opera[opera$AD_FUB==0,"FUB_pred"] <- NA
opera[opera$AD_Clint==0,"Clint_pred"] <- NA

CvT.chems <- merge(CvT.chems,
  opera[,c("DTXSID","Clint_pred","FUB_pred")],
  all.x=TRUE,
  by="DTXSID")
colnames(CvT.chems)[colnames(CvT.chems)=="Clint_pred"] <- "Human.Clint.OPERA"
colnames(CvT.chems)[colnames(CvT.chems)=="FUB_pred"] <- "Human.Fup.OPERA"
```

IVBP Predictor:
```{r add_ivbp, eval = TRUE}
ivbp <- as.data.frame(read_excel("qsprs/BakeOff_IVBP_Suite.xlsx",sheet=2))
ivbp <- subset(ivbp,DTXSID%in%CvT.chems$DTXSID)
# Domain of applicability:
ivbp[tolower(ivbp[,"AD"])=="out ad","IVBP Final Pred Log Clint_mL/h/10^6 hep"] <- NA

# log to arithmetic:
ivbp[,"IVBP Final Pred Log Clint_mL/h/10^6 hep"] <- 
  10^as.numeric(ivbp[,"IVBP Final Pred Log Clint_mL/h/10^6 hep"])

# h to min:
ivbp[,"IVBP Final Pred Log Clint_mL/h/10^6 hep"] <- 
  ivbp[,"IVBP Final Pred Log Clint_mL/h/10^6 hep"]/60

# mL to uL:
ivbp[,"IVBP Final Pred Log Clint_mL/h/10^6 hep"] <- 
  ivbp[,"IVBP Final Pred Log Clint_mL/h/10^6 hep"] * 1000

CvT.chems <- merge(CvT.chems,
  ivbp[,c("DTXSID","IVBP Final Pred Log Clint_mL/h/10^6 hep")],
  all.x=TRUE,
  by="DTXSID")
colnames(CvT.chems)[colnames(CvT.chems)=="IVBP Final Pred Log Clint_mL/h/10^6 hep"] <- "Human.Clint.IVBP"
#colnames(CvT.chems)[colnames(CvT.chems)=="FUB_pred"] <- "Human.Fup.IVBP
```


Master Table:
```{r prediction_table, eval = TRUE}
for (this.col in 12:(dim(CvT.chems)[2])) 
{
  CvT.chems[,this.col] <- as.numeric(CvT.chems[,this.col])
}

sup.table <- CvT.chems
for (this.col in 1:dim(sup.table)[2])
  if (is.numeric(sup.table[1,this.col]))
    sup.table[,this.col] <- signif(sup.table[,this.col],3)
write.csv(sup.table, row.names=FALSE,file="tables/SupTable-QSPRPredsandInVitroData.txt")
```

Heatmap of the Data Set:
```{r make_heatmap, eval = TRUE}
  CvT.chems.scale <- CvT.chems
  colnames(CvT.chems.scale)[4] <- "Molecular Weight"
  colnames(CvT.chems.scale)[5] <- "Boiling Point"
  colnames(CvT.chems.scale)[6] <- "Henry's Law"
  colnames(CvT.chems.scale)[7] <- "Octanol:Air"
  colnames(CvT.chems.scale)[8] <- "Octanol:Water"
  colnames(CvT.chems.scale)[9] <- "Melting Point"
  colnames(CvT.chems.scale)[10] <- "Vapor Pressure"
  colnames(CvT.chems.scale)[11] <- "Water Solubility"
  rownames(CvT.chems.scale) <- CvT.chems.scale$PREFERRED_NAME 
# Make sure everything is numeric:
  for (this.col in 4:(dim(CvT.chems.scale)[2])) CvT.chems.scale[,this.col] <- 
    as.numeric(CvT.chems.scale[,this.col])
# Scale and center
  for (this.col in 4:11) CvT.chems.scale[,this.col] <- 
    (CvT.chems.scale[,this.col] - mean(CvT.chems.scale[,this.col],na.rm=TRUE)) / 
    sd(CvT.chems.scale[,this.col],na.rm=TRUE)
# scale and center all predictions by in vitro:
clint.mean <- mean(CvT.chems.scale[,12], na.rm=TRUE)
fup.mean <- mean(CvT.chems.scale[,13], na.rm=TRUE)
clint.sd <- sd(CvT.chems.scale[,12], na.rm=TRUE)
fup.sd <- sd(CvT.chems.scale[,13], na.rm=TRUE)
for (this.col in seq(12,22,2)) CvT.chems.scale[,this.col] <- 
    (CvT.chems.scale[,this.col] - clint.mean) / clint.sd
for (this.col in seq(13,21,2)) CvT.chems.scale[,this.col] <- 
    (CvT.chems.scale[,this.col] - fup.mean) / fup.sd

    mypalette<-brewer.pal(11,"RdYlBu")
  heatmap.2(as.matrix(CvT.chems.scale[,4:(dim(CvT.chems.scale)[2])]),
    lwid=c(0.4,1),
    lhei=c(0.4,1),
    margins=c(15,1),
    labRow = FALSE,
    cexCol=1,
    trace="none",
    col=mypalette)
  png(paste("figs/Fig2-physchemandpredictors-heatmap-",
           output.prefix,
           ".tiff",sep=""),
          width=800, height=750)
  heatmap.2(as.matrix(CvT.chems.scale[,4:(dim(CvT.chems.scale)[2])]),
    lwid=c(0.4,1),
    lhei=c(0.4,1),
    margins=c(15,1),
    labRow = FALSE,
    cexCol=1.5,
    trace="none",
 #   dendrogram = "none",
    col=mypalette)
  dev.off()
  
cat("Figure Caption\n")
cat("Each row corresponds to one of the",
    dim(CvT.chems.scale)[1],
    "chemicals.")
```

Divide into individual tables:
```{r divide_tables, eval = TRUE}
level1tab <- CvT.chems
colnames(level1tab)[colnames(level1tab) == "CASRN"] <- "CAS"

level1tab1 <- level1tab[,c(
  "DTXSID",
  "PREFERRED_NAME",
  "CAS",
  "Human.Clint.httk","Human.Fup.httk",
  "Human.Clint.ADMET","Human.Fup.ADMET")]
level1tab1$QSPR <- "ADMET"
colnames(level1tab1)[6:7] <- c("Human.Clint.pred","Human.Fup.pred") 

level1tab2 <- level1tab[,c(
  "DTXSID",
  "PREFERRED_NAME",
  "CAS",
  "Human.Clint.httk",
  "Human.Fup.httk",
  "Human.Clint.Dawson",
  "Human.Fup.Dawson")]
level1tab2$QSPR <- "Dawson"
colnames(level1tab2)[6:7] <- c("Human.Clint.pred","Human.Fup.pred")

level1tab3 <- level1tab[,c(
  "DTXSID",
  "PREFERRED_NAME",
  "CAS",
  "Human.Clint.httk",
  "Human.Fup.httk",
  "Human.Clint.Pradeep",
  "Human.Fup.Pradeep")]
level1tab3$QSPR <- "Pradeep"
colnames(level1tab3)[6:7] <- c("Human.Clint.pred","Human.Fup.pred")

level1tab4 <- level1tab[,c(
  "DTXSID",
  "PREFERRED_NAME",
  "CAS",
  "Human.Clint.httk",
  "Human.Fup.httk",
  "Human.Clint.OPERA",
  "Human.Fup.OPERA")]
level1tab4$QSPR <- "OPERA"
colnames(level1tab4)[6:7] <- c("Human.Clint.pred","Human.Fup.pred")

level1tab5 <- level1tab[,c(
  "DTXSID",
  "PREFERRED_NAME",
  "CAS",
  "Human.Clint.httk",
  "Human.Fup.httk",
  "Human.Clint.IVBP")]
# There are no Fup preds for IVBP:
level1tab5 <- cbind(level1tab5,NA)
level1tab5$QSPR <- "IVBP"
colnames(level1tab5)[6:7] <- c("Human.Clint.pred","Human.Fup.pred")


level1tab <- rbind(level1tab1,level1tab2,level1tab3,level1tab4,level1tab5)
level1tab$Human.Fup.pred <- as.numeric(level1tab$Human.Fup.pred)
level1tab$Human.Clint.pred <- as.numeric(level1tab$Human.Clint.pred)
```

## calculate fold error (FE) and absolute fold error (AbsFE)
```{r calc_Level1AbsFE, eval=TRUE}
MINVAL <- 1e-6
#Absolute fold error (AbsFE) : abs(log10(pred/obs))
level1tab$Human.Clint.AbsFE <- abs(log10((level1tab$Human.Clint.pred + MINVAL) /
  (level1tab$Human.Clint.httk + MINVAL)))
level1tab$Human.fup.AbsFE <- abs(log10((level1tab$Human.Fup.pred + MINVAL) /
  (level1tab$Human.Fup.httk + MINVAL)))

# Fo
level1tab$Human.Clint.FE<- log10((level1tab$Human.Clint.pred + MINVAL) /
  level1tab$Human.Clint.httk)
level1tab$Human.fup.FE<- log10((level1tab$Human.Fup.pred + MINVAL) /
  level1tab$Human.Fup.httk)

for (this.row in 1:dim(level1tab)[1])
{
  this.Clint.AbsFE <- level1tab[this.row,"Human.Clint.AbsFE"]
  if (!is.na(this.Clint.AbsFE))
  {
    if (!is.finite(this.Clint.AbsFE)) 
    {
#Turn -Inf and Inf into NA
      level1tab[this.row,"Human.Clint.AbsFE"] <- NA
      level1tab[this.row,"Human.Clint.FE"] <- NA
    }
    if (is.nan(this.Clint.AbsFE)) 
    {
#Turn NaN into 0 , because the NaN is a result of matching 0/0...and hence it was correctly identified.
      level1tab[this.row,"Human.Clint.AbsFE"] <- 0
      level1tab[this.row,"Human.Clint.FE"] <- 0
    }
  }
  this.fup.AbsFE <- level1tab[this.row,"Human.fup.AbsFE"]
  if (!is.na(this.fup.AbsFE))
  {
    if (!is.finite(this.fup.AbsFE)) 
    {
#Turn -Inf and Inf into NA
      level1tab[this.row,"Human.fup.AbsFE"] <- NA
      level1tab[this.row,"Human.fup.FE"] <- NA
    }
    if (is.nan(this.fup.AbsFE)) 
    {
#Turn NaN into 0 , because the NaN is a result of matching 0/0...and hence it was correctly identified.
      level1tab[this.row,"Human.fup.AbsFE"] <- 0
      level1tab[this.row,"Human.fup.FE"] <- 0
    }
  }  
}
```

```{r set_order_shapes}
level1tab$QSPR <- factor(level1tab$QSPR, levels=c("ADMET", "Dawson", "OPERA", 
                                                     "Pradeep", 
                                                     "IVBP"))
ggshapes <- c(21, 22, 23, 24, 25)
ggcolors <- c("Red","Orange","Green","Blue","Purple")
```

# Count the number of predictions
```{r number_predictions, eval = TRUE}
pred.counts <- data.frame()
for (this.qspr in unique(level1tab$QSPR))
{
  pred.counts[this.qspr,"Clint"] <-
    sum(!is.na(subset(level1tab, QSPR==this.qspr)$Human.Clint.pred))
  pred.counts[this.qspr,"Fup"] <-
    sum(!is.na(subset(level1tab, QSPR==this.qspr)$Human.Fup.pred))
}

kable(pred.counts)

write.csv(pred.counts,
          file="tables/SupTable-QSPRPredCounts.txt")
```

# Let's try to avoid values that are just being retrieved from the training set:
```{r fold_error_cutoff, eval = TRUE}
TOOCLOSE.THRESHOLD <- 0.01
possible.training.chems <- NULL
for (this.row in 1:dim(level1tab)[1])
{
  clint <- level1tab[this.row,"Human.Clint.AbsFE"]
  fup <- level1tab[this.row,"Human.fup.AbsFE"]
  if (!is.na(clint))
  {
    if (!is.na(fup))
    {
      if (clint < TOOCLOSE.THRESHOLD & fup < TOOCLOSE.THRESHOLD)
      {
        possible.training.chems <- rbind(possible.training.chems,
                                         level1tab[this.row,])
        # Remove possible training chems from the analysis:
        level1tab[this.row,"Human.Clint.pred"] <-NA
        level1tab[this.row,"Human.Clint.AbsFE"] <-NA
        level1tab[this.row,"Human.Fup.pred"] <-NA
        level1tab[this.row,"Human.fup.AbsFE"] <-NA
        CvT.chems[CvT.chems$DTXSID %in% level1tab[this.row,"DTXSID"],
                  "Human.Clint.OPERA"] <- NA                            
        CvT.chems[CvT.chems$DTXSID %in% level1tab[this.row,"DTXSID"],
                  "Human.Fup.OPERA"] <- NA
      }
    }
  }
}

for (this.col in colnames(possible.training.chems))
  if (is.numeric(possible.training.chems[1,this.col]))
    possible.training.chems[,this.col] <- 
  signif(possible.training.chems[,this.col],3)
kable(possible.training.chems)
write.csv(possible.training.chems,row.names=FALSE,
          file="tables/SupTable-PossibleTrainingChems.txt")

cat("Results: QSPR Predictions\n")
cat(paste("A total of",
    dim(possible.training.chems)[1],
    "QSPR predictions were removed for possibly being in the training set (see Supplement Materials Table SupTable-PossibleTrainingChems.txt).\n"))
cat("\n")
cat(paste("A total of",
          dim(subset(possible.training.chems,QSPR=="OPERA"))[1],
          "predictions, all made by OPERA, were removed for possibly being in the training set (see Supplement Materials Table SupTable-PossibleTrainingChems.txt).\n"))
cat("\n")
cat("Results: Level 1 Analysis\n")
cat("Note that there were",
    dim(possible.training.chems)[1],
    "potential training chemicals that were removed from all analyses because they had been predicted too accurately.\n")
cat("\n")
```

```{r fold_error_differences, eval = TRUE}
ks.tests.clint <- data.frame()
ks.tests.fup <- data.frame()
FE.table <- data.frame()
for (this.qspr1 in unique(level1tab$QSPR))
{
  this.subset <-subset(level1tab,QSPR==this.qspr1)
  FE.table[this.qspr1,"Num.Clint.Compared"] <-
    sum(!is.na(this.subset$Human.Clint.AbsFE))
  FE.table[this.qspr1,"Median.Clint.AbsFE"] <- 
    median(this.subset$Human.Clint.AbsFE,na.rm=TRUE)
  FE.table[this.qspr1,"Median.Clint.FE"] <- 
    median(this.subset$Human.Clint.FE,na.rm=TRUE)
  FE.table[this.qspr1,"Min.Clint.FE"] <- 
    min(this.subset$Human.Clint.FE,na.rm=TRUE)
  FE.table[this.qspr1,"Max.Clint.FE"] <- 
    max(this.subset$Human.Clint.FE,na.rm=TRUE)
  FE.table[this.qspr1,"Num.fup.Compared"] <-
    sum(!is.na(this.subset$Human.fup.AbsFE))
  FE.table[this.qspr1,"Median.fup.AbsFE"] <- 
    median(this.subset$Human.fup.AbsFE,na.rm=TRUE)
  FE.table[this.qspr1,"Median.fup.FE"] <- 
    median(this.subset$Human.fup.FE,na.rm=TRUE)
  FE.table[this.qspr1,"Min.fup.FE"] <- 
    min(this.subset$Human.fup.FE,na.rm=TRUE)
  FE.table[this.qspr1,"Max.fup.FE"] <- 
    max(this.subset$Human.fup.FE,na.rm=TRUE)
  
  for (this.qspr2 in unique(level1tab$QSPR))
  {
    set1 <- this.subset$Human.Clint.FE
    set2 <- subset(level1tab,QSPR==this.qspr2)$Human.Clint.FE
    if (any(!is.na(set1)) & any(!is.na(set2))) ks.tests.clint[this.qspr1,this.qspr2] <- suppressWarnings(
      ks.test(set1,set2)$p.value)
    set1 <- this.subset$Human.fup.FE
    set2 <- subset(level1tab,QSPR==this.qspr2)$Human.fup.FE
    if (any(!is.na(set1)) & any(!is.na(set2))) ks.tests.fup[this.qspr1,this.qspr2] <- suppressWarnings(
      ks.test(set1,set2)$p.value)
  }
}

FE.table <- apply(FE.table, 2, function(x) signif(x,3))
ks.tests.clint <- apply(ks.tests.clint,2,function(x) signif(x,3))
ks.tests.fup <- apply(ks.tests.fup, 2, function(x) signif(x,3))
kable(FE.table)
kable(ks.tests.clint)
kable(ks.tests.fup)
write.csv(FE.table, file="tables/Table3-Level1FoldError.txt")
write.csv(ks.tests.clint, file="tables/SupTable-Level1KSCorClint.txt")
write.csv(ks.tests.fup, file="tables/SupTable-Level1KSCorFup.txt")
```

Calculate RPE:     
```{r prediction_table, eval = TRUE}
level1tab[,"Human.Clint.RPE"] <- 
  (as.numeric(level1tab[,"Human.Clint.pred"]) - 
  as.numeric(level1tab[,"Human.Clint.httk"])) /
  as.numeric(level1tab[,"Human.Clint.httk"])
level1tab[,"Human.Fup.RPE"] <- 
  (as.numeric(level1tab[,"Human.Fup.pred"]) - 
  as.numeric(level1tab[,"Human.Fup.httk"])) /
  as.numeric(level1tab[,"Human.Fup.httk"])
  
hist(subset(level1tab,QSPR=="Dawson")$Human.Clint.RPE,
     main="Dawson",xlab="Clint RPE")
hist(subset(level1tab,QSPR=="Pradeep")$Human.Clint.RPE,
     main="Pradeep",xlab="Clint RPE")
hist(subset(level1tab,QSPR=="ADMET")$Human.Clint.RPE,
     main="ADMET",xlab="Clint RPE")
hist(subset(level1tab,QSPR=="OPERA")$Human.Clint.RPE,
     main="OPERA",xlab="Clint RPE")

hist(subset(level1tab,QSPR=="Dawson")$Human.Fup.RPE,
     main="Dawson",xlab="Fup RPE")
hist(subset(level1tab,QSPR=="Pradeep")$Human.Fup.RPE,
     main="Pradeep",xlab="Fup RPE")
hist(subset(level1tab,QSPR=="ADMET")$Human.Fup.RPE,
     main="ADMET",xlab="Fup RPE")
hist(subset(level1tab,QSPR=="OPERA")$Human.Fup.RPE,
     main="OPERA",xlab="Fup RPE")
```

Check distribution of RPE for Clint:
```{r clint_rpe_hist, eval = TRUE}
hist(subset(level1tab,QSPR=="OPERA")$Human.Clint.RPE,main="OPERA",xlab="Clint RPE")
```

Check distribution of RPE for Fup:
```{r fup_rpe_hist, eval = TRUE}
hist(subset(level1tab,QSPR=="OPERA")$Human.Fup.RPE,main="OPERA",xlab="Fup RPE")
```

Make Level1 predictions vs. observed plot for Clint:
```{r clint_rpe_scatter, eval = TRUE}
FigLev1a <- ggplot(data=level1tab) +
  geom_point(size=3,alpha=0.5,
             aes(x=Human.Clint.pred+10^-4,
                 y=Human.Clint.httk+10^-4,
                 shape=QSPR,
                 fill=QSPR,
                 color=QSPR))+
  scale_shape_manual(values = ggshapes)+
  scale_color_manual(values = ggcolors)+
  scale_fill_manual(values = ggcolors)+
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10)+
  geom_abline(intercept = log10(10^(1/2)), 
              slope = 1,
              linetype="dashed", 
              colour="lightBlue") + 
  geom_abline(intercept = 0, 
              slope = 1,
              linetype="solid", 
              colour="Grey") + 
  geom_abline(intercept = log10(10^(-1/2)), 
              slope = 1
              ,linetype="dashed", 
              colour="lightBlue") + 
  xlab(bquote('Predicted'~Cl[int]~"("*mu*"L/min/"*10^6~"hep.)")) +
  ylab(bquote('Obs.'~Cl[int]~"("*mu*"L/min/"*10^6~"hep.)")) +
  theme_bw()+
  theme( text  = element_text(size=18))
print(FigLev1a)
ggsave(paste("figs/Fig3-Lev1a-Clint-obsvspred",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

## Make Level1 predictions vs. observed plot for Clint (faceted):
```{r clint_rpe_scatter, eval = TRUE}

## Tiff image for manuscript (facet to see the individual predictions over Clint value)
FigLev1a_facet <- ggplot(data=level1tab) +
  geom_point(size=2,aes(x=Human.Clint.pred+10^-1,
                        y=Human.Clint.httk+10^-1,
                        shape=QSPR,fill=QSPR,color=QSPR))+
  scale_shape_manual(values = ggshapes)+
  scale_color_manual(values = ggcolors)+
  scale_fill_manual(values = ggcolors)+
  scale_x_log10(breaks=c(1,10^2),label=scientific_10,limits=c(30^-1,3000)) +
  #scale_y_log10(label=scientific_10)+
  scale_y_log10(breaks=c(10^-1,1,10,10^2),
                label=scientific_10,limits = c(30^-1, 3000))+
  geom_abline(intercept = 0, 
              slope = 1,linetype="solid", colour="black",linewidth=0.2) +
  #geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, 
              slope = 1,linetype="dashed", colour="gray66",linewidth=0.3) +
  geom_abline(intercept = -1, 
              slope = 1,linetype="dashed", colour="gray66",linewidth=0.3) +
  xlab(bquote('Predicted'~Cl[int]~"("*mu*"L/min/"*10^6~"hep.)")) +
  ylab(bquote('Observed'~Cl[int]~"("*mu*"L/min/"*10^6~"hep.)")) +
  theme_bw()+
  facet_wrap(~QSPR)+
  theme( text  = element_text(size=20),
         legend.position = "none",
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=14))

print(FigLev1a_facet)
ggsave(paste("figs/SupFigLev1a-Clint-obsvpred-facet-",output.prefix,".tiff",sep=""), 
       width=6, height=5, dpi=300)
```

Make Level1 RPE box and whisker plot for Clint:
```{r clint_rpe_boxwhisker, eval = TRUE}
FigLev1b <- ggplot(data=level1tab, aes(x=QSPR, y=Human.Clint.RPE)) + 
  geom_boxplot(outlier.colour="red",    
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab(bquote("Relative Prediction Error in"~Cl[int]))+
  scale_y_log10(breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))
  print(FigLev1b)  
```

## calculate some statistics
```{r calc_AbsFE_RMSE, eval=TRUE}
Human.Clint.stats.table <- Human.fup.stats.table <- data.frame()
level1tab$Human.Clint.pred <- as.numeric(level1tab$Human.Clint.pred)
level1tab$Human.Clint.httk <- as.numeric(level1tab$Human.Clint.httk)
level1tab$Human.Fup.pred <- as.numeric(level1tab$Human.Fup.pred)
level1tab$Human.Clint.AbsFE <- as.numeric(level1tab$Human.Clint.AbsFE)
level1tab$Human.fup.AbsFE <- as.numeric(level1tab$Human.fup.AbsFE)
for (this.qspr in unique(level1tab$QSPR))
  if (!(this.qspr %in% c("In Vitro")))
  {
#Absolute Average Fold Error (AAFE) :  10^((1/n)*sum(abs(FE)))  ### use this. It's good to see fold error
    Human.Clint.stats.table["AAFE",this.qspr] <- calc_AAFE(
        subset(level1tab, QSPR==this.qspr),
        AbsFE.col="Human.Clint.AbsFE",
        sigfig=2)                                
    Human.fup.stats.table["AAFE",this.qspr] <- calc_AAFE(
        subset(level1tab, QSPR==this.qspr),
        AbsFE.col="Human.fup.AbsFE",
        sigfig=2)                                
#RMSLE sqrt(mean(log10(Xpred+1)-log10(Xobs+1))^2)  ### use this
    Human.Clint.stats.table["RMSLE",this.qspr] <- calc_RMSLE(
        subset(level1tab, QSPR==this.qspr),
        pred.col="Human.Clint.pred",
        obs.col="Human.Clint.httk",
        sigfig=2,
# How low do we want the zeros to be in the log10 calculation? This makes them at least 10x lower than lowest non-zero prediciton.
        zeroval=sort(unique(subset(level1tab, QSPR==this.qspr)$Human.Clint.pred,na.rm=TRUE))[2]/10)                           
    Human.fup.stats.table["RMSLE",this.qspr] <- calc_RMSLE(
        subset(level1tab, QSPR==this.qspr),
        pred.col="Human.Fup.pred",
        obs.col="Human.Fup.httk",
        sigfig=2,
        zeroval=sort(unique(subset(level1tab, QSPR==this.qspr)$Human.Fup.pred,na.rm=TRUE))[2]/10)  
  }
kable(Human.Clint.stats.table)
kable(Human.fup.stats.table)
write.csv(Human.Clint.stats.table, file="tables/SupTable-ClintStats.txt")
write.csv(Human.fup.stats.table, file="tables/SupTable-FupStats.txt")
```

#### add AAFE & RMSLE to the table
```{r clint_rpe_boxwhisker_stats, eval = TRUE}
# Make sure the QSPRs are displayed in the same order as columns in stats table:
#level1tab$QSPR <- factor(level1tab$QSPR,
#                             levels=colnames(Human.Clint.stats.table))
FigLev1b.texty <- -2
FigLev1b <- ggplot(data=level1tab, aes(x=QSPR, y=Human.Clint.RPE)) + 
  geom_boxplot(lwd=.3,  #reduce the boxplot linewidth
               outlier.shape=NA)+
  coord_cartesian(ylim=c(-3,8))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  xlab("QSPR") +
  ylab(bquote("Relative Error in"~Cl[int]))+
  theme_bw()+
  theme( text  = element_text(size=20),
         legend.key.height=unit(.5,"line"),
         legend.text=element_text(size=7),
         legend.title = element_text(size=8))

FigLev1b <- FigLev1b + annotation_custom(tableGrob(rownames(Human.Clint.stats.table), 
                              theme = ttheme_minimal(base_size = 10)),
                              xmin=0,xmax=1.5,
                              ymin=(FigLev1b.texty-1),ymax=FigLev1b.texty)
for (i in 1:length(colnames(Human.Clint.stats.table)))
{
  FigLev1b <- FigLev1b + annotation_custom(
    tableGrob(Human.Clint.stats.table[,i],rows=NULL, 
              theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=(2*i+0.3),
    ymin=(FigLev1b.texty-1),ymax=FigLev1b.texty)
}

print(FigLev1b) 
ggsave(paste("figs/SupFigLev1b-Clint-boxplot-wtable-",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r fup_rpe_boxwhisker_stats, eval = TRUE}

FigLev1c <- ggplot(data=subset(level1tab,!(QSPR %in% "IVBP"))) +
  geom_point(size=3,
             alpha=0.5,
             aes(x=Human.Fup.pred+10^-4,
                 y=Human.Fup.httk+10^-4,
                 shape=QSPR,fill=QSPR,color=QSPR))+
  scale_shape_manual(values = ggshapes)+
  scale_color_manual(values = ggcolors)+
  scale_fill_manual(values = ggcolors)+
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10)+
  geom_abline(intercept = log10(10^(1/2)), 
              slope = 1,linetype="dashed", 
              colour="lightBlue") +
  geom_abline(intercept = 0, 
              slope = 1,
              linetype="solid", 
              colour="Grey") + 
  geom_abline(intercept = log10(10^(-1/2)), 
              slope = 1,linetype="dashed", 
              colour="lightBlue") + 
  xlab(bquote('Predicted'~f[up])) +
  ylab(bquote('Observed'~f[up])) +
  theme_bw()+
  theme( text  = element_text(size=20))
print(FigLev1c)
ggsave(paste("figs/Fig4-Lev1c-Fup-obsvpred-",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r fup_rpe_boxwhisker_faceted, eval = TRUE}

## faceted
FigLev1c <- ggplot(data=subset(level1tab,!(QSPR %in% "IVBP"))) +
  geom_point(size=2,
             aes(x=Human.Fup.pred+10^-4,
                 y=Human.Fup.httk+10^-4,
                 shape=QSPR, 
                 fill=QSPR,
                 color=QSPR))+
  scale_x_log10(breaks=c(10^-8,10^-6,10^-4,10^-2,1),label=scientific_10)+
  scale_y_log10(breaks=c(10^-8,10^-6,10^-4,10^-2,1),label=scientific_10)+
  scale_shape_manual(values = ggshapes)+
  scale_color_manual(values = ggcolors)+
  scale_fill_manual(values = ggcolors)+
  geom_abline(intercept = 0, slope = 1,
              linetype="solid", colour="black", linewidth=0.2) +
  geom_abline(intercept = 1, slope = 1,
              linetype="dashed", colour="gray66", linewidth=0.3) +
  geom_abline(intercept = -1, slope = 1,
              linetype="dashed", colour="gray66", linewidth=0.3) +
  xlab(bquote('Predicted'~f[up])) +
  ylab(bquote('Observed'~f[up])) +
  facet_wrap(~QSPR)+
  theme_bw()+
  theme( text  = element_text(size=20),
         legend.position = "none",
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=14))
print(FigLev1c)
ggsave(paste("figs/SupFigLev1c-Fup-obsVpred-facet-",output.prefix,".tiff",sep=""), 
       width=6, height=5, dpi=300)
```

```{r fup_rpe_boxwhisker_stats, eval = TRUE}
FigLev1d <- ggplot(data=subset(level1tab,!(QSPR %in% "IVBP")), 
                   aes(x=QSPR, y=Human.Fup.RPE)) + 
  geom_boxplot(outlier.colour="red",    
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab(bquote("Relative Prediction Error in"~f[up]))+
  scale_y_log10(breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))
print(FigLev1d)  
ggsave(paste("figs/SupFigLev1d-Fup-RPE-",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

#### add AAFE & RMSLE to the table
```{r fup_rpe_boxwhisker_stats, eval = TRUE}

texty <- 3
FigLev1d <- ggplot(data=subset(level1tab,!(QSPR %in% "IVBP"))
                             , aes(x=QSPR, y=Human.Fup.RPE)) + 
  geom_boxplot(lwd=.3,  #reduce the boxplot linewidth
               outlier.shape=NA)+
 # coord_cartesian(ylim=c(-3,6))+ ### Pradeep NEW !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-1.5,3))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  xlab("QSPR") +
  ylab(bquote("Relative Error in"~f[up]))+
  theme_bw()+
  theme( text  = element_text(size=20),
         legend.key.height=unit(.5,"line"),
         legend.text=element_text(size=7),
         legend.title = element_text(size=8))

FigLev1d <- FigLev1d + annotation_custom(tableGrob(rownames(Human.fup.stats.table), 
                              theme = ttheme_minimal(base_size = 14)),
                              xmin=0,xmax=1.5,
                              ymin=(texty-1),ymax=texty)
for (i in 1:length(colnames(Human.fup.stats.table)))
  if (!(colnames(Human.fup.stats.table)[i] %in% c("IVBP")))
{
  FigLev1d <- FigLev1d + annotation_custom(
    tableGrob(Human.Clint.stats.table[,i],rows=NULL, 
              theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=(2*i+0.3),
    ymin=(texty-1),ymax=texty)
}      

print(FigLev1d) 
ggsave(paste("figs/SupFigLev1d-fup-boxplot-wtable-",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r write_out_data, eval=TRUE}
save(possible.training.chems, file="data/operatrainingchems.RData")
save(CvT.chems,CvT.chems.scale,
     file="data/Cvt-chems-level1.RData")
```
