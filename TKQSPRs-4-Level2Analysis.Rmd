---
title: "TK QSPR Bakeoff"
author: "John Wambaugh and Nisha Sipes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QSPR Bakeoff}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

First we clear the memory to make sure there are no holdovers from previous R runs
```{r clear_mermor, eval=TRUE}
rm(list=ls()) 
```

To use the code in this vignette, you'll first need to load a few packages (if you haven't already).
```{r load_packages, eval = TRUE}
library(readxl)
library(ggplot2)
library(httk)
library(scales)
library(gplots)
library(RColorBrewer)
library(DescTools)
library(gridExtra)
library(reshape2)
library(randomForest)
```

Load custom code 
```{r load_code, eval = TRUE}
setwd("C:/Users/jwambaug/git/tkqsars/")
source("clear_httk.R")
source("tkstats.R")

# Function for formating tick labels:
scientific_10 <- function(x) {                                  
  out <- gsub("1e", "10^", scientific_format()(x))              
  out <- gsub("\\+","",out)                                     
  out <- gsub("10\\^01","10",out)                               
  out <- parse(text=gsub("10\\^00","1",out))                    
}  
```


Set the time stamp:
```{r time_stamp, eval = TRUE}
# Time stamp:
output.prefix <- "Jan2024"
```

```{r load_data, eval= TRUE}
load("data/httkinvitro.RData")
load("data/Cvt-chems-level2.RData")
load("data/operatrainingchems.RData")
load("data/fittable.RData")
load("data/level2preds.RData")
load("data/httk-goodchems.RData")
```

# Level II Predictions -- CvT data
## Make Predictions

At level II we are comparing predictions made using QSPR values with actual
tissue concentration vs. time data. Most of the QSPR values are used with the
HTTK PBTK model to make predictions. I hope to get ADmet predictor PBTK
predictions too.

Level I included the predictions made with the in vitro measured values, but this 
is a subset of the total chemicals. Should probably run all statistics both
for all chemicals and just the subset to make sure that the QSPRs aren't 
affected by weird chemcials with no in vitro measured values. But I haven't 
done this yet.

Predictors evaluated:
* HTTK PBTK with in vitro measured values
* HTTK PBTK with ADmet
* HTTK PBTK with Pradeep
* HTTK PBTK with Dawson
* HTTK PBTK with OPERA
* HTTK PBTK with y-randomized in vitro measured values
* Empirical one- and two-comaprtment fits to CvT data

## Assign average to missing predictions:
```{r smooth_missing, eval = TRUE}
  QSPRs <- unique(level2tab$QSPR)
  for (this.chem in unique(level2tab$CAS))
  {
    this.subset1 <- subset(level2tab,CAS==this.chem)
    for (this.species in unique(this.subset1$Species))
    {
      this.subset2 <- subset(this.subset1,Species==this.species)
      for (this.route in unique(this.subset2$Route))
      {
        this.subset3 <- subset(this.subset2,Route==this.route)
        for (this.dose in unique(this.subset3$Dose))
        {
          this.subset4 <- subset(this.subset3,Dose==this.dose)
          for (this.time in unique(this.subset4$Time))
          {
            this.subset5 <- subset(this.subset4,Time==this.time)
            for (this.obs in unique(this.subset5$Conc.obs))
            {
              this.subset6 <- subset(this.subset5,Conc.obs==this.obs)
              # Omit the fits and y-randomization from the mean:
              mean.pred <- mean(subset(this.subset6,
                !(QSPR %in% c(
                  "FitsToData","YRandom","Consensus")))$Conc.pred,na.rm=TRUE)
              for (this.QSPR in QSPRs)
              {
                if (!(this.QSPR %in% this.subset6$QSPR))
                {
                  this.row <- this.subset6[1,]
                  this.row$QSPR <- this.QSPR
                  this.row$Conc.pred <- mean.pred
                  level2tab <- rbind(level2tab,this.row)
                }
              }
            }
          }
        }
      }
    }
  }      
```
  
```{r calc_level2_rpe, eval = TRUE}
  RPE.THRESH <- 20
  # Can't work with NA's:
  level2tab <- subset(level2tab,!is.na(Conc.pred))
 
  # Calculate RPE:
  level2tab$Conc.obs <- as.numeric(level2tab$Conc.obs)
  level2tab$Conc.pred <- as.numeric(level2tab$Conc.pred) 
  # Let's treat all "low" values as the same, where we define low with loq:
  level2tab$Conc.obs[level2tab$Conc.obs<level2tab$calc_loq] <- 
    level2tab[level2tab$Conc.obs<level2tab$calc_loq,"calc_loq"]

  level2tab$Conc.pred[level2tab$Conc.pred<level2tab$calc_loq] <- 
    level2tab[level2tab$Conc.pred<level2tab$calc_loq,"calc_loq"]
  
  level2tab$RPE <- (level2tab$Conc.pred-level2tab$Conc.obs)/level2tab$Conc.obs
  level2tab[level2tab$RPE>RPE.THRESH,"RPE"] <- RPE.THRESH
  hist(level2tab$RPE)

level2tab.stats$AUC.RPE <- (level2tab.stats$AUC.pred-level2tab.stats$AUC.obs)/level2tab.stats$AUC.obs
level2tab.stats[level2tab.stats$AUC.RPE>RPE.THRESH,"AUC.RPE"] <- RPE.THRESH
hist(level2tab.stats$AUC.RPE)

level2tab.stats$Cmax.RPE <- (level2tab.stats$Cmax.pred-level2tab.stats$Cmax.obs)/level2tab.stats$Cmax.obs
level2tab.stats[level2tab.stats$Cmax.RPE>RPE.THRESH,"Cmax.RPE"] <- RPE.THRESH
hist(level2tab.stats$Cmax.RPE)
     
#level2tab$RPE.trunc[level2tab$RPE.trunc < -100] <- -100
#level2tab$RPE.trunc[level2tab$RPE.trunc > 100] <- 100
 
#Turn -Inf and Inf into NA .... we don't need this because no $Conc.obs are 0, but it's good practice to write here
level2tab$RPE[level2tab$RPE=="Inf"]<-NA
level2tab$RPE[level2tab$RPE=="-Inf"]<-NA
#Turn NaN into 0 , because the NaN is a result of matching 0/0...and hence it was correctly identified.

### but we don't need this because no $Conc.obs are 0, but it's good practice to write here
level2tab$RPE[level2tab$RPE=="NaN"]<-0
 

source.table <- NULL
for (this.source in unique(level2tab$Source))
{
  this.subset <- subset(level2tab,Source==this.source)
  this.row <- this.subset[1,c(1:3,11)]
  this.row$RPE <- mean(this.subset$RPE)
  source.table <- rbind(source.table,this.row)
}
for (this.chem in unique(source.table$Compound))
{
  this.subset <- subset(source.table,Compound==this.chem)
  source.table[source.table$Compound==this.chem,"RPE.sd"] <- sd(this.subset$RPE)
}
source.table <- source.table[order(source.table$RPE.sd),]
write.csv(source.table,file="tables/Table-modelerrorsbysource.txt",row.names=F)
```

## calculate some statistics
```{r calc_level2_AbsFE_RMSE, eval = TRUE}
#Absolute fold error (AbsFE) : abs(log10(pred/obs))
level2tab$AbsFE<-abs(log10(level2tab$Conc.pred/level2tab$Conc.obs))

#Turn -Inf and Inf into NA
level2tab$AbsFE[level2tab$AbsFE=="Inf"]<-4   ######## lots because lots of $Conc.pred is zero
hist(level2tab$AbsFE)  # 4 seems large but does not to mess up the distribution

#Turn NaN into 0 , because the NaN is a result of matching 0/0...and hence it was correctly identified.
level2tab$AbsFE[level2tab$AbsFE=="NaN"]<-0  #none
```


```{r divide_cvt_bytime, eval = TRUE}
level2tab.early <- NULL
level2tab.late <- NULL
for (this.study in unique(level2tab$Source))
{
  this.subset1 <- subset(level2tab,Source==this.study)
  for (this.chem in unique(this.subset1$CAS))
  {
    this.subset2 <- subset(this.subset1,CAS==this.chem)
    mid.time <- mean(unique(this.subset2$Time))
    level2tab.early <- rbind(level2tab.early,
      subset(this.subset2,Time < mid.time))
    level2tab.late <- rbind(level2tab.late,
      subset(this.subset2,Time >= mid.time))
  }
}
```

```{r calc_setspecific_cvt_stats, eval = TRUE}
AAFE <- list()
AAFE.early <- list()
AAFE.late <- list()
RMSLE <- list()
RMSLE.early <- list()
RMSLE.late <- list()
MRPE <- list()
MRPE.early <- list()
MRPE.late <- list()

for (this.qspr in unique(level2tab$QSPR))
{
#Absolute Average Fold Error (AAFE) :  10^((1/n)*sum(abs(FE)))  ### use this. It's good to see fold error
  AAFE[[this.qspr]] <- 10^(mean(level2tab$AbsFE[
    level2tab$QSPR==this.qspr],na.rm=TRUE))
  AAFE.early[[this.qspr]] <- 10^(mean(level2tab.early$AbsFE[
    level2tab.early$QSPR==this.qspr],na.rm=TRUE))
  AAFE.late[[this.qspr]] <- 10^(mean(level2tab.late$AbsFE[
    level2tab.late$QSPR==this.qspr],na.rm=TRUE))
#RMSLE sqrt(mean(log10(Xpred+1)-log10(Xobs+1))2)  ### use this
  RMSLE[[this.qspr]] <- sqrt(mean((log10(level2tab$Conc.pred[
    level2tab$QSPR==this.qspr] /
    level2tab$Conc.obs[level2tab$QSPR==this.qspr]))^2,na.rm=TRUE))
  RMSLE.early[[this.qspr]] <-sqrt(mean((log10(level2tab.early$Conc.pred[
    level2tab.early$QSPR==this.qspr]/
    level2tab.early$Conc.obs[level2tab.early$QSPR==this.qspr]))^2,na.rm=TRUE))
  RMSLE.late[[this.qspr]] <-sqrt(mean((log10(level2tab.late$Conc.pred[
    level2tab.late$QSPR==this.qspr]/
    level2tab.late$Conc.obs[level2tab.late$QSPR==this.qspr]))^2,na.rm=TRUE))
  MRPE[[this.qspr]] <- median(subset(level2tab,QSPR==this.qspr)$RPE)
  MRPE.early[[this.qspr]] <- median(subset(level2tab.early,QSPR==this.qspr)$RPE)
  MRPE.late[[this.qspr]] <- median(subset(level2tab.late,QSPR==this.qspr)$RPE)
}
#Subset to just the measured in vitro chemicals:
meassub <- subset(level2tab, CAS %in% httk.both)
meassub.early <- subset(level2tab.early, CAS %in% httk.both)
meassub.late <- subset(level2tab.late, CAS %in% httk.both)
#Absolute Average Fold Error (AAFE) :  10^((1/n)*sum(abs(FE)))  ### use this. It's good to see fold error
  AAFE[["HTTK-InVitro-Measured"]] <- 10^(mean(meassub$AbsFE[
    meassub$QSPR=="HTTK-InVitro"],na.rm=TRUE))
  AAFE.early[["HTTK-InVitro-Measured"]] <- 10^(mean(meassub.early$AbsFE[
    meassub.early$QSPR=="HTTK-InVitro"],na.rm=TRUE))
  AAFE.late[["HTTK-InVitro-Measured"]] <- 10^(mean(meassub.late$AbsFE[
    meassub.late$QSPR=="HTTK-InVitro"],na.rm=TRUE))
#RMSLE sqrt(mean(log10(Xpred+1)-log10(Xobs+1))2)  ### use this
  RMSLE[["HTTK-InVitro-Measured"]] <- sqrt(mean((log10(meassub$Conc.pred[
    meassub$QSPR=="HTTK-InVitro"] /
    meassub$Conc.obs[meassub$QSPR=="HTTK-InVitro"]))^2,na.rm=TRUE))
  RMSLE.early[["HTTK-InVitro-Measured"]] <-
    sqrt(mean((log10(meassub.early$Conc.pred[
    meassub.early$QSPR=="HTTK-InVitro"] /
    meassub.early$Conc.obs[meassub.early$QSPR=="HTTK-InVitro"]))^2,na.rm=TRUE))
  RMSLE.late[["HTTK-InVitro-Measured"]] <-
    sqrt(mean((log10(meassub.late$Conc.pred[
    meassub.late$QSPR=="HTTK-InVitro"] /
    meassub.late$Conc.obs[meassub.late$QSPR=="HTTK-InVitro"]))^2,na.rm=TRUE))
  MRPE[["HTTK-InVitro-Measured"]] <- 
    median(subset(meassub,QSPR=="HTTK-InVitro")$RPE)
  MRPE.early[["HTTK-InVitro-Measured"]] <- 
    median(subset(meassub.early,QSPR=="HTTK-InVitro")$RPE)
  MRPE.late[["HTTK-InVitro-Measured"]] <- 
    median(subset(meassub.late,QSPR=="HTTK-InVitro")$RPE)


stats.table <- data.frame()
for (this.qspr in names(RMSLE))
{
  stats.table["AAFE",this.qspr] <- round(AAFE[[this.qspr]],2)
  stats.table["RMSLE",this.qspr] <- round(RMSLE[[this.qspr]],2)
  stats.table["MRPE",this.qspr] <- round(MRPE[[this.qspr]],2)
  stats.table["RMSLE.early",this.qspr] <- round(RMSLE.early[[this.qspr]],2)
  stats.table["RMSLE.late",this.qspr] <- round(RMSLE.late[[this.qspr]],2)
  stats.table["AAFE.early",this.qspr] <- round(AAFE.early[[this.qspr]],2)
  stats.table["AAFE.late",this.qspr] <- round(AAFE.late[[this.qspr]],2)
  stats.table["MRPE.early",this.qspr] <- round(MRPE.early[[this.qspr]],2)
  stats.table["MRPE.late",this.qspr] <- round(MRPE.late[[this.qspr]],2)
}
```

```{r calc_setspecific_summary_stats, eval = TRUE}
AUC.stats.table <- NULL
for (this.qspr in unique(level2tab.stats$QSPR))
{
  this.subset <- subset(level2tab.stats,QSPR==this.qspr)
  this.fit <- lm(data=subset(this.subset, AUC.pred>0),
                 log10(AUC.obs)~log10(AUC.pred))
  this.row <- data.frame(
    QSPR=this.qspr,
    R2=signif(summary(this.fit)$adj.r.squared,3),
    RMSLE=signif(sqrt(mean(summary(this.fit)$residuals^2)),3),
    RPE=signif(median(this.subset$AUC.RPE),3),
    RPE.low=signif(median(subset(this.subset,AUC.obs<10)$AUC.RPE),3),
    RPE.high=signif(median(subset(this.subset,AUC.obs>=10)$AUC.RPE),3)
    )
  AUC.stats.table <- rbind(AUC.stats.table,this.row)
}
# Add HTTK without in silico predictions:
this.qspr <- "HTTK-InVitro"
this.subset <- subset(level2tab.stats,QSPR==this.qspr& CAS %in% httk.both)
this.fit <- lm(data=subset(this.subset, AUC.pred>0),
               log10(AUC.obs)~log10(AUC.pred))
this.row <- data.frame(
  QSPR=paste(this.qspr,"Measured",sep="-"),
  R2=signif(summary(this.fit)$adj.r.squared,3),
  RMSLE=signif(sqrt(mean(summary(this.fit)$residuals^2)),3),
  RPE=signif(median(this.subset$AUC.RPE),3),
  RPE.low=signif(median(subset(this.subset,AUC.obs<10)$AUC.RPE),3),
  RPE.high=signif(median(subset(this.subset,AUC.obs>=10)$AUC.RPE),3)
  )
AUC.stats.table <- rbind(AUC.stats.table,this.row)
write.csv(AUC.stats.table,file="AUC-stats.txt",row.names=FALSE)

Cmax.stats.table <- NULL
for (this.qspr in unique(level2tab.stats$QSPR))
{
  QSPR=this.subset <- subset(level2tab.stats,QSPR==this.qspr)
  this.fit <- lm(data=subset(this.subset,Cmax.pred>0),
                 log10(Cmax.obs)~log10(Cmax.pred))
  this.row <- data.frame(
    QSPR=this.qspr,
    R2=signif(summary(this.fit)$adj.r.squared,3),
    RMSLE=signif(sqrt(mean(summary(this.fit)$residuals^2)),3),
    RPE=signif(median(this.subset$Cmax.RPE),3)
    )
  Cmax.stats.table <- rbind(Cmax.stats.table,this.row)
}
this.qspr <- "HTTK-InVitro"
this.subset <- subset(level2tab.stats,QSPR==this.qspr& CAS %in% httk.both)
this.fit <- lm(data=subset(this.subset, Cmax.pred>0),
               log10(Cmax.obs)~log10(Cmax.pred))
this.row <- data.frame(
  QSPR=paste(this.qspr,"Measured",sep="-"),
  R2=signif(summary(this.fit)$adj.r.squared,3),
  RMSLE=signif(sqrt(mean(summary(this.fit)$residuals^2)),3),
  RPE=signif(median(this.subset$Cmax.RPE),3)
  )
Cmax.stats.table <- rbind(Cmax.stats.table,this.row)
write.csv(Cmax.stats.table,file="Cmax-stats.txt",row.names=FALSE)

```

Heatmap with Level 2 stats
```{r make_heatmap, eval = TRUE}
CvT.chems.stats.heatmap <- CvT.chems.scale
for (this.qspr in unique(level2tab.stats$QSPR))
{
  this.subset <- subset(level2tab.stats,QSPR==this.qspr)
  print(paste(this.qspr,length(unique(this.subset$Compound))))
  for (this.chem in unique(this.subset$DTXSID))
  {
    this.subset2 <- subset(this.subset,DTXSID==this.chem)
    this.index <- tolower(CvT.chems.stats.heatmap$DTXSID)==tolower(this.chem)
    CvT.chems.stats.heatmap[this.index,paste("AUC.RPE",this.qspr,sep=".")] <- 
      mean(this.subset2$AUC.RPE)
    CvT.chems.stats.heatmap[this.index,paste("Cmax.RPE",this.qspr,sep=".")] <- 
      mean(this.subset2$Cmax.RPE)
    this.subset3 <- subset(level2tab, QSPR==this.qspr & DTXSID==this.chem)
    CvT.chems.stats.heatmap[this.index,paste("RMSLE",this.qspr,sep=".")] <- 
      mean(log10(this.subset3$Conc.obs/this.subset3$Conc.pred)^2)^(1/2)
    if (is.na(CvT.chems.stats.heatmap[this.index,paste("RMSLE",this.qspr,sep=".")])) browser()
  }
}
```

```{r scale_preds, eval = TRUE}
for (this.chem in CvT.chems.stats.heatmap$PREFERRED_NAME) 
{
#print(this.chem)
  this.index <- which(CvT.chems.stats.heatmap$PREFERRED_NAME==this.chem)
  v <- unlist(CvT.chems.stats.heatmap[this.index, regexpr("AUC.RPE",
    colnames(CvT.chems.stats.heatmap))!=-1])
#  print(v)
  if (any(!is.na(v)))
  {
    m <- mean(v,na.rm=TRUE)
    s <- sd(v,na.rm=TRUE)
    CvT.chems.stats.heatmap[this.index, regexpr("AUC.RPE",
      colnames(CvT.chems.stats.heatmap))!=-1] <- 
      (v - m)/s
  }
  v <- unlist(CvT.chems.stats.heatmap[this.index, regexpr("Cmax.RPE",
    colnames(CvT.chems.stats.heatmap))!=-1])
  #print(v)
  if (any(!is.na(v)))
  {
    m <- mean(v,na.rm=TRUE)
    s <- sd(v,na.rm=TRUE)
  CvT.chems.stats.heatmap[this.index, regexpr("Cmax.RPE",
    colnames(CvT.chems.stats.heatmap))!=-1] <- 
    (v - m)/s
  }
  v <- unlist(CvT.chems.stats.heatmap[this.index, regexpr("RMSLE",
    colnames(CvT.chems.stats.heatmap))!=-1])
  #print(v)
  if (any(!is.na(v)))
  {
    m <- mean(v,na.rm=TRUE)
    s <- sd(v,na.rm=TRUE)
    CvT.chems.stats.heatmap[this.index, regexpr("RMSLE",
      colnames(CvT.chems.stats.heatmap))!=-1] <- 
      (v - m)/s
  }
}
```

```{r make_stats_heatmap, eval = TRUE}
mypalette<-brewer.pal(11,"RdYlBu")
heatmap.2(as.matrix(CvT.chems.stats.heatmap[,
  4:dim(CvT.chems.stats.heatmap)[2]]),
  lwid=c(0.4,1),
  lhei=c(0.4,1),
  margins=c(10,1),
  labRow = FALSE,
  cexCol=1,
  trace="none",
  col=mypalette)
#par(mar=c(12,4,4,2)+0.1,cex.main=3) 
png(paste("figs/Fig-Chem-stats-heatmap-",
           output.prefix,
           ".tiff",sep=""),
, width=800*3, height=750*3)
heatmap.2(as.matrix(CvT.chems.stats.heatmap[,
  4:dim(CvT.chems.stats.heatmap)[2]]),
#  lwid=c(0.4,1),
#  lhei=c(0.4,1),
#  margins=c(10,1),
  labRow = FALSE, scale="row",
  cexRow=3,cexCol=3,
  keysize=0.75,
  margins=c(30,8),trace="none",srtCol=45,
  col=mypalette,
key.title="",
key.par=list(cex=2))
dev.off()
```

```{r make_level2_plot_stats, eval = FALSE}
#### add AAFE & RMSLE to the table
texty <- 20
xshift <- 0.3
fontsize <- 12
FigLev2 <- ggplot(data=level2tab, aes(x=QSPR, y=RPE)) + 
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-1,21))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Relative Error for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(tableGrob(c("AAFE","RMSLE"), theme = ttheme_minimal(base_size = 12)),
                    xmin=0,xmax=1.2+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"FitsToData"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=2.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTTK-ADmet"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=4.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTTK-Dawson"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=6.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTTK-InVitro"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=8.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTTK-OPERA"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=10.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTTK-Pradeep"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=12.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTTK-YRandom"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=14.3+xshift,ymin=(texty-1),ymax=texty)+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=fontsize),
  axis.title.y=element_text(size=12))
print(FigLev2) 
#ggsave(paste("figs/FigLev2_boxplot_trunc_PradeepNEW",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
ggsave(paste("figs/FigLev2_boxplot_trunc",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
```

```{r make_level2_plot_stats_early, eval = FALSE}
#### add AAFE & RMSLE to the table
texty <- 1
xshift <- 0.1
FigLev2 <- ggplot(data=level2tab.early, aes(x=QSPR, y=RPE)) + 
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-1,2))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Relative Error for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(tableGrob(c("AAFE","RMSLE"), theme = ttheme_minimal(base_size = 12)),
                    xmin=0,xmax=1.2+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"FitsToData"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=2.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTTK-ADmet"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=4.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTTK-Dawson"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=6.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTTK-InVitro"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=8.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTTK-OPERA"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=10.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTTK-Pradeep"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=12.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTTK-YRandom"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=14.3+xshift,ymin=(texty-1),ymax=texty)+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=12))
print(FigLev2) 
#ggsave(paste("figs/FigLev2_boxplot_trunc_PradeepNEW",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
ggsave(paste("figs/FigLev2_boxplot_trunc",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
```

```{r make_level2_plot_stats_late, eval = FALSE}
#### add AAFE & RMSLE to the table
texty <- 1
xshift <- 0.1
FigLev2 <- ggplot(data=level2tab.late, aes(x=QSPR, y=RPE)) + 
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-1,2))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Relative Error for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(tableGrob(c("AAFE","RMSLE"), theme = ttheme_minimal(base_size = 12)),
                    xmin=0,xmax=1.2+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.late","RMSLE.late"),"FitsToData"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=2.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE.late","RMSLE.late"),"HTTK-ADmet"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=4.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE.late","RMSLE.late"),"HTTK-Dawson"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=6.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.late","RMSLE.late"),"HTTK-InVitro"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=8.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.late","RMSLE.late"),"HTTK-OPERA"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=10.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.late","RMSLE.late"),"HTTK-Pradeep"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=12.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.late","RMSLE.late"),"HTTK-YRandom"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=14.3+xshift,ymin=(texty-1),ymax=texty)+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=12))
print(FigLev2) 
#ggsave(paste("figs/FigLev2_boxplot_trunc_PradeepNEW",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
ggsave(paste("figs/FigLev2_boxplot_trunc",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
```

```{r make_level2_auc_plot, eval = FALSE}
FigLev2.auc <- ggplot(data=level2tab.stats, aes(x=QSPR, y=AUC.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab("RPE for In Vivo CvTdb AUC")+
  scale_y_continuous(limits=c(-1.5,3)) +
#  scale_y_log10(limits=c(10^-1,10),breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
print(FigLev2.auc)  
```

```{r make_level2_auc_plot, eval = TRUE}
FigLev2AUC_facet <- ggplot(data=level2tab.stats) +
  geom_point(size=2,aes(x=AUC.pred,y=AUC.obs,shape=QSPR,color=QSPR))+
  scale_x_log10(breaks=c(10^-5,10^-2,10),label=scientific_10,limits=c(10^-7,3000)) +
  #scale_y_log10(label=scientific_10)+
  scale_y_log10(breaks=c(10^-1,1,10,10^2),label=scientific_10,limits = c(30^-1, 300))+
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="black",size=0.2) +
  #geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, slope = 1,linetype="dashed", colour="gray66",size=0.3) +
  geom_abline(intercept = -1, slope = 1,linetype="dashed", colour="gray66",size=0.3) +
  xlab('Predicted AUC (mg/L*h)') +
  ylab('Observed AUC (mg/L*h)') +
  theme_bw()+
  facet_grid(cols=vars(QSPR))+
  scale_shape_manual(values = 0:10)+
  theme( text  = element_text(size=20),
         legend.position = "none",
         strip.text.x = element_text(size = 8),
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=10))

print(FigLev2AUC_facet)
ggsave(paste("figs/FigLev2_AUCScatter",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
print(AUC.stats.table)
write.csv(AUC.stats.table, 
          file="tables/SupTable-AUCStats.txt")
```

```{r make_level2_auc_plot, eval = FALSE}
FigLev2.auc <- ggplot(data=level2tab.stats, aes(x=QSPR, y=AUC.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab("RPE for In Vivo CvTdb AUC")+
  scale_y_continuous(limits=c(-1.5,3)) +
#  scale_y_log10(limits=c(10^-1,10),breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
print(FigLev2.auc)  
ggsave(paste("figs/FigLev2-AUC-RPE",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r make_level2_cmax_plot, eval = FALSE}
FigLev2.cmax <- ggplot(data=level2tab.stats, aes(x=QSPR, y=Cmax.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab("RPE for In Vivo CvTdb Cmax")+
  scale_y_continuous(limits=c(-1.5,3)) +
 # scale_y_log10(breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
print(FigLev2.cmax)  
ggsave(paste("figs/FigLev2_CmaxRPE",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)

```

```{r make_level2_plot, eval = FALSE}
FigLev2 <- ggplot(data=level2tab, aes(x=QSPR, y=RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab("RPE for In Vivo CvT Data")+
 # scale_y_continuous(limits=c(-10,40)) +
 # scale_y_log10(limits=c(10-2,100),breaks=c(10^-1,1,3,10),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))+
  theme(axis.title.y = element_text(size=18))
print(FigLev2)  
ggsave(paste("figs/FigLev2_CvTRPE",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r make_level2_cmax_plot, eval = TRUE}
FigLev2Cmax_facet <- ggplot(data=level2tab.stats) +
  geom_point(size=2,aes(x=Cmax.pred,y=Cmax.obs,shape=QSPR,color=QSPR))+
  scale_x_log10(breaks=c(10^-5,10^-2,10^1),label=scientific_10,limits=c(10^-7,3000)) +
  #scale_y_log10(label=scientific_10)+
  scale_y_log10(breaks=c(10^-1,1,10,10^2),label=scientific_10,limits = c(30^-1, 300))+
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="black",size=0.2) +
  #geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, slope = 1,linetype="dashed", colour="gray66",size=0.3) +
  geom_abline(intercept = -1, slope = 1,linetype="dashed", colour="gray66",size=0.3) +
  xlab(bquote('Predicted'~C[max]~'(mg/L)')) +
  ylab(bquote('Observed'~C[max]~'(mg/L)')) +
  scale_shape_manual(values = 0:10)+
  theme_bw()+
  facet_grid(cols=vars(QSPR))+
  theme( text  = element_text(size=20),
         legend.position = "none",
         strip.text.x = element_text(size = 8),
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=10))

print(FigLev2Cmax_facet)
ggsave(paste("figs/FigLev2_CmaxScatter",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)

print(Cmax.stats.table)
write.csv(Cmax.stats.table,file="tables/SupTable-CmaxStats.txt")
```


```{r make_RMSE_bychem_analysis, eval = TRUE}
# Get rid of NA QSPRs:
level2tab <- subset(level2tab, !is.na(QSPR))

qsprbychem.table <- NULL
QSPRs <- unique(level2tab$QSPR)
for (this.chemical in unique(level2tab$Compound))
{
  for (this.qspr in QSPRs)
  {
    this.subset <- subset(level2tab,QSPR==this.qspr & Compound==this.chemical)
    if (dim(this.subset)[1]>0)
    {
      this.row <- this.subset[1,c(1:3,13)]
      this.row$RMSLE <- sqrt(mean((log10(this.subset$Conc.pred/
                                           this.subset$Conc.obs))^2,na.rm=TRUE))
      this.subset <- subset(level2tab.early,QSPR==this.qspr & Compound==this.chemical)
      this.row$RMSLE.early <- sqrt(mean((log10(this.subset$Conc.pred/
                                                 this.subset$Conc.obs))^2,na.rm=TRUE))
      this.subset <- subset(level2tab.late,QSPR==this.qspr & Compound==this.chemical)
      this.row$RMSLE.late <- sqrt(mean((log10(this.subset$Conc.pred/
                                                this.subset$Conc.obs))^2,na.rm=TRUE))
      qsprbychem.table <- rbind(qsprbychem.table,this.row)
    }
  }
}

for (this.qspr in unique(qsprbychem.table$QSPR))
{
  stats.table["RMSLE.bychem",this.qspr] <- 
    signif(median(subset(qsprbychem.table,QSPR==this.qspr)$RMSLE),3)
  stats.table["RMSLE.bychem.early",this.qspr] <-
    signif(median(subset(qsprbychem.table,QSPR==this.qspr)$RMSLE.early),3)
  stats.table["RMSLE.bychem.late",this.qspr] <-
    signif(median(subset(qsprbychem.table,QSPR==this.qspr)$RMSLE.late),3)
}
meassub <- subset(qsprbychem.table, CAS %in% httk.both)
this.qspr <- "HTTK-InVitro-Measured"
stats.table["RMSLE.bychem",this.qspr] <- 
  signif(median(subset(meassub,QSPR=="HTTK-InVitro")$RMSLE),3)
stats.table["RMSLE.bychem.early",this.qspr] <-
  signif(median(subset(meassub,QSPR=="HTTK-InVitro")$RMSLE.early),3)
stats.table["RMSLE.bychem.late",this.qspr] <-
  signif(median(subset(meassub,QSPR=="HTTK-InVitro")$RMSLE.late),3)

write.csv(stats.table,file="tables/Table-main-stats.txt",row.names=TRUE)

```


```{r make_RMSE_bychem_plot, eval = TRUE}
#### add AAFE & RMSLE for all points (not per chemical) to the table
texty <- 2.5
xshift <- 0.2
these.stats <- c("RMSLE.bychem","AAFE")
stat.labels <- c("RMSLE","AAFE")

#### Set order from left to right:
qsprs.rmsle.bychem <- NULL
for (this.qspr in unique(qsprbychem.table$QSPR)) 
  qsprs.rmsle.bychem[this.qspr] <-
  median(subset(qsprbychem.table,QSPR==this.qspr)$RMSLE) 

qsprs.order <- names(qsprs.rmsle.bychem)[order(qsprs.rmsle.bychem)] 
qsprbychem.table$QSPR <- factor(qsprbychem.table$QSPR,
                                   levels = qsprs.order)
         
#### Make Plot
FigLev2RMSE <- ggplot(data=qsprbychem.table, aes(x=QSPR, y=RMSLE)) + 
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-0.5,2.5))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Chemical-Specific RMSLE for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(
    tableGrob(stat.labels, theme = ttheme_minimal(base_size = 12)),
    xmin=0,xmax=1.2+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[1]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=2.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[2]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=4.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[3]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=6.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[4]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=8.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[5]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=10.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[6]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=12.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[7]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=14.3+xshift,ymin=(texty-1),ymax=texty)+ 
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=10))
print(FigLev2RMSE) 
ggsave(paste("figs/FigLev2_RMSEbyChem",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r make_RMSE_bychem_early_plot, eval = TRUE}
#### add AAFE & RMSLE for all points (not per chemical) to the table
texty <- 2.5
xshift <- 0.2
these.stats <- c("RMSLE.bychem.early","AAFE.early")
stat.labels <- c("RMSLE","AAFE")

#### Set order from left to right:
qsprs.rmsle.bychem <- NULL
for (this.qspr in unique(qsprbychem.table$QSPR)) 
  qsprs.rmsle.bychem[this.qspr] <-
  median(subset(qsprbychem.table,QSPR==this.qspr)$RMSLE.early) 

qsprs.order <- names(qsprs.rmsle.bychem)[order(qsprs.rmsle.bychem)] 
qsprbychem.table$QSPR <- factor(qsprbychem.table$QSPR,
                                   levels = qsprs.order)
 
#### Make Plot
FigLev2RMSE.early <- ggplot(data=qsprbychem.table, aes(x=QSPR, y=RMSLE.early)) +
   ggtitle("Early Time Points")+
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-0.5,2.5))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Chemical-Specific RMSLE for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(
    tableGrob(stat.labels, theme = ttheme_minimal(base_size = 12)),
    xmin=0,xmax=1.2+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[1]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=2.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[2]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=4.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[3]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=6.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[4]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=8.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[5]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=10.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[6]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=12.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[7]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=14.3+xshift,ymin=(texty-1),ymax=texty)+ 
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=10))
print(FigLev2RMSE.early)
ggsave(paste("figs/FigLev2_RMSEbyChemEarly",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```
```{r make_RMSE_bychem_late_plot, eval = TRUE}
#### add AAFE & RMSLE for all points (not per chemical) to the table
texty <- 2.5
xshift <- 0.2
these.stats <- c("RMSLE.bychem.late","AAFE.late")
stat.labels <- c("RMSLE","AAFE")

#### Set order from left to right:
qsprs.rmsle.bychem <- NULL
for (this.qspr in unique(qsprbychem.table$QSPR)) 
  qsprs.rmsle.bychem[this.qspr] <-
  median(subset(qsprbychem.table,QSPR==this.qspr)$RMSLE.late) 

qsprs.order <- names(qsprs.rmsle.bychem)[order(qsprs.rmsle.bychem)] 
qsprbychem.table$QSPR <- factor(qsprbychem.table$QSPR,
                                   levels = qsprs.order)
 
#### Make Plot
FigLev2RMSE.late <- ggplot(data=qsprbychem.table, aes(x=QSPR, y=RMSLE.late)) +
   ggtitle("Late Time Points")+
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-0.5,2.5))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Chemical-Specific RMSLE for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(
    tableGrob(stat.labels, theme = ttheme_minimal(base_size = 12)),
    xmin=0,xmax=1.2+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[1]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=2.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[2]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=4.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[3]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=6.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[4]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=8.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[5]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=10.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[6]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=12.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(signif(stats.table[these.stats,qsprs.order[7]],2),
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=14.3+xshift,ymin=(texty-1),ymax=texty)+ 
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=10))
print(FigLev2RMSE.late) 
ggsave(paste("figs/FigLev2_RMSEbyChemLAte",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```


```{r analyze_admet1,eval=TRUE}
admet.better <-NULL
invitro.better <-NULL
for (this.cas in unique(level2tab$CAS))
{
  this.subset1 <- subset(level2tab,CAS==this.cas)
  for (this.source in unique(this.subset1$Source))
  {
    this.subset2 <- subset(this.subset1,Source==this.source)  
    for (this.time in unique(this.subset2$Time))
    {
      this.subset3 <- subset(this.subset2,Time==this.time)
      this.subset3.invitro <- subset(this.subset3, QSPR=="HTTK-InVitro")
      this.subset3.admet <- subset(this.subset3, QSPR=="HTTK-ADmet")
      this.subset3 <- cbind(this.subset3.invitro,
        this.subset3.admet[,c("Conc.pred","RPE","AbsFE")])
      colnames(this.subset3)[16:18] <- paste(
        colnames(this.subset3)[16:18],"ADmet",sep=".")
      admet.better <- rbind(admet.better,
        subset(this.subset3,abs(RPE.ADmet) < abs(RPE)))
      invitro.better <- rbind(invitro.better,
        subset(this.subset3,abs(RPE.ADmet) > abs(RPE)))
    }
  }
}
admet.chems <- unique(admet.better$Compound)
invitro.chems <- unique(invitro.better$Compound)
admet.chems[!(admet.chems %in% invitro.chems)]
admet.better.chems <- admet.chems[!(admet.chems %in% invitro.chems)]
invitro.better.chems <- invitro.chems[!(invitro.chems %in% admet.chems)]

admet.better.data <- subset(CvT.chems,PREFERRED_NAME%in%admet.better.chems)
invitro.better.data <- subset(CvT.chems,PREFERRED_NAME%in%invitro.better.chems)


dev.new()
plot(admet.better.data$Human.Fup.httk,admet.better.data$Human.Fup.SPlus)
plot(admet.better.data$Human.Clint.httk+10^-3,admet.better.data$Human.Clint.SPlus+10^-3,log="xy")

```
      


Need to do invivo vs invitro/insilco plots for AUC & Cmax
Need heatmap of RMSE x chemical, can add phys-chem
```{r analyze_admet, eval = TRUE}
qsprbychem.table2 <- dcast(qsprbychem.table,Compound~QSPR,value.var="RMSLE")
chems <- qsprbychem.table2$Compound
qsprbychem.table2 <- apply(qsprbychem.table2[,2:(1+length(QSPRs))],2,as.numeric)[,1:7]
rownames(qsprbychem.table2) <- chems
colnames(qsprbychem.table2) <- c("FitsToData","ADmet","Dawson","InVitro","OPERA","Pradeep","Y-Random")
write.csv(signif(qsprbychem.table2,3),file="tables/SupTable-RMSLEbyChem.txt")
```

```{r make_rmse_heatmap, eval = TRUE}
  mypalette<-brewer.pal(9,"PuRd")
  heatmap.2(t(qsprbychem.table2),
 #   lwid=c(0.3,1),
#    lhei=c(0.3,1),
    margins=c(10,8),
#    labRow = FALSE,
    cexCol=0.5,
    cexRow=1.0,
    trace="none",
    col=mypalette)
tiff(paste("figs/Fig-RMSE-heatmap-",
           output.prefix,
           ".tiff",sep=""),
, width=800*3, height=750*2)
heatmap.2(t(qsprbychem.table2),
#  lwid=c(0.4,1),
#  lhei=c(0.4,1),
#  margins=c(10,1),
  scale="row",
  cexRow=3,cexCol=2,
  keysize=0.75,
  margins=c(30,30),trace="none",srtCol=45,
  col=mypalette,
key.title="",
key.par=list(cex=2))
dev.off()  
```

# Not sure if we can reasonably show all the predictions vs. the observations.
# Maybe one plot per model?
# FigLev2a <- ggplot(data=level2tab) +
#  geom_point(size=3,alpha=0.01,aes(x=Conc.pred.trunc,y=Conc.obs.trunc,shape=QSPR,color=QSPR))+
#  scale_x_log10(label=scientific_10) +
#  scale_y_log10(label=scientific_10)+
#    geom_abline(intercept = 0, slope = 1,linetype="dashed", colour="Blue") +
#  xlab(bquote('Predicted'~Cl[int]~"("*mu*"L/min/"*10^6~"hep.)")) +
#  ylab(bquote('Observed'~Cl[int]~"("*mu*"L/min/"*10^6~"hep.)")) +
#  theme_bw()+
#  theme( text  = element_text(size=20))
# print(FigLev2a)

```{r make_pred_vs_obs_plots, eval = TRUE}
FigLev2a <- ggplot(data=level2tab[level2tab$QSPR=="HTTK-InVitro",]) +
 geom_point(size=.75,alpha=0.05,aes(x=Conc.pred,y=Conc.obs))+
 scale_x_log10(breaks=10^seq(-5,4,by=2),label=scientific_10) +
 scale_y_log10(breaks=10^seq(-5,4,by=2),label=scientific_10)+
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="black",size=0.3) +
  # geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  geom_abline(intercept = -1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
 xlab(bquote('HTTK-InVitro')) +
 ylab(bquote(' ')) +
 theme_bw()+
 theme( text  = element_text(size=20),
         axis.text.y = element_text(size=10))
#print(FigLev2a)
ggsave(paste("figs/FigLev2_Conc_scatter_HTTKInVitro",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)

FigLev2b <- ggplot(data=level2tab[level2tab$QSPR=="HTTK-ADmet",]) +
  geom_point(size=.75,alpha=0.05,aes(x=Conc.pred,y=Conc.obs))+
  scale_x_log10(breaks=10^seq(-5,4,by=2),label=scientific_10) +
  scale_y_log10(breaks=10^seq(-5,4,by=2),label=scientific_10)+
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="black",size=0.3) +
  # geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  geom_abline(intercept = -1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  xlab(bquote('HTTK-ADMET')) +
  ylab(bquote(' ')) +
  theme_bw()+
  theme( text  = element_text(size=20),
         axis.text.y = element_text(size=10))
#print(FigLev2b)
ggsave(paste("figs/FigLev2_Conc_scatter_HTTKADmet",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)

FigLev2c <- ggplot(data=level2tab[level2tab$QSPR=="HTTK-Pradeep",]) +
  geom_point(size=.75,alpha=0.05,aes(x=Conc.pred,y=Conc.obs))+
  scale_x_log10(breaks=10^seq(-5,4,by=2),label=scientific_10) +
  scale_y_log10(breaks=10^seq(-5,4,by=2),label=scientific_10)+
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="black",size=0.3) +
  # geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  geom_abline(intercept = -1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  #  xlab(bquote('Predicted Conc HTTK-PradeepNEW')) +  ##Pradeep NEW ##
  xlab(bquote('HTTK-Pradeep')) +
  ylab(expression(paste("Obs. Conc. ",
    italic("In Vivo"),
    " (mg/L)"))) +
  theme_bw()+
  theme( text  = element_text(size=20),
         axis.title.y = element_text(size=14),
         axis.text.y = element_text(size=12))
#print(FigLev2c)
#ggsave(paste("figs/FigLev2_Conc_scatter_HTTKPradeepNEW",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
ggsave(paste("figs/FigLev2_Conc_scatter_HTTKPradeep",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)


FigLev2d <- ggplot(data=level2tab[level2tab$QSPR=="HTTK-Dawson",]) +
  geom_point(size=.75,alpha=0.05,aes(x=Conc.pred,y=Conc.obs))+
  scale_x_log10(breaks=10^seq(-5,4,by=2),label=scientific_10) +
  scale_y_log10(breaks=10^seq(-5,4,by=2),label=scientific_10)+
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="black",size=0.3) +
  # geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  geom_abline(intercept = -1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  xlab(bquote('HTTK-Dawson')) +
  ylab(bquote(' ')) +
  theme_bw()+
  theme( text  = element_text(size=20),
         axis.text.y = element_text(size=10))
#print(FigLev2d)
ggsave(paste("figs/FigLev2_Conc_scatter_HTTKDawson",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)

FigLev2e <- ggplot(data=level2tab[level2tab$QSPR=="HTTK-OPERA" ,]) +
  geom_point(size=.75,alpha=0.05,aes(x=Conc.pred,y=Conc.obs))+
  scale_x_log10(breaks=10^seq(-5,4,by=2),label=scientific_10) +
  scale_y_log10(breaks=10^seq(-5,4,by=2),label=scientific_10)+
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="black",size=0.3) +
  # geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  geom_abline(intercept = -1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  xlab(bquote('HTTK-OPERA')) +
  ylab(bquote(' ')) +
  theme_bw()+
  theme( text  = element_text(size=20),
         axis.text.y = element_text(size=10))
#print(FigLev2e)
ggsave(paste("figs/FigLev2_Conc_scatter_HTTKOPERA",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)

FigLev2f <- ggplot(data=level2tab[level2tab$QSPR=="FitsToData" ,]) +
  geom_point(size=.75,alpha=0.05,aes(x=Conc.pred,y=Conc.obs))+
  scale_x_log10(breaks=10^seq(-5,4,by=2),label=scientific_10) +
  scale_y_log10(breaks=10^seq(-5,4,by=2),label=scientific_10)+
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="black",size=0.3) +
  # geom_abline(intercept = log10(3), slope = 1,linetype="dotted", colour="gray") +
  #geom_abline(intercept = -log10(3), slope = 1,linetype="dotted", colour="gray") +
  geom_abline(intercept = 1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  geom_abline(intercept = -1, slope = 1,linetype="dashed", colour="gray22",size=0.3) +
  xlab(bquote('FitsToData')) +
  ylab(bquote(' ')) +
  theme_bw()+
  theme( text  = element_text(size=20),
         axis.text.y = element_text(size=10))
#print(FigLev2f)
ggsave(paste("figs/FigLev2_Conc_scatter_FitsToData",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)

grid.arrange(FigLev2a, FigLev2b, FigLev2c, FigLev2d, FigLev2e, FigLev2f, 
  nrow = 3, bottom=expression(paste("Predicted Conc. (mg/L)")))
ggsave(paste("figs/FigLev2_Conc_scatter_all",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)

```
