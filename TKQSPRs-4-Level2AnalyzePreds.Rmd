---
title: "TK QSPRs: Level 2 Analysis"
author: "John Wambaugh and Nisha Sipes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QSPR Bakeoff}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir= "C:/Users/jwambaug/git/CompTox-ExpoCast-HTTKQSPRs/")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

First we clear the memory to make sure there are no holdovers from previous R runs
```{r clear_mermor, eval=TRUE}
rm(list=ls()) 
```

To use the code in this vignette, you'll first need to load a few packages (if you haven't already).
```{r load_packages, eval = TRUE}
library(knitr)
```

# Set the time stamp:
```{r time_stamp, eval = TRUE}
# Time stamp:
output.prefix <- "Mar2025"
```

# Keep table numbering straight:
```{r load_code, eval = TRUE}
PREV.TABLES <- 4
PREV.SUP.TABLES <- 7
```

# Load custom code 
```{r load_code, eval = TRUE}
source("tkstats.R")
```

```{r load_data, eval= TRUE}
load("data/level2-tables.RData")
load("data/Cvt-chems-level1.RData")
load("data/cvT-chems-nona.RData")
load("data/httk-goodchems.RData")
```

# Level II Predictions -- CvT data
## Analyze Predictions

At level II we are comparing predictions made using QSPR values with actual
tissue concentration vs. time data. Most of the QSPR values are used with the
HTTK PBTK model to make predictions. 

Predictors evaluated:
* HTTK PBTK with in vitro measured values
* HTTK PBTK with ADMET
* HTTK PBTK with Pradeep
* HTTK PBTK with Dawson
* HTTK PBTK with OPERA
* HTTK PBTK with Consensus QSPR
* HTTK PBTK with y-randomized in vitro measured values
* Empirical one- and two-compartment fits to CvT data


```{r create_summary_chemlists, eval=TRUE}
pharma <- read.csv("ccd_data/Chemical List ZINC15PHARMA-2024-09-09.csv")
pharma$DTXSID <- gsub("https://comptox.epa.gov/dashboard/chemical/details/","",pharma$DTXSID)
pharma.chems <- CvT.chems$DTXSID[CvT.chems$DTXSID%in%pharma$DTXSID]
nonpharma.chems <- CvT.chems$DTXSID[!(CvT.chems$DTXSID%in%pharma$DTXSID)]

invitro.chems <- names(level2tab.rmsle[["HTPBTK-InVitro"]])
intersect.chems <- CvT.chems.nona$DTXSID
for (this.qspr in names(level2tab.rmsle))
  if (!(this.qspr %in% c("HTPBTK-InVitro","HTPBTK-YRandom","In Vivo Fits")))
  intersect.chems <- intersect(intersect.chems, names(level2tab.rmsle[[this.qspr]]))
max.chems <- unique(CvT.chems.nona$DTXSID)
noinvitro.chems <- max.chems[!(max.chems %in% invitro.chems)]

```

```{r create_rmsle_summary_table_bychemnumber, eval=TRUE}     
chem.lists<-list("In Vitro" = invitro.chems,
                 "No In Vitro" = noinvitro.chems,
                 "QSPR Intersection" = intersect.chems,
                 "Maximal" = max.chems,
                 "Pharma" = pharma.chems,
                 "Non-Pharma" = nonpharma.chems
                )
                                         
stats.table <- data.frame()
stats.table <- makestatstable2(stats.table,
                level2tab.rmsle,
                chem.lists,
                sigfig=2)
write.csv(stats.table, 
          file=paste("tables/Table",
          PREV.TABLES + 1,
          "-Level2-Cvt-RMSLEstats.txt",sep=""),
          row.names=TRUE)
kable(stats.table)
rmsle.stats.table <- stats.table
```

```{r create_aafe_summary_table_bychemnumber, eval=TRUE}     
stats.table <- data.frame()
stats.table <- makestatstable2(stats.table,
                level2tab.aafe,
                chem.lists,
                sigfig=2)
write.csv(stats.table, 
          file=paste("tables/SupTable",
          PREV.SUP.TABLES + 1,
          "-Level2-Cvt-AAFEstats.txt", sep=""),
          row.names=TRUE)
kable(stats.table)
aafe.stats.table <- stats.table

```
```{r create_afe_summary_table_bychemnumber, eval=TRUE}     
stats.table <- data.frame()
stats.table <- makestatstable2(stats.table,
                level2tab.afe,
                chem.lists,
                sigfig=2)
write.csv(stats.table,
          file=paste("tables/SupTable",
          PREV.SUP.TABLES + 2,
          "-Level2-Cvt-AFEstats.txt", sep=""),
          row.names=TRUE)
kable(stats.table)
afe.stats.table <- stats.table
```
```{r create_rmsleaafeafe_comp_table, eval=TRUE}     
stats.table <- data.frame()
stats.table <- makestatstable2(stats.table,
                level2tab.rmsle,
                chem.lists["Maximal"],
                label="RMSLE",
                sigfig=2)
stats.table <- makestatstable2(stats.table,
                level2tab.aafe,
                chem.lists["Maximal"],
                label="AAFE",
                sigfig=2)
stats.table <- makestatstable2(stats.table,
                level2tab.afe,
                chem.lists["Maximal"],
                label="AFE",
                sigfig=2)
write.csv(stats.table,
          file=paste("tables/Table",
          PREV.TABLES + 2,
          "-Level2-Cvt-RMSLEAAFEAFEcomp.txt",
          sep=""),
          row.names=TRUE)
kable(stats.table)
rmsle.stats.table <- stats.table
```

```{r create_rmsle_summary_table_early_late, eval=TRUE}
stats.table <- data.frame()
stats.table <- makestatstable2(stats.table,
                level2tab.rmsle.early,
                chem.lists,
                label="Early",
                sigfig=2)
stats.table <- makestatstable2(stats.table,
                level2tab.rmsle.late,
                chem.lists,
                label="Late",
                sigfig=2)
write.csv(stats.table,file="tables/SupTable-Level2-Cvt-earlylatestats.txt",row.names=TRUE)
kable(stats.table)
earlylate.stats.table <- stats.table
```
```{r bigstattable}
new.table <- NULL
for (this.qspr in names(level2tab.stats))
{
  new.table <- rbind(new.table, level2tab.stats[[this.qspr]])
}
level2tab.stats <- new.table
```

```{r create_auc_summary_table_bychem, eval=TRUE}     
stats.table <- makestatstable(level2tab.stats,
                                       obs.col="AUC.obs",
                                       pred.col="AUC.pred",
                                       chem.lists=list(
                                         "In Vitro" = invitro.chems,
                                         "No In Vitro" = unique(level2tab.stats$DTXSID)[
                                           !(unique(level2tab.stats$DTXSID) %in%
                                               invitro.chems)],
                                         "QSPR Intersection" = intersect.chems,
                                         "Maximal" = unique(level2tab.stats$DTXSID),
                                         "Pharma" = pharma.chems,
                                         "Non-Pharma" = nonpharma.chems
                                         ),
                                       logrsquared = TRUE,
                              average.per.chemical = TRUE
                                       )
write.csv(stats.table,file="tables/SupTable-Level2-AUCstats.txt",row.names=TRUE)
kable(stats.table)
AUC.stats.table <- stats.table
```
```{r create_cmax_summary_table_bychem, eval=TRUE}     
stats.table <- makestatstable(level2tab.stats,
                                       obs.col="Cmax.obs",
                                       pred.col="Cmax.pred",
                                       chem.lists=list(
                                         "In Vitro" = invitro.chems,
                                         "No In Vitro" = unique(level2tab.stats$DTXSID)[
                                           !(unique(level2tab.stats$DTXSID) %in%
                                               invitro.chems)],
                                         "QSPR Intersection" = intersect.chems,
                                         "Maximal" = unique(level2tab.stats$DTXSID),
                                         "Pharma" = pharma.chems,
                                         "Non-Pharma" = nonpharma.chems
                                         ),
                                       logrsquared = TRUE,
                              average.per.chemical = TRUE
                                       )
write.csv(stats.table,file="tables/SupTable-Level2-Cmaxstats.txt",row.names=TRUE)
kable(stats.table)
Cmax.stats.table <- stats.table
```


```{r write_level2_results}
save(rmsle.stats.table,
     aafe.stats.table,
     afe.stats.table,
     earlylate.stats.table,
     AUC.stats.table,
     Cmax.stats.table,
     intersect.chems,
     invitro.chems, 
     file="data/level2stats.RData")
save(invitro.chems,
     intersect.chems,
     max.chems,
     noinvitro.chems,
     file="data/chemicallists.RData")
```
