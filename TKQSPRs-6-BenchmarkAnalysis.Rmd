---
title: "TK QSPRs: Benchmark Analysis"
author: "John Wambaugh and Nisha Sipes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{TK QSPRs: Benchmark Analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir= "C:/Users/jwambaug/git/CompTox-ExpoCast-HTTKQSPRs/")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

First we clear the memory to make sure there are no holdovers from previous R runs
```{r clear_mermor, eval=TRUE}
rm(list=ls()) 
```

To use the code in this vignette, you'll first need to load a few packages (if you haven't already).
```{r load_packages, eval = TRUE}
library(readxl)
library(ggplot2)
library(scales)
library(knitr)
```

```{r load_data, eval= TRUE}
load("data/level3-tables.RData")
load("data/level2stats.RData")
load("data/httk-goodchems.RData")
load("data/chemicallists.RData")
  # Can't work with NA's:
  level3tab <- level3tab[!names(level3tab) %in% c("HTPBTK-InVitro-AltClear","HTPBTK-InVitro-Rat")]
```

# Load custom code 
```{r load_code, eval = TRUE}
source("tkstats.R")
```

# Keep table numbering straight:
```{r load_code, eval = TRUE}
PREV.TABLES <- 4
PREV.SUP.TABLES <- 7
```

# Set the time stamp:
```{r time_stamp, eval = TRUE}
# Time stamp:
output.prefix <- "May2025"
```

# Benchmark Values Using In Vivo, In Vitro, and Y-randomized In Vitro Data
```{r benchmark_table, eval=TRUE}
which.cols <- c("In Vivo Fits",
                "HTPBTK-InVitro",
                "HTPBTK-InVitro-AltClear",
                "HTPBTK-InVitro-Rat",
                "HTPBTK-YRandom") 
bench.table  <- rmsle.stats.table["In Vitro RMSLE", which.cols]
rownames(bench.table) <- c("CvT RMSLE")
#rownames(bench.table) <- c("CvT RMSLE","CvT AAFE","CvT AFE")
# Add early vs. late CvT breakdown:
next.rows <- earlylate.stats.table[, which.cols]
next.rows <- next.rows[c("Maximal Early","Maximal Late"),]
rownames(next.rows) <- c("Early CvT RMSLE","Late CvT RMSLE")
bench.table <- rbind(bench.table,next.rows)
# Add AUC breakdown:
next.rows <- AUC.stats.table[, which.cols]
next.rows <- next.rows[c("RMSLE Maximal"),]
rownames(next.rows) <- c("AUC RMSLE")
bench.table <- rbind(bench.table,next.rows)
# Add Cmax breakdown:
next.rows <- Cmax.stats.table[, which.cols]
next.rows <- next.rows[c("RMSLE Maximal"),]
rownames(next.rows) <- c("Cmax RMSLE")
bench.table <- rbind(bench.table,next.rows)
colnames(bench.table) <- c("In Vivo Fits",
                           "In Vitro Non-Restrictive",
                           "In Vitro Restrictive",
                           "Rat In Vitro",
                           "Y-Randomized")
for (this.col in 1:dim(bench.table)[2])
{
  colnames(bench.table)[this.col] <- paste(colnames(bench.table)[this.col],
                                           strsplit(bench.table[,this.col]," ")[[1]][2])
  bench.table[,this.col] <- as.numeric(lapply(strsplit(bench.table[,this.col]," "),
                                              function(x) x[1]))
}
kable(bench.table)
write.csv(bench.table,
          file=paste(
          "tables/Table",
          PREV.TABLES + 1,
          "-Benchmark-stats.txt",
          sep=""))
save(bench.table,
     file="data/benchmarkstats.RData")
```
```{r paper_text}
cat(paste(
  "It appears clear from the median error for HT-PBTK simulations that the ",
  "majority of chemicals in this set are non-restrictive (RMSLE ",
  bench.table["CvT RMSLE","In Vitro Non-Restrictive (56)"],
  ") rather than restrictive (",
  bench.table["CvT RMSLE","In Vitro Restrictive (56)"],
  ").\n",
  sep=""))
cat(paste(
  "For example, the difference for AUC is a factor of ",
  signif(bench.table["AUC RMSLE","Y-Randomized (89)"]/
         bench.table["AUC RMSLE","In Vitro Non-Restrictive (56)"],
         2),
  "-fold (or ",
  signif(10^(bench.table["AUC RMSLE","Y-Randomized (89)"]-
         bench.table["AUC RMSLE","In Vitro Non-Restrictive (56)"]),
         2),
  " times) between the appropriate in vitro value (",
  bench.table["AUC RMSLE","In Vitro Non-Restrictive (56)"],
  ") and the y-randomized value (",
  bench.table["AUC RMSLE","Y-Randomized (89)"],
  ").\n",
  sep=""))
cat(paste(
  "In contrast, there is little difference for early CvT data -- a factor of ",
  signif(bench.table["Early CvT RMSLE","Y-Randomized (89)"]/
         bench.table["Early CvT RMSLE","In Vitro Non-Restrictive (56)"],
         2),
  "-fold between the appropriate in vitro value (",
  bench.table["Early CvT RMSLE","In Vitro Non-Restrictive (56)"],
  ") and the y-randomized value (",
  bench.table["Early CvT RMSLE","Y-Randomized (89)"],
  ").\n",
  sep=""))
```
