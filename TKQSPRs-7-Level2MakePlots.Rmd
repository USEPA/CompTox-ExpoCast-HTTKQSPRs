---
title: "HTTK QSPRs: Make Level 2 Plots"
author: "John Wambaugh and Nisha Sipes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QSPR Bakeoff}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir= "C:/Users/jwambaug/git/CompTox-ExpoCast-HTTKQSPRs/")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

First we clear the memory to make sure there are no holdovers from previous R runs
```{r clear_mermor, eval=TRUE}
rm(list=ls()) 
```

To use the code in this vignette, you'll first need to load a few packages (if you haven't already).
```{r load_packages, eval = TRUE}
library(readxl)
library(ggplot2)
library(httk)
library(scales)
library(gplots)
library(RColorBrewer)
library(DescTools)
library(gridExtra)
library(reshape2)
library(knitr)
library(egg)
```

Load custom code 
```{r load_code, eval = TRUE}
source("tkstats.R")
```

# Keep table numbering straight:
```{r load_code, eval = TRUE}
PREV.TABLES <- 6
PREV.SUP.TABLES <- 11
```

Set the time stamp:
```{r time_stamp, eval = TRUE}
# Time_Days stamp:
output.prefix <- "May2025"
```

```{r load_data, eval= TRUE}
load("data/level2-tables.RData")
load("data/level2stats.RData")
load("data/httk-goodchems.RData")
load("data/Cvt-chems-level1.RData")
# Remove non-restrictive runs:
level2tab.cvt <- level2tab.cvt[
  !(names(level2tab.cvt) %in% c("HTPBTK-InVitro-AltClear","HTPBTK-InVitro-Rat"))]
```

# Level II Predictions -- CvT data
## Make Plots

At level II we are comparing predictions made using QSPR values with actual
tissue concentration vs. time data. Most of the QSPR values are used with the
HTTK PBTK model to make predictions. 

Predictors evaluated:
* HTTK PBTK with in vitro measured values
* HTTK PBTK with ADMET
* HTTK PBTK with Pradeep
* HTTK PBTK with Dawson
* HTTK PBTK with OPERA
* HTTK PBTK with Ensemble QSPR
* HTTK PBTK with y-randomized in vitro measured values
* Empirical one- and two-comaprtment fits to CvT data

## Collect the Concentration vs. time (level 2) predictions from each model:
```{r cvt_onering, eval = TRUE}
stats.table <- rmsle.stats.table

cvttab <- statstab <- qsprbychem.table <- NULL
for (this.qspr in names(level2tab.cvt))
{
  cvttab <- rbind(cvttab, level2tab.cvt[[this.qspr]])
  statstab <- rbind(statstab, level2tab.stats[[this.qspr]])
  this.table <- data.frame(DTXSID= names(level2tab.rmsle[[this.qspr]]),
                      RMSLE = unlist(level2tab.rmsle[[this.qspr]]),
                      RMSLE.early = unlist(level2tab.rmsle.early[[this.qspr]]),
                      RMSLE.late = unlist(level2tab.rmsle.late[[this.qspr]]),
                      AAFE = unlist(level2tab.aafe[[this.qspr]]),
                      QSPR = this.qspr
                      )
  this.table$RMSLE <- as.numeric(this.table$RMSLE)
  qsprbychem.table <- rbind(qsprbychem.table, this.table)
}
# Add compound names:
qsprbychem.table <- 
  merge(qsprbychem.table,
        cvttab[!(duplicated(cvttab$DTXSID)),c("DTXSID","Compound")],
        by="DTXSID")

level2tab <- cvttab
level2tab.stats <- statstab
level2tab <- subset(level2tab,!duplicated(level2tab))
level2tab.stats <- subset(level2tab.stats,!duplicated(level2tab.stats))
# Occasionally we can't calculate AUC, get rid of these data:
level2tab.stats <- subset(level2tab.stats, !is.na(AUC.obs))
```

## Concentration vs. time plots for each chemical-QSPR combination
```{r evaluation_plots}
pdf(file="figs/SupFig-ChembyQSPRCvTPlots.pdf")
for (this.chem in unique(level2tab$DTXSID))
  for (this.QSPR in unique(level2tab$QSPR))
    if (!(this.QSPR %in% c("HTPBTK-YRandom",
                           "HTPBTK-InVitro-Caco2Exp",
                           "HTPBTK-InVitro-Caco2QSPR")))
    for (this.species in unique(level2tab$Species))
    {
      this.subset <- subset(level2tab, 
                            DTXSID==this.chem &
                            QSPR == this.QSPR &
                            Species == this.species)
      if (dim(this.subset)[1]>0)
      {
        RMSLE <- signif(calc_RMSLE(this.subset), 3)
        if (is.nan(RMSLE)) browser()
        level2tab.stats[
          level2tab.stats$DTXSID==this.chem &
          level2tab.stats$QSPR == this.QSPR &
          level2tab.stats$Species == this.species,
          "RMSLE"] <- RMSLE
        FigCvt <- ggplot(data=this.subset,aes(x=Time_Days,y=Conc.obs)) +
          geom_point(size=3,
                     aes(x=Time_Days,y=Conc.obs,
                         colour = factor(Dose),
                         shape = factor(Route)))+
          geom_line(aes(x=Time_Days,y=Conc.pred,
                        linetype=factor(Route),
                        colour = factor(Dose),
                    ))+
          ylab("Concentration (mg/L)")+
          xlab("Time (Days)") +
          scale_y_log10(label=scientific_10)+
          ggtitle(label=paste(this.subset$Compound[1],
                              "-",
                              this.species,
                              "-",
                              this.QSPR,
                              ", RMSLE=",
                              RMSLE,
                              sep=""))
        print(FigCvt)
      #  cat(paste(this.chem,this.QSPR,this.species))
      #  browser()
      }
    }
dev.off()

# Calculate RMSLE for "YRandom":
for (this.chem in unique(level2tab$DTXSID))
  for (this.QSPR in unique(level2tab$QSPR))
    if ((this.QSPR %in% c("HTPBTK-YRandom")))
    for (this.species in unique(level2tab$Species))
    {
      this.subset <- subset(level2tab, 
                            DTXSID==this.chem &
                            QSPR == this.QSPR &
                            Species == this.species)
      if (dim(this.subset)[1]>0)
      {
        RMSLE <- signif(calc_RMSLE(this.subset), 3)
        if (is.nan(RMSLE)) browser()
        level2tab.stats[
          level2tab.stats$DTXSID==this.chem &
          level2tab.stats$QSPR == this.QSPR &
          level2tab.stats$Species == this.species,
          "RMSLE"] <- RMSLE
      }
    }
```

## Heatmap with Level 2 stats
```{r make_heatmap, eval = TRUE}
level2tab.stats$AUC.RPE <- calc_RPE(obs = level2tab.stats$AUC.obs,
                                    pred = level2tab.stats$AUC.pred)
level2tab.stats$Cmax.RPE <- calc_RPE(obs = level2tab.stats$Cmax.obs,
                                    pred = level2tab.stats$Cmax.pred)
CvT.chems.stats.heatmap <- CvT.chems.scale
for (this.qspr in unique(level2tab.stats$QSPR))
  if (regexpr("Caco2", this.qspr)==-1)
{
  this.subset <- subset(level2tab.stats, QSPR==this.qspr)
  print(paste(this.qspr,length(unique(this.subset$Compound))))
  for (this.chem in unique(this.subset$DTXSID))
  {
    this.subset2 <- subset(this.subset, DTXSID==this.chem)
    this.index <- tolower(CvT.chems.stats.heatmap$DTXSID)==tolower(this.chem)
    CvT.chems.stats.heatmap[this.index,paste("AUC.RPE",this.qspr,sep=".")] <- 
      mean(this.subset2$AUC.RPE,na.rm=TRUE)
    CvT.chems.stats.heatmap[this.index,paste("Cmax.RPE",this.qspr,sep=".")] <- 
      mean(this.subset2$Cmax.RPE,na.rm=TRUE)
    CvT.chems.stats.heatmap[this.index,paste("RMSLE",this.qspr,sep=".")] <- 
      mean(this.subset2$RMSLE,na.rm=TRUE)
  }
}
```

```{r scale_preds, eval = TRUE}
for (this.chem in CvT.chems.stats.heatmap$PREFERRED_NAME) 
{
#print(this.chem)
  this.index <- which(CvT.chems.stats.heatmap$PREFERRED_NAME==this.chem)
  v <- unlist(CvT.chems.stats.heatmap[this.index, regexpr("AUC.RPE",
    colnames(CvT.chems.stats.heatmap))!=-1])
#  print(v)
  if (any(!is.na(v)))
  {
    m <- mean(v,na.rm=TRUE)
    s <- sd(v,na.rm=TRUE)
    CvT.chems.stats.heatmap[this.index, regexpr("AUC.RPE",
      colnames(CvT.chems.stats.heatmap))!=-1] <- 
      (v - m)/s
  }
  v <- unlist(CvT.chems.stats.heatmap[this.index, regexpr("Cmax.RPE",
    colnames(CvT.chems.stats.heatmap))!=-1])
  #print(v)
  if (any(!is.na(v)))
  {
    m <- mean(v,na.rm=TRUE)
    s <- sd(v,na.rm=TRUE)
  CvT.chems.stats.heatmap[this.index, regexpr("Cmax.RPE",
    colnames(CvT.chems.stats.heatmap))!=-1] <- 
    (v - m)/s
  }
  v <- unlist(CvT.chems.stats.heatmap[this.index, regexpr("RMSLE",
    colnames(CvT.chems.stats.heatmap))!=-1])
  #print(v)
  if (any(!is.na(v)))
  {
    m <- mean(v,na.rm=TRUE)
    s <- sd(v,na.rm=TRUE)
    CvT.chems.stats.heatmap[this.index, regexpr("RMSLE",
      colnames(CvT.chems.stats.heatmap))!=-1] <- 
      (v - m)/s
  }
}
```

```{r shrink_heatmap, eval = TRUE}
CvT.chems.stats.heatmap <- CvT.chems.stats.heatmap[,
                             c("DTXSID",
                               "PREFERRED_NAME",
                               "CASRN",
                               colnames(CvT.chems.stats.heatmap)[regexpr("RMSLE", colnames(CvT.chems.stats.heatmap))!=-1],
                               colnames(CvT.chems.stats.heatmap)[regexpr("RPE", colnames(CvT.chems.stats.heatmap))!=-1],
                              "Thalf.fit")]
CvT.chems.stats.heatmap <- CvT.chems.stats.heatmap[
  apply(CvT.chems.stats.heatmap[,4:28],1,function(x) !all(is.na(x))),]
```

```{r make_stats_heatmap, eval = TRUE}
mypalette<-brewer.pal(11,"RdYlBu")
heatmap.2(as.matrix(CvT.chems.stats.heatmap[,
  4:dim(CvT.chems.stats.heatmap)[2]]),
  lwid=c(0.4,1),
  lhei=c(0.4,1),
  margins=c(10,1),
  labRow = FALSE,
  cexCol=1,
  trace="none",
  col=mypalette)
#par(mar=c(12,4,4,2)+0.1,cex.main=3) 
png(paste("figs/SupFig-Chem-stats-heatmap-",
           output.prefix,
           ".tiff",sep=""),
, width=800*3, height=750*3)
heatmap.2(as.matrix(CvT.chems.stats.heatmap[,
  4:dim(CvT.chems.stats.heatmap)[2]]),
#  lwid=c(0.4,1),
#  lhei=c(0.4,1),
#  margins=c(10,1),
  labRow = FALSE, scale="row",
  cexRow=3,cexCol=3,
  keysize=0.75,
  margins=c(30,8),trace="none",srtCol=45,
  col=mypalette,
key.title="",
key.par=list(cex=2))
dev.off()
```

```{r make_level2_plot_stats, eval = FALSE}


#### add AAFE & RMSLE to the table
texty <- 20
xshift <- 0.3
fontsize <- 12
FigLev2 <- ggplot(data=subset(level2tab,
                              regexpr("Caco2",QSPR)==-1), 
                  aes(x=QSPR, y=RPE)) + 
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-1,21))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Relative Error for In Vivo CvT Data"))+
  theme_bw()+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=fontsize),
  axis.title.y=element_text(size=12))

  annotation_custom(tableGrob(c("AAFE","RMSLE"), theme = ttheme_minimal(base_size = 12)),
                    xmin=0,xmax=1.2+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"In Vivo Fits"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=2.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTPBTK-ADMET"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=4.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTPBTK-Dawson"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=6.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTPBTK-In Vitro"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=8.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTPBTK-OPERA"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=10.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTPBTK-Pradeep"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=12.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE","RMSLE"),"HTPBTK-YRandom"],
    rows=NULL, theme = ttheme_minimal(base_size = fontsize)),
    xmin=0,xmax=14.3+xshift,ymin=(texty-1),ymax=texty)


print(FigLev2) 
#ggsave(paste("figs/FigLev2_boxplot_trunc_PradeepNEW",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
ggsave(paste("figs/SupFigLev2_boxplot_trunc",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
```

```{r make_level2_plot_stats_early, eval = FALSE}
#### add AAFE & RMSLE to the table
texty <- 1
xshift <- 0.1
FigLev2 <- ggplot(data=subset(level2tab.early,
                              regexpr("Caco2",QSPR)==-1),
                  aes(x=QSPR, y=RPE)) + 
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-1,2))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Relative Error for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(tableGrob(c("AAFE","RMSLE"), theme = ttheme_minimal(base_size = 12)),
                    xmin=0,xmax=1.2+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"FitsToData"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=2.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTPBTK-ADMET"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=4.3+xshift,ymin=(texty-1),ymax=texty) +
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTPBTK-Dawson"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=6.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTPBTK-InVitro"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=8.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTPBTK-OPERA"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=10.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTPBTK-Pradeep"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=12.3+xshift,ymin=(texty-1),ymax=texty)+
  annotation_custom(
    tableGrob(stats.table[c("AAFE.early","RMSLE.early"),"HTPBTK-YRandom"],
    rows=NULL, theme = ttheme_minimal(base_size = 14)),
    xmin=0,xmax=14.3+xshift,ymin=(texty-1),ymax=texty)+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=12))
print(FigLev2) 
#ggsave(paste("figs/FigLev2_boxplot_trunc_PradeepNEW",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
ggsave(paste("figs/SupFigLev2_boxplot_trunc",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
```

```{r make_level2_plot_stats_late, eval = FALSE}
#### add AAFE & RMSLE to the table
texty <- 1
xshift <- 0.1
FigLev2 <- ggplot(data=subset(level2tab.late,
                              regexpr("Caco2",QSPR)==-1),
                  aes(x=QSPR, y=RPE)) + 
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
  #  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
#  scale_y_log10(label=scientific_10,limits=c(10^-2,10^4))+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-1,2))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Relative Error for In Vivo CvT Data"))+
   theme_bw()+
  annotation_custom(
    tableGrob(stat.labels, theme = ttheme_minimal(base_size = 8)),
    xmin=0,xmax=1.4+xshift,ymin=(texty-1),ymax=texty)+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=12))

for (i in 1:length(qsprs.order))
{
  FigLev2 <- FigLev2  + annotation_custom(
    tableGrob(strsplit(earlylate.stats.table[
      these.stats,qsprs.order[i]]
      ," ")[[1]][1],
      rows=NULL, 
      theme = ttheme_minimal(base_size = 10)),
    xmin=0,xmax=(2*i)+0.3+xshift,
    ymin=(texty-1),ymax=texty)
}

print(FigLev2) 
#ggsave(paste("figs/FigLev2_boxplot_trunc_PradeepNEW",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
ggsave(paste("figs/SupFigLev2_boxplot_trunc",output.prefix,".tiff",sep=""), width=4, height=3, dpi=300)
```

```{r make_level2_auc_plot, eval = FALSE}
FigLev2.auc <- ggplot(data=subset(level2tab.stats,
                              regexpr("Caco2",QSPR)==-1),, 
                      aes(x=QSPR, y=AUC.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab("RPE for In Vivo CvTdb AUC")+
  scale_y_continuous(limits=c(-1.5,3)) +
#  scale_y_log10(limits=c(10^-1,10),breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
print(FigLev2.auc)  
```

# Standardize Plotting
```{r set_order_shapes}
level2tab.stats$QSPR <- factor(level2tab.stats$QSPR, levels=c("HTPBTK-InVitro",
                                                  "HTPBTK-ADMET",
                                                  "HTPBTK-Dawson", 
                                                  "HTPBTK-OPERA", 
                                                  "HTPBTK-Pradeep",
                                                  "HTPBTK-Ensemble",
                                                  "HTPBTK-YRandom",
                                                  "In Vivo Fits"))
ggshapes <- c(21, 21, 22, 23, 24, 22, 23, 24, 25)
ggcolors <- c("black", "red", "orange", "green", "blue", "chartreuse4", "coral", "darkorange4")
ggfill <- c("white","red","orange","green","blue", "white","white","white","white")
```


```{r make_level2_auc_plot, eval = TRUE}
FigLev2AUC_facet <- ggplot(data=subset(level2tab.stats,
                              regexpr("Caco2",QSPR)==-1)) +
  geom_point(size=2,
             alpha=0.25,
             aes(x=AUC.pred,y=AUC.obs,
                 shape=QSPR,
                 fill=QSPR,
                 color=QSPR))+
  scale_shape_manual(values=ggshapes)+
  scale_fill_manual(values=ggfill)+
  scale_color_manual(values=ggcolors)+
  scale_x_log10(breaks=c(10^-5,10^-2,10),
                label=scientific_10,
                limits=c(10^-7,3000)) +
  scale_y_log10(breaks=c(10^-1,1,10,10^2),
                label=scientific_10,
                limits = c(30^-1, 300))+
  geom_abline(intercept = 0, 
              slope = 1,linetype="solid", 
              colour="black",
              size=0.2) +
  geom_abline(intercept = 1, 
              slope = 1,
              linetype="dashed", 
              colour="gray66",
              size=0.3) +
  geom_abline(intercept = -1, 
              slope = 1,
              linetype="dashed", 
              colour="gray66",
              size=0.3) +
  xlab('Predicted AUC (mg/L*h)') +
  ylab('Observed AUC (mg/L*h)') +
  theme_bw()+
  facet_wrap(~QSPR)+
 # scale_shape_manual(values = 0:10)+
  theme( text  = element_text(size=20),
         legend.position = "none",
         strip.text.x = element_text(size = 8),
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=10))

print(FigLev2AUC_facet)
ggsave(paste("figs/SupFigLev2_AUCScatter",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
print(AUC.stats.table)
write.csv(AUC.stats.table, 
          file="tables/SupTable-AUCStats.txt")
```

```{r make_level2_auc_plot, eval = FALSE}
FigLev2.auc <- ggplot(data=subset(level2tab.stats,
                              regexpr("Caco2",QSPR)==-1),
                      aes(x=QSPR, y=AUC.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab("RPE for In Vivo CvTdb AUC")+
  scale_y_continuous(limits=c(-1.5,3)) +
#  scale_y_log10(limits=c(10^-1,10),breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
print(FigLev2.auc)  
ggsave(paste("figs/SupFigLev2-AUC-RPE",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r make_level2_cmax_plot, eval = FALSE}
FigLev2.cmax <- ggplot(data=subset(level2tab.stats,
                              regexpr("Caco2",QSPR)==-1),
                       aes(x=QSPR, y=Cmax.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab("RPE for In Vivo CvTdb Cmax")+
  scale_y_continuous(limits=c(-1.5,3)) +
 # scale_y_log10(breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))
print(FigLev2.cmax)  
ggsave(paste("figs/SupFigLev2_CmaxRPE",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)

```

```{r make_level2_plot, eval = FALSE}
FigLev2 <- ggplot(data=subset(level2tab,
                              regexpr("Caco2",QSPR)==-1),
                  aes(x=QSPR, y=RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab("RPE for In Vivo CvT Data")+
 # scale_y_continuous(limits=c(-10,40)) +
 # scale_y_log10(limits=c(10-2,100),breaks=c(10^-1,1,3,10),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5))+
  theme(axis.title.y = element_text(size=18))
print(FigLev2)  
ggsave(paste("figs/SupFigLev2_CvTRPE",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r make_level2_cmax_plot, eval = TRUE}
FigLev2Cmax_facet <- ggplot(data=subset(level2tab.stats,
                              regexpr("Caco2",QSPR)==-1)) +
  geom_point(size=2,
             alpha=0.25,
             aes(x=Cmax.pred,y=Cmax.obs,                 
                 shape=QSPR,
                 fill=QSPR,
                 color=QSPR))+
  scale_shape_manual(values=ggshapes)+
  scale_fill_manual(values=ggfill)+
  scale_color_manual(values=ggcolors)+
  scale_x_log10(breaks=c(10^-5,10^-2,10^1),
                label=scientific_10,
                limits=c(10^-7,3000)) +
   scale_y_log10(breaks=c(10^-1,1,10,10^2),
                label=scientific_10,
                limits = c(30^-1, 300))+
  geom_abline(intercept = 0, 
              slope = 1,
              linetype="solid", 
              colour="black",
              size=0.2) +
  geom_abline(intercept = 1, slope = 1,
              linetype="dashed", 
              colour="gray66",
              size=0.3) +
  geom_abline(intercept = -1, slope = 1,
              linetype="dashed", 
              colour="gray66",
              size=0.3) +
  xlab(bquote('Predicted'~C[max]~'(mg/L)')) +
  ylab(bquote('Observed'~C[max]~'(mg/L)')) +
 # scale_shape_manual(values = 0:10)+
  theme_bw()+
  facet_wrap(~QSPR)+
  theme( text  = element_text(size=20),
         legend.position = "none",
         strip.text.x = element_text(size = 8),
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=10))

print(FigLev2Cmax_facet)
ggsave(paste("figs/SupFigLev2_CmaxScatter",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)

print(Cmax.stats.table)
write.csv(Cmax.stats.table,file="tables/SupTable-CmaxStats.txt")
```


```{r set_qspr_plot_order, eval=TRUE}
#### Set order from left to right:
qsprs.rmsle.bychem <- NULL
# just the chemicals with in vitro data:
#invitro.chems <- subset(qsprbychem.table, QSPR=="HTPBTK-InVitro")$DTXSID
#qsprbychem.table2 <- subset(qsprbychem.table, DTXSID %in% invitro.chems)
qsprbychem.table2 <- qsprbychem.table
for (this.qspr in unique(qsprbychem.table2$QSPR)) 
  qsprs.rmsle.bychem[this.qspr] <-
    mean(subset(qsprbychem.table2,QSPR==this.qspr)$RMSLE) 

qsprs.order <- names(sort(qsprs.rmsle.bychem))
firstpreds <- c("In Vivo Fits", "HTPBTK-InVitro", "HTPBTK-Ensemble")
qsprs.order <- c(firstpreds, qsprs.order[!(qsprs.order %in% firstpreds)])
qsprbychem.table$QSPR <- factor(qsprbychem.table$QSPR,
                                   levels = qsprs.order)
qsprbychem.table2$QSPR <- factor(qsprbychem.table2$QSPR,
                                   levels = qsprs.order)  
```

```{r make_RMSE_bychem_plot, eval = TRUE}
#### add AAFE & RMSLE for all points (not per chemical) to the table
texty <- 2
xshift <- -0.1
these.stats <- "Maximal RMSLE"
stat.labels <- "Mean"

     
#### Make Plot
FigLev2RMSE <- ggplot(data=qsprbychem.table2, aes(x=QSPR, y=RMSLE)) + 
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
  coord_cartesian(ylim=c(-0.1,1.75))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Chemical-Specific RMSLE for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(
    tableGrob(stat.labels, theme = ttheme_minimal(base_size = 8)),
    xmin=0,xmax=1.4+xshift,ymin=(texty-1),ymax=texty)+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=10))

for (i in 1:length(qsprs.order))
{
  FigLev2RMSE <- FigLev2RMSE  + annotation_custom(
    tableGrob(strsplit(rmsle.stats.table[
      these.stats,qsprs.order[i]]
      ," ")[[1]][1],
      rows=NULL, 
      theme = ttheme_minimal(base_size = 10)),
    xmin=0,xmax=(2*i)+0.3+xshift,
    ymin=(texty-1),ymax=texty)
}

print(FigLev2RMSE) 
ggsave(paste("figs/SupFigLev2_RMSEbyChem",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r make_RMSE_bychem_early_plot, eval = TRUE}
texty <- 2
xshift <- -0.1
these.stats <- "Maximal Early"
stat.labels <- "Mean"

#### Make Plot
FigLev2RMSE.early <- ggplot(data=qsprbychem.table2, aes(x=QSPR, y=RMSLE.early)) +
   ggtitle("Early Time Points")+
    geom_hline(yintercept=0,linetype = "dashed",color="blue")+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
  coord_cartesian(ylim=c(-0.1,1.75))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Chemical-Specific RMSLE for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(
    tableGrob(stat.labels, theme = ttheme_minimal(base_size = 8)),
    xmin=0,xmax=1.4+xshift,ymin=(texty-1),ymax=texty)+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=10))

for (i in 1:length(qsprs.order))
{
  FigLev2RMSE.early <- FigLev2RMSE.early  + annotation_custom(
    tableGrob(strsplit(earlylate.stats.table[
      these.stats,qsprs.order[i]]
      ," ")[[1]][1],
      rows=NULL, 
      theme = ttheme_minimal(base_size = 10)),
    xmin=0,xmax=(2*i)+0.3+xshift,
    ymin=(texty-1),ymax=texty)
}

print(FigLev2RMSE.early)
ggsave(paste("figs/SupFigLev2_RMSEbyChemEarly",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```
```{r make_RMSE_bychem_late_plot, eval = TRUE}
texty <- 2.8
xshift <- -0.1
these.stats <- "Maximal Late"
stat.labels <- "Mean"

#### Make Plot
FigLev2RMSE.late <- ggplot(data=qsprbychem.table2, aes(x=QSPR, y=RMSLE.late)) +
   ggtitle("Late Time Points")+
    geom_hline(yintercept=0, linetype = "dashed", color="blue")+
  geom_boxplot(lwd=0.3,
               outlier.shape = NA)+
 # Pradeep NEW coord_cartesian(ylim=c(-30,210))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
  coord_cartesian(ylim=c(-0.1,2.5))+ ### !!!!!!! "coord" does NOT alter the data if data points are removed. "scale" does
    xlab("QSPR") +
  ylab(bquote("Chemical-Specific RMSLE for In Vivo CvT Data"))+
  theme_bw()+
  annotation_custom(
    tableGrob(stat.labels, theme = ttheme_minimal(base_size = 8)),
    xmin=0,xmax=1.4+xshift,ymin=(texty-1),ymax=texty)+
  theme( text  = element_text(size=20),
  legend.key.height=unit(.5,"line"),
  legend.text=element_text(size=14),
  legend.title = element_text(size=14),
  axis.text.x = element_text(angle = 45, vjust = 0.5, size=14),
  axis.title.y=element_text(size=10))

for (i in 1:length(qsprs.order))
{
  FigLev2RMSE.late <- FigLev2RMSE.late + annotation_custom(
    tableGrob(strsplit(earlylate.stats.table[
      these.stats,qsprs.order[i]]
      ," ")[[1]][1],
      rows=NULL, 
      theme = ttheme_minimal(base_size = 10)),
    xmin=0,xmax=(2*i)+0.3+xshift,
    ymin=(texty-1),ymax=texty)
}

print(FigLev2RMSE.late) 
ggsave(paste("figs/SupFigLev2_RMSEbyChemLAte",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```

```{r RMSE_combined_plot}
tiff(file=paste("figs/Fig8-Lev2_RMSEbyChem_all",output.prefix,".tiff",sep=""), 
     width=1200*0.5, height=1600*0.5)
egg::ggarrange(FigLev2RMSE + 
               theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank(),
                     axis.title.x = element_blank(),
                     axis.title.y = element_blank()), 
          FigLev2RMSE.early + 
               theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank(),
                     axis.title.x = element_blank()), 
          FigLev2RMSE.late +
              theme(axis.title.y = element_blank()),
          nrow = 3)
dev.off()
# remove axis labels from plots
egg::ggarrange(FigLev2RMSE+ 
               theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank(),
                     axis.title.x = element_blank() ), 
          FigLev2RMSE.early + 
               theme(axis.text.x = element_blank(),
                     axis.ticks.x = element_blank(),
                     axis.title.x = element_blank() ), 
          FigLev2RMSE.late,
          nrow = 3)
```



Need to do invivo vs invitro/insilco plots for AUC & Cmax
Need heatmap of RMSE x chemical, can add phys-chem
```{r analyze_admet, eval = TRUE}
qsprbychem.table3 <- dcast(qsprbychem.table,
                           Compound~QSPR,
                           value.var="RMSLE")
chems <- qsprbychem.table3$Compound
qsprbychem.table3 <- apply(qsprbychem.table3[,2:dim(qsprbychem.table3)[2]],
                           2,
                           function(x) signif(as.numeric(x),3))
rownames(qsprbychem.table3) <- chems
#colnames(qsprbychem.table2) <- c("FitsToData","ADMET","Dawson","InVitro","OPERA","Pradeep","Y-Random")
write.table(signif(qsprbychem.table3,3),
            sep="\t",
          file=paste("tables/SupTable",
          PREV.SUP.TABLES + 1,
          "-RMSLEbyChem.txt",sep=""))
kable(qsprbychem.table3)
```

```{r make_rmse_heatmap, eval = TRUE}
  mypalette<-brewer.pal(9,"PuRd")
  heatmap.2(t(subset(qsprbychem.table3,
                     apply(qsprbychem.table3,1,function(x)
                       !all(is.na(x[2:length(x)]))))),
 #   lwid=c(0.3,1),
#    lhei=c(0.3,1),
    margins=c(10,8),
#    labRow = FALSE,
    cexCol=0.5,
    cexRow=1.0,
    trace="none",
    col=mypalette)
tiff(paste("figs/Fig7-RMSE-heatmap-",
           output.prefix,
           ".tiff",sep=""),
, width=800*3, height=750*2)
heatmap.2(t(subset(qsprbychem.table3,
                     apply(qsprbychem.table3,1,function(x)
                       !all(is.na(x[2:length(x)]))))),
#  lwid=c(0.4,1),
#  lhei=c(0.4,1),
#  margins=c(10,1),
  scale="row",
  cexRow=3,cexCol=2,
  keysize=0.75,
  margins=c(30,30),trace="none",srtCol=45,
  col=mypalette,
key.title="",
key.par=list(cex=2))
dev.off()  
```

# Attempt to reasonably show all the predictions vs. the observations:
```{r make_pred_vs_obs_plots, eval = TRUE}
# Set the order in which the QSPRs appear:
level2tab$QSPR <- factor(level2tab$QSPR, levels=c("HTPBTK-InVitro",
                                                  "HTPBTK-ADMET",
                                                  "HTPBTK-Dawson", 
                                                  "HTPBTK-OPERA", 
                                                  "HTPBTK-Pradeep",
                                                  "HTPBTK-Ensemble",
                                                  "HTPBTK-YRandom",
                                                  "In Vivo Fits"))
FigLev2 <- ggplot(data = level2tab) +
  geom_point(size = .75,
             alpha = 0.05,
             aes(x = Conc.pred,
                 y = Conc.obs,
                 shape = QSPR,
                 fill = QSPR,
                 color = QSPR)) +
  scale_shape_manual(values = ggshapes)+
  scale_fill_manual(values = ggfill)+
  scale_color_manual(values = ggcolors)+
  scale_x_log10(breaks=10^seq(-5,4,by=2),
                label=scientific_10) +
  scale_y_log10(breaks=10^seq(-5,4,by=2),
                label=scientific_10)+
  geom_abline(intercept = 0, 
              slope = 1,
              linetype="solid", 
              colour="black",
              size=0.3) +
  geom_abline(intercept = 1, 
              slope = 1,
              linetype="dashed", 
              colour="gray22",
              size=0.3) +
  geom_abline(intercept = -1, 
              slope = 1,
              linetype="dashed", 
              colour="gray22",
              size=0.3) +
  xlab(bquote('Predicted Concentration (mg/L)')) +
  ylab(expression(paste("Observed Concentration ",
                        italic("In Vivo"),
                        " (mg/L)"))) +
  facet_wrap(~QSPR)+
  guides(colour = guide_legend(override.aes = list(alpha = 1)))+
  theme_bw()+
  theme(strip.text = element_text(size=12),
        text  = element_text(size=16),
        legend.position = "none",
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10))
print(FigLev2)
ggsave(paste("figs/Fig6-Lev2_Conc_scatter",output.prefix,".tiff",sep=""), 
       width=6, 
       height=6, 
       dpi=300)
```

#Are the Dawson chemicals where RMSLE early < httk early truly different from RMSLE late < httk late?
```{r text_observations}
dawson.chems <- subset(qsprbychem.table, QSPR =="HTPBTK-Dawson")$RMSLE < 
  subset(qsprbychem.table, QSPR == "HTPBTK-InVitro")$RMSLE
dawson.chems <- dawson.chems[!is.na(dawson.chems)]
dawson.early.chems <- subset(qsprbychem.table, QSPR =="HTPBTK-Dawson")$RMSLE.early < 
  subset(qsprbychem.table, QSPR == "HTPBTK-InVitro")$RMSLE.early
dawson.early.chems <- dawson.early.chems[!is.na(dawson.early.chems)]
dawson.late.chems <- subset(qsprbychem.table, QSPR =="HTPBTK-Dawson")$RMSLE.late < 
  subset(qsprbychem.table, QSPR == "HTPBTK-InVitro")$RMSLE.late
dawson.late.chems <- dawson.late.chems[!is.na(dawson.late.chems)]

sum(dawson.chems)
sum(dawson.early.chems)
sum(dawson.late.chems)
sum(dawson.late.chems & dawson.early.chems)
```
```{r chemicals_with_bad_fits}
kable(subset(qsprbychem.table3, qsprbychem.table3[,"In Vivo Fits"]>1.5))
```
