---
title: "TKQSPRs-8-FinalFigure"
author: "Gilberto Padilla Mercado"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r packages}
library(httk)
library(ggplot2)
library(magrittr)
library(scales)
```
Load custom code 
```{r load_code, eval = TRUE}
source("tkstats.R")
```


## Purpose

The goal of this final panel is to visualize and explore the concordance of 
rat and human TK parameters. In panel A I will look at fraction unbound in plasma,
panel B will explore intrinsic clearance. Because some of these chemicals have
multiple values associated with fraction unbound or intrinsic clearance, I
take the median values in those cases. I use median values instead of average
because it represents a real measured value and a central tendency statistic.

```{r Fup_analysis, eval=TRUE}
reset_httk()
common_chems <- intersect(
  get_cheminfo(model = "pbtk", species = "human", info = "DTXSID"),
  get_cheminfo(model = "pbtk", species = "rat", info = "DTXSID")
  )

length(common_chems)

chem_properties <- subset(chem.physical_and_invitro.data,
                   DTXSID %in% common_chems)

# For each DTXSID, there may be multiple values for 

chem_properties$Human.Funbound.plasma <- lapply(
  strsplit(chem_properties$Human.Funbound.plasma,
           ","), as.numeric)
chem_properties$Rat.Funbound.plasma <- lapply(
  strsplit(chem_properties$Rat.Funbound.plasma,
           ","), as.numeric)
chem_properties$Human.Clint <- lapply(
  strsplit(chem_properties$Human.Clint,
           ","), as.numeric)
chem_properties$Rat.Clint <- lapply(
  strsplit(chem_properties$Rat.Clint,
           ","), as.numeric)

chem_prop_long <- merge(tidyr::unnest(
  chem_properties[c("DTXSID", "Human.Funbound.plasma")],
  cols = c(Human.Funbound.plasma)),
  tidyr::unnest(
    chem_properties[c("DTXSID", "Rat.Funbound.plasma")],
    cols = c(Rat.Funbound.plasma)))




chem_prop_long %>% ggplot(aes(x = Human.Funbound.plasma,
                          y = Rat.Funbound.plasma)) +
  geom_point()


chem_prop_long %>%
  dplyr::group_by(DTXSID) %>%
  dplyr::summarize(hfup = median(Human.Funbound.plasma),
                   rfup = median(Rat.Funbound.plasma)) -> tidy_summary

tidy_summary %>%
  dplyr::mutate(SE = (hfup - rfup)^2) %>% 
  dplyr::ungroup() %>% dplyr::pull(SE) %>%
  {sqrt(sum(.)/length(.))} -> fup_rmse
```

```{r make_fupplot}
plotA <- ggplot(tidy_summary,
                aes(x = hfup, y = rfup)) +
  geom_point() +
  geom_abline() +
  annotate(label = paste0("RMSE = ", signif(fup_rmse, 3)),
           geom = "text",
           x = 5*10^-3, y = 0.85,
    size = 6
  ) +
  ylab(expression(paste("Rat ",
                        f[up]))) +
  xlab(expression(paste("Human ",
                        f[up]))) +
  scale_x_log10(label=scientific_10,limits=c(5*10^-4,1)) +
  scale_y_log10(label=scientific_10,limits=c(5*10^-4,1)) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))

plotA
```

```{r clint_analysis}

# Do the same thing with Clint
chem_prop_long <- merge(tidyr::unnest(chem_properties[c("DTXSID", "Human.Clint")],
                                  cols = c(Human.Clint)),
                    tidyr::unnest(chem_properties[c("DTXSID", "Rat.Clint")],
                                  cols = c(Rat.Clint)))




chem_prop_long %>% ggplot(aes(x = log10(1+Human.Clint),
                          y = log10(1+Rat.Clint))) +
  geom_point()


chem_prop_long %>%
  dplyr::group_by(DTXSID) %>%
  dplyr::summarize(hclint = median(Human.Clint),
                   rclint = median(Rat.Clint)) -> tidy_summary

tidy_summary %>%
  dplyr::mutate(SLE = (log10(1+hclint) - log10(1+rclint))^2) %>% 
  dplyr::ungroup() %>% dplyr::pull(SLE) %>%
  {sqrt(sum(.)/length(.))} -> clint_rmsle
```

```{r make_panelb}
plotB <- ggplot(tidy_summary, 
                aes(x = 10^-3 + hclint, y = 10^-3 + rclint)) +
  geom_point() +
  geom_abline() +
  annotate(label = paste0("RMSLE = ", signif(clint_rmsle, 3)),
           geom = "text",
           x = 50*1e-3, y = 1000,
    size = 6
  ) +
  ylab(expression(paste("Rat ",
                        Cl[int],
                        " (",
                        mu,
                        "L/min/10"^6,
                        " hep.)"))) +
  xlab(expression(paste("Human ",
                        Cl[int],
                        " (",
                        mu,
                        "L/min/10"^6,
                        " hep.)"))) +
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))

plotB
```
```{r make_twopanelplot}
# This is the combined plot for the top panels
# Note that this requires the package cowplot
# require(cowplot)
cowplot::plot_grid(plotlist = list(plotA, plotB), labels = c("A", "B"))

```

Next we want to test the differences in Css and Cmax when we substitute human
in vitro values for Clint and Fup.

```{r human_measurements, eval=TRUE}
rat_df <- data.frame(DTXSID = common_chems) 
rat_df <- subset(rat_df, DTXSID %in% get_cheminfo(info="dtxsid", model="pbtk"))

rat_df <- rat_df %>%
  dplyr::rowwise() %>%
  dplyr::mutate(Rat_Css = suppressWarnings(
    calc_analytic_css(dtxsid = DTXSID,
                      model = "pbtk", suppress.messages = TRUE,
                      species = "rat")),
    Rat_Cmax = suppressWarnings(
      calc_tkstats(dtxsid = DTXSID, 
                   model = "pbtk", suppress.messages = TRUE,
                 species = "rat")[["peak"]]))


chem.physical_and_invitro.data <- chem.physical_and_invitro.data %>%
  dplyr::mutate(Rat.Clint = NA, Rat.Funbound.plasma = NA)
# Run reset_httk() if I've run this and I need to go back to the original data

rat_df <- subset(rat_df, DTXSID %in% get_cheminfo(info="dtxsid", model="pbtk"))
rat_df <- rat_df %>%
  dplyr::rowwise() %>%
  dplyr::mutate(RatHum_Css = try(suppressWarnings(
    calc_analytic_css(dtxsid = DTXSID,
                      model = "pbtk", suppress.messages = TRUE,
                      species = "rat",
                      parameterize.args = list(default.to.human = TRUE)))),
    RatHum_Cmax = try(suppressWarnings(
      calc_tkstats(dtxsid = DTXSID, 
                   model = "pbtk", suppress.messages = TRUE,
                 species = "rat",
                 default.to.human = TRUE)[["peak"]])))


rat_df %>%
  dplyr::mutate(SLE = (log10(1 + Rat_Css) - log10(1 + RatHum_Css)) ^ 2) %>%
  dplyr::ungroup() %>% dplyr::pull(SLE) %>%
  {
    sqrt(sum(.) / length(.))
  } -> css_rmsle

```

```{r make_panelc}
plotC <- ggplot(rat_df, aes(y = 10^-3 + Rat_Css, x = 10^-3 + RatHum_Css)) +
  geom_point() +
  geom_abline() +
  annotate(
    label = paste0("RMSLE = ", signif(css_rmsle, 3)),
    geom = "text",
    x = 50*1e-3,
    y = 10,
    size = 6
  ) +
  ylab(expression(paste("Rat ",C[ss]," (mg/L)"))) +
  xlab(expression(paste("Rat ",
                        C[ss],
                        " (mg/L) from Human "))) +
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))

plotC
```

```{r make_paneld}
rat_df %>%
  dplyr::mutate(SLE = (log10(1 + Rat_Cmax) - log10(1 + RatHum_Cmax)) ^ 2) %>%
  dplyr::ungroup() %>% dplyr::pull(SLE) %>%
  {
    sqrt(sum(.) / length(.))
  } -> cmax_rmsle

plotD <- ggplot(rat_df, aes(y = 10^-3 + Rat_Cmax, x = 10^-3 + RatHum_Cmax)) +
  geom_point() +
  geom_abline() +
  annotate(
    label = paste0("RMSLE = ", signif(cmax_rmsle, 3)),
    geom = "text",
    x = 50*1e-3,
    y = 10,
    size = 6
  ) +
  ylab(expression(paste("Rat ",C[max]," (mg/L)"))) +
  xlab(expression(paste("Rat ",
                        C[max],
                        " (mg/L) from Human "))) +
  scale_x_log10(label=scientific_10) +
  scale_y_log10(label=scientific_10) +
  theme_bw() +
   theme( text  = element_text(size=16),
         axis.text.x = element_text(size=10),
         axis.text.y = element_text(size=10))


plotD
```

```{r make_multipanelplot}
cowplot::plot_grid(
  plotlist = list(plotA, plotB, plotC, plotD),
  labels = c("A", "B", "C", "D")
)

ggsave(filename = "figs/Fig9-human_rat_eval.png",
       height = 7,
       width = 7)

```

```{r textforpaper}
paste("There were",
      length(unique(rat_df$DTXSID)),
      "chemicals with in vitro measured fup and Clint for both human and rat. ")
paste("Based upon a separate analysis of",
      length(unique(rat_df$DTXSID)),
      "chemicals with in vitro measured fup and Clint for both human and rat,",
      "we estimate that interspecies differences inflate the RMSLE for Cmax by",
      signif(cmax_rmsle, 2),
      "and for Css by",
      signif(css_rmsle, 2)
      )
```