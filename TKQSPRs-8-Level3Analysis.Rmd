---
title: "HTTK QSPRs: Level 3 Analysis"
author: "John Wambaugh and Nisha Sipes"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QSPR Bakeoff}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir= "C:/Users/jwambaug/git/CompTox-ExpoCast-HTTKQSPRs/")
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

First we clear the memory to make sure there are no holdovers from previous R runs
```{r clear_mermor, eval=TRUE}
rm(list=ls()) 
```

To use the code in this vignette, you'll first need to load a few packages (if you haven't already).
```{r load_packages, eval = TRUE}
library(readxl)
library(ggplot2)
library(scales)
library(knitr)
```

```{r load_data, eval= TRUE}
load("data/level3-tables.RData")
load("data/level2stats.RData")
load("data/httk-goodchems.RData")
load("data/chemicallists.RData")
  # Can't work with NA's:
  level3tab <- level3tab[!names(level3tab) %in% c("HTPBTK-InVitro-AltClear","HTPBTK-InVitro-Rat")]
```


Load custom code 
```{r load_code, eval = TRUE}
source("tkstats.R")
```

# Keep table numbering straight:
```{r load_code, eval = TRUE}
PREV.TABLES <- 8
PREV.SUP.TABLES <- 12
```

Set the time stamp:
```{r time_stamp, eval = TRUE}
# Time stamp:
output.prefix <- "May2025"
```

#Level III Predictions -- predicted half-life or volume of distribution (Vd)
# vs. estimates from CvT data (invivoPKfit)
# 
# Jon Arnot provide two models that directly predicted half-life. All the other
# QSPR values were used with HTTK to predict half-life and Vd. 
#
# As with level II, we can only compare the HTTK+in vitro measured preditions
# for a subset of the chemicals and to date I have lumped everything together.
# 
# Further complicating things, not every chemical in the evaluation set 
# permitted estimation
# of Vd and thalf. The optimizer had to be able to fine a maximimum likelihood
# estimate and it fails some of the time. The estimates we are using were made
# with invivoPKfit and published in Sayre et al. (2020)

## Collect the Concentration vs. time (level 2) predictions from each model:
```{r level3_onering, eval = TRUE}
longtab <- NULL
for (this.qspr in names(level3tab))
{
  longtab <- rbind(longtab, level3tab[[this.qspr]])
}
level3tab.old <- level3tab
level3tab <- longtab 
```

```{r remove_duplicates}
dim(level3tab)
level3tab <- subset(level3tab, !duplicated(level3tab))
dim(level3tab)
```
```{r level3_load_arnot, eval = TRUE}
level3.arnot <- read_excel("qsprs/TK_QSAR_evaluation_set_HumanQSARHLPredictions.xlsx")
level3.arnot <- subset(level3.arnot,administration_route_normalized=="iv")
level3tab.arnot1 <- level3tab.old[["HTPBTK-OPERA"]]
level3tab.arnot1$Vd.pred <- NA
level3tab.arnot1$thalf.pred <- NA
level3tab.arnot1$cl.pred <- NA
level3tab.arnot2 <- level3tab.arnot1
level3tab.arnot1$QSPR <- "Papa 2018"
level3tab.arnot2$QSPR <- "IFS-QSAR"

for (this.dtxsid in level3.arnot$test_substance_dtxsid)
  if (this.dtxsid %in% level3tab.arnot1$DTXSID)
  {
  level3tab.arnot1[level3tab.arnot1$DTXSID==this.dtxsid,"thalf.pred"] <- 
    as.numeric(level3.arnot[level3.arnot$test_substance_dtxsid==this.dtxsid,
    "QINS_Hum_HLT_Hour"])
  level3tab.arnot2[level3tab.arnot1$DTXSID==this.dtxsid,"thalf.pred"]  <- 
    as.numeric(level3.arnot[level3.arnot$test_substance_dtxsid==this.dtxsid,
    "IFS_Hum_HLT_Hour"]) 
  }

level3tab.arnot1[tolower(level3tab.arnot1$Species)=="rat", "thalf.pred"] <-
  signif(level3tab.arnot1[tolower(level3tab.arnot1$Species)=="rat", 
                          "thalf.pred"]*(0.25/70)^(0.75), # allometric scaling by body weight
         3)
level3tab.arnot2[tolower(level3tab.arnot2$Species)=="rat", "thalf.pred"] <-
  signif(level3tab.arnot2[tolower(level3tab.arnot1$Species)=="rat", 
                          "thalf.pred"]*(0.25/70)^(0.75), # allometric scaling by body weight
         3)
# Pull in the ensemble Vd's so we can calculated clearance:
ensemble.results <- level3tab.old[["HTPBTK-Ensemble"]]
for (this.chem in level3tab.arnot1$DTXSID)
  if (this.chem %in% ensemble.results$DTXSID)
{
  level3tab.arnot1[level3tab.arnot1$DTXSID==this.chem,"Vd.pred"] <- 
    ensemble.results[ensemble.results$DTXSID==this.chem,"Vd.pred"]
}
for (this.chem in level3tab.arnot2$DTXSID)
    if (this.chem %in% ensemble.results$DTXSID)
{
  level3tab.arnot2[level3tab.arnot2$DTXSID==this.chem,"Vd.pred"] <- 
    ensemble.results[ensemble.results$DTXSID==this.chem,"Vd.pred"]
}
# Calculate the clearance using the ensemble Vd
level3tab.arnot1$cl.pred <- signif(level3tab.arnot1$Vd.pred * log(2) / 
                                     level3tab.arnot1$thalf.pred,
                                   3)
level3tab.arnot2$cl.pred <- signif(level3tab.arnot2$Vd.pred * log(2) / 
                                     level3tab.arnot2$thalf.pred,
                                   3)
level3tab <- rbind(level3tab, level3tab.arnot1, level3tab.arnot2)
```

```{r prep_level3, eval = TRUE}
level3tab$thalf.RPE <- 
  (level3tab$thalf.pred - level3tab$thalf.obs)/level3tab$thalf.obs
level3tab$Vd.RPE <- (level3tab$Vd.pred - level3tab$Vd.obs)/level3tab$Vd.obs

level3tab$Cl.obs <- level3tab$Vd.obs * log(2) / level3tab$thalf.obs
level3tab$Cl.pred <- level3tab$Vd.pred * log(2) / level3tab$thalf.pred
level3tab$Cl.RPE <- (level3tab$Cl.pred - level3tab$Cl.obs)/level3tab$Cl.obs
```

```{r auccmax_table, eval=TRUE}
AUCCmax.table <- rbind(Cmax.stats.table["RMSLE Maximal",],
                       Cmax.stats.table["RMSLE Pharma",],
                       Cmax.stats.table["RMSLE Non-Pharma",],
                       AUC.stats.table["RMSLE Maximal",],
                       AUC.stats.table["RMSLE Pharma",],
                       AUC.stats.table["RMSLE Non-Pharma",])
rownames(AUCCmax.table) <- c("Cmax RMSLE",
                             "Cmax RMSLE (Pharma)",
                             "Cmax RMSLE (Non-Pharma)",
                             "AUC RMSLE",
                             "AUC RMSLE (Pharma)",
                             "AUC RMSLE (Non-Pharma)")
kable(AUCCmax.table)
write.table(AUCCmax.table,
            sep="\t",
          file=paste("tables/Table",
          PREV.TABLES + 1,
          "-AUCCmax-stats.txt",sep=""))
```
# Get rid of Vd predictions from HTTK not made by QSPR:
```{r remove_placeholder_vd, eval = TRUE}
level3tab[level3tab$QSPR %in% c("Papa 2018", "IFS-QSAR"),"Vd.pred"] <- NA
```

# Standardize Plotting
```{r set_order_shapes}
level3tab$QSPR <- factor(level3tab$QSPR, levels=c("HTPBTK-InVitro",
                                                  "HTPBTK-ADMET",
                                                  "HTPBTK-Dawson", 
                                                  "HTPBTK-OPERA", 
                                                  "HTPBTK-Pradeep",
                                                  "HTPBTK-Ensemble",
                                                  "HTPBTK-YRandom",
                                                  "Papa 2018",
                                                  "IFS-QSAR"))
ggshapes <- c(21, 21, 22, 23, 24, 22, 23, 24, 25)
ggcolors <- c("black", "red", "orange", "green", "blue", "chartreuse4", "coral", "cyan3", "deeppink")
ggfill <- c("white","red","orange","green","blue", "white","white","white","white")
```


```{r halflife_stats, eval = TRUE}
halflife.stats.table <- makestatstable(level3tab,
                                       obs.col="thalf.obs",
                                       pred.col="thalf.pred",
                                       chem.lists=list(
                                         "Maximal" = max.chems
                                         ),
                                       logrsquared = FALSE
                                       )
kable(halflife.stats.table)
write.table(halflife.stats.table,
            sep="\t",
          file="tables/SupTable-halflife-stats.txt")
```

```{r vdist_stats, eval=TRUE}
vd.stats.table <- makestatstable(level3tab,
                                       obs.col="Vd.obs",
                                       pred.col="Vd.pred",
                                       chem.lists=list(
                                          "Maximal" = max.chems
                                         ),
                                       logrsquared = TRUE
                                       )
kable(vd.stats.table)
write.table(vd.stats.table,
            sep="\t",
          file="tables/SupTable-VD-stats.txt")
```

```{r total_clearance_stats, eval=TRUE}
cl.stats.table <- makestatstable(level3tab,
                                       obs.col="Cl.obs",
                                       pred.col="Cl.pred",
                                       chem.lists=list(
                                         "Maximal" = unique(level3tab$DTXSID)
                                         ),
                                       logrsquared = TRUE
                                       )
kable(cl.stats.table)
write.table(cl.stats.table,
            sep="\t",
          file="tables/SupTable-Cl-stats.txt")
```
```{r steadystate_conc_stats, eval=TRUE}
level3tab$Css.obs <- signif(1/level3tab$Cl.obs,4)
level3tab$Css.pred <- signif(1/level3tab$Cl.pred,4)

css.stats.table <- makestatstable(level3tab,
                                       obs.col="Css.obs",
                                       pred.col="Css.pred",
                                       chem.lists=list(
                                         "Maximal" = unique(level3tab$DTXSID)
                                         ),
                                       logrsquared = TRUE
                                       )
kable(css.stats.table)
write.table(css.stats.table,
            sep="\t",
          file="tables/SupTable-Cl-stats.txt")
```

# Compiled Stats Table for main manuscript:
```{r make_manuscritplevel3_table, eval =TRUE}
level3stats.table <- rbind(
  halflife.stats.table[c("RMSLE Maximal"),],
  cl.stats.table[c("RMSLE Maximal"),],
  vd.stats.table[c("RMSLE Maximal"),],
  css.stats.table[c("RMSLE Maximal"),]
  )
rownames(level3stats.table) <- c(
  "Half-Life RMSLE",
 # "Half-Life RMSLE (QSPR Intersection)",
  #  "Half-Life RSquared",
  "Cltot RMSLE",
#  "CLtot RMSLE (QSPR Intersection)",
  #  "CLtot RSquared",
  "Vd RMSLE",
#  "Vd RMSLE (QSPR Intersection)",
  #  "Vd RSquared"
  "Css RMSLE"#,
 # "Css RMSLE (QSPR Intersection)"
  )
level3stats.table<-apply(level3stats.table,c(1,2),function(x) strsplit(x, " ")[[1]][1])
kable(level3stats.table)
save(level3stats.table,
     file=paste("data/Level3StatsTable.RData"))
write.table(level3stats.table,        
            sep="\t",
          file=paste("tables/Table",
          PREV.TABLES+2,
          "-halflifeVdCltot-stats.txt",sep=""))
```

# Half-life scatter plot:
```{r make_level3_halflife_scatter_plot, eval = TRUE}

FigLev3a <- ggplot(data=level3tab) +
  geom_point(size=3,aes(x=thalf.pred,y=thalf.obs,
                        shape=QSPR, 
                        fill=QSPR, 
                        color=QSPR))+
  scale_shape_manual(values=ggshapes)+
  scale_fill_manual(values=ggfill)+
  scale_color_manual(values=ggcolors)+
  scale_x_log10(label=scientific_10)+
  scale_y_log10(label=scientific_10)+
 # scale_shape_manual(values=c(15, 16, 17, 18, 25,0,1,2,5))+
  geom_abline(intercept = log10(10^(1/2)), slope = 1,linetype="dashed", colour="lightBlue") +
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="Grey") + 
  geom_abline(intercept = log10(10^(-1/2)), slope = 1,linetype="dashed", colour="lightBlue") + 
  xlab(bquote('Predicted'~t[half]~"(h)")) +
  ylab(bquote('Observed'~t[half]~"(h)")) +
 # scale_shape_manual(values = 0:10)+
  theme_bw()+
  facet_wrap(~QSPR)+
  theme( text  = element_text(size=20),
         legend.position = "none",
         strip.text.x = element_text(size = 8),
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=10))
print(FigLev3a)
ggsave(paste("figs/SupFigLev3a_thalf_obsVpred_",output.prefix,".tiff",sep=""), width=6, height=8, dpi=300)
```

```{r make_level3_halflife_box_plot, eval = TRUE}
FigLev3b <- ggplot(data=level3tab, aes(x=QSPR, y=thalf.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab(bquote('RPE in '~t[half]~"(h)")) +
  scale_y_continuous(limits=c(-2,6)) +
#  scale_y_log10(breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))   +
  theme(axis.text.x = element_text(angle = 60, vjust = 0.75, hjust=0.75))
print(FigLev3b) 
ggsave(paste("figs/SupFigLev3b_thalf_boxplot_",output.prefix,".tiff",sep=""), width=6, height=4, dpi=300)
```

```{r make_level3_vd_scatter_plot, eval = TRUE}
FigLev3c <- ggplot(data=subset(level3tab,!(QSPR %in% c("IFS-QSAR","Papa 2018")))) +
  geom_point(size=3,aes(x=Vd.pred,y=Vd.obs,                        
                        shape=QSPR, 
                        fill=QSPR, 
                        color=QSPR))+
  scale_shape_manual(values=ggshapes)+
  scale_fill_manual(values=ggfill)+
  scale_color_manual(values=ggcolors)+
  scale_x_log10(label=scientific_10)+
  scale_y_log10(label=scientific_10)+
#  scale_shape_manual(values=c(15, 16, 17, 18, 25,0,1,2,5))+
  geom_abline(intercept = log10(10^(1/2)), slope = 1,linetype="dashed", colour="lightBlue") +
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="Grey") + 
  geom_abline(intercept = log10(10^(-1/2)), slope = 1,linetype="dashed", colour="lightBlue") + 
  xlab(bquote('Predicted'~V[d]~"(L/kg BW)")) +
  ylab(bquote('Observed'~V[d]~"(L/kg BW)")) +
#  scale_shape_manual(values = 0:10)+
  theme_bw()+
  facet_wrap(~QSPR)+
  theme( text  = element_text(size=20),
         legend.position = "none",
         strip.text.x = element_text(size = 10),
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=10))
print(FigLev3c)
ggsave(paste("figs/SupFigLev3c_Vd_obsVpred_",output.prefix,".tiff",sep=""), 
       width=6, height=8, dpi=300)
```

```{r make_level3_vd_box_plot, eval = TRUE}

FigLev3d <- ggplot(data=subset(level3tab,!(QSPR %in% c("IFS-QSAR","QSPRINS"))), 
  aes(x=QSPR, y=Vd.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab(bquote('RPE in '~V[d]~"(L/kg BW)")) +
  scale_y_continuous(limits=c(-1.2,1)) +
#  scale_y_log10(breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=20))+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.75, hjust=0.75))
print(FigLev3d)  
ggsave(paste("figs/SupFigLev3d_Vd_boxplot_",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
```                 

```{r make_level3_cl_scatter_plot, eval = TRUE}
FigLev3e <- ggplot(data=level3tab) +
  geom_point(size=3,aes(x=Cl.pred,y=Cl.obs,
                        shape=QSPR, 
                        fill=QSPR, 
                        color=QSPR))+
  scale_shape_manual(values=ggshapes)+
  scale_fill_manual(values=ggfill)+
  scale_color_manual(values=ggcolors)+
  scale_x_log10(label=scientific_10)+
  scale_y_log10(label=scientific_10)+
 # scale_shape_manual(values=c(15, 16, 17, 18, 25,0,1,2,5))+
  geom_abline(intercept = log10(10^(1/2)), slope = 1,linetype="dashed", colour="lightBlue") +
  geom_abline(intercept = 0, slope = 1,linetype="solid", colour="Grey") + 
  geom_abline(intercept = log10(10^(-1/2)), slope = 1,linetype="dashed", colour="lightBlue") + 
  xlab(bquote('Predicted'~Cl[tot]~"(L/h/kg BW)")) +
  ylab(bquote('Observed'~Cl[tot]~"(L/h/kg BW)")) +
#  scale_shape_manual(values = 0:10)+
  theme_bw()+
  facet_wrap(~QSPR)+
  theme( text  = element_text(size=20),
         legend.position = "none",
         strip.text.x = element_text(size = 8),
         axis.title = element_text(size=20),
         axis.text.x = element_text(size=10))
print(FigLev3e)
ggsave(paste("figs/SupFigLev3e_Cltot_obsVpred_",output.prefix,".tiff",sep=""), 
       width=6, height=8, dpi=300)
```

```{r make_level3_cl_box_plot, eval = TRUE}

FigLev3f <- ggplot(data=level3tab, 
  aes(x=QSPR, y=Vd.RPE)) + 
#  geom_hline(yintercept=1,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=3,linetype = "dashed",color="blue")+
#  geom_hline(yintercept=10,linetype = "dashed",color="blue")+
  geom_boxplot(outlier.colour="red",
    outlier.size=2,
    outlier.alpha=0.1)+
  xlab("QSPR") +
  ylab(bquote('RPE in'~Cl[tot]~"(L/h/kg BW)")) +
  scale_y_continuous(limits=c(-1.2,1)) +
#  scale_y_log10(breaks=c(10^-2,10^-1,1,3,10,10^2,10^3),label=scientific_10)+
  theme_bw()+
  theme( text  = element_text(size=19))+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.75, hjust=0.75))
print(FigLev3f)
ggsave(paste("figs/SupFigLev3f_Cltot_boxplot_",output.prefix,".tiff",sep=""), 
       width=6, height=4, dpi=300)
``` 

```{r make_level3_sup_table, eval=TRUE}
lev3suptable <- level3tab
for (this.col in 1:dim(lev3suptable)[2])
  if (is.numeric(lev3suptable[1,this.col]))
    lev3suptable[,this.col] <- signif(lev3suptable[,this.col],3)
  
write.table(lev3suptable,
            sep="\t",
            row.names=FALSE,
          file=paste("tables/SupTable",
          PREV.SUP.TABLES+1,
          "-Level3.txt",sep=""))

```

